import{_ as s,c as a,o as n,U as l}from"./chunks/framework.BERZi0Za.js";const p="/blog/assets/vite-build-gif1.BWqSAQrc.gif",e="/blog/assets/vite-build-gif2.CSsF_kGo.gif",o="/blog/assets/vite-build-gif3.DGyivtfq.gif",r="/blog/assets/vite-build-gif4.C-2rkyz5.gif",c="/blog/assets/vite-build-gif5.CAJRsuk7.gif",B=JSON.parse('{"title":"webpack 项目迁移 vite 实践","description":"","frontmatter":{},"headers":[],"relativePath":"article/record/webpack-vite.md","filePath":"article/record/webpack-vite.md","lastUpdated":1711765476000}'),t={name:"article/record/webpack-vite.md"},D=l('<h1 id="webpack-项目迁移-vite-实践" tabindex="-1">webpack 项目迁移 vite 实践 <a class="header-anchor" href="#webpack-项目迁移-vite-实践" aria-label="Permalink to &quot;webpack 项目迁移 vite 实践&quot;">​</a></h1><p>最近接触了一个 <code>webpack</code> 项目的开发, 在 <code>TDesign</code> 中的 <code>vite</code> 开发环境还是非常丝滑的。项目的构建工具使用的是 <code>sand-build</code>，一个 <code>webpack</code> 和 <code>roll-up</code> 的集大成者。但是确实在项目上手之初遇到了很烦恼的热更新编译问题。真的太慢了🐢。</p><p><img src="'+p+'" alt="img"></p><p>上图应该可以感受到这种开发时候热更新的绝望了。一次热更新的时间在 <code>25</code> 秒左右。宝贵的时间当然不能用来等热更新了。开发效率极低，甚至都不想写了。</p><h2 id="分析" tabindex="-1">分析 <a class="header-anchor" href="#分析" aria-label="Permalink to &quot;分析&quot;">​</a></h2><p>在这个情况下，肯定要着手解决问题了。首先分析一下为什么这么慢。</p><h3 id="启动阶段" tabindex="-1">启动阶段 <a class="header-anchor" href="#启动阶段" aria-label="Permalink to &quot;启动阶段&quot;">​</a></h3><p><img src="'+e+'" alt="img"></p><p>中间还有两张30秒的图就不放了，下面这张是gif动图，在 <code>webpack</code> 的编译花了很久。</p><p><img src="'+o+`" alt="img"></p><p>实测启动过程 2 分钟，启动过程大致如下：</p><ul><li>创建 <code>monorepo</code> 包的软链接（2s）左右</li><li>打包 <code>packages</code> 下面的每一个子包（100s）左右，其中 <code>ui</code> 库包体积最大，时间最长。</li><li><code>webpack dev server</code> 启动（15s）左右</li></ul><h3 id="热更新阶段" tabindex="-1">热更新阶段 <a class="header-anchor" href="#热更新阶段" aria-label="Permalink to &quot;热更新阶段&quot;">​</a></h3><ul><li><code>rollup</code> 增量打包（5s）左右，视改动文件所属包大小速度不一。如果改动 <code>UI</code> 库则这一步的时间非常长。</li><li><code>webpack</code> 热更新（25s），整个<code>dev server</code>的依赖链路太长。</li></ul><h2 id="解决方案" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案" aria-label="Permalink to &quot;解决方案&quot;">​</a></h2><p>开始着手解决，规划了 <code>vite</code> 和 <code>webpack</code> 主流的两种方案。</p><h3 id="webpack升级" tabindex="-1">webpack升级 <a class="header-anchor" href="#webpack升级" aria-label="Permalink to &quot;webpack升级&quot;">​</a></h3><p>由于 <code>sand-build</code> 底层依赖为 <code>webpack4</code>，如果将依赖升级到 <code>webpack5</code>，将获得一定程度的性能提升。</p><p>优点：</p><ul><li>不需要对现有工程做大幅度的改动，只需要升级底层依赖即可</li><li>不需要考虑相关依赖包的文件类型问题</li></ul><p>缺点：</p><ul><li>webpack 大版本升级后配置项改动幅度可能很大。</li><li>按照这个方式改动对整条链接影响只能优化 <code>webpack</code> 热更新阶段的时间，且效果不明显。</li><li>需要改动底层</li></ul><h3 id="终极解决方案vite" tabindex="-1">终极解决方案vite <a class="header-anchor" href="#终极解决方案vite" aria-label="Permalink to &quot;终极解决方案vite&quot;">​</a></h3><p><code>vite</code> 真香, 大概是每个用过的开发者第一想法，当前最佳的开发体验 <code>vite</code> 可以提供，且生态日渐强大。在 <code>vite</code> 面前，<code>webpack</code> 可能让人感觉是上世纪的产物。</p><p>优点：</p><ul><li>秒启动，极致的开发体验，丝滑</li></ul><p>缺点：</p><ul><li>解决许多未知问题</li><li>依赖包不兼容</li><li>工程大幅改动</li></ul><h3 id="一步到位" tabindex="-1">一步到位 <a class="header-anchor" href="#一步到位" aria-label="Permalink to &quot;一步到位&quot;">​</a></h3><p>本着长期主义，一步到位的原则，选择走 <code>vite</code> 的路线。</p><h2 id="webworker-文件处理" tabindex="-1">webWorker 文件处理 <a class="header-anchor" href="#webworker-文件处理" aria-label="Permalink to &quot;webWorker 文件处理&quot;">​</a></h2><p><code>vite</code> 处理 <code>worker</code> 的格式是 <code>.xxx.ts?worker</code></p><p><code>rollup-plugin-web-worker-loader</code> 处理 <code>worker</code> 的格式是 <code>web-worker:.xxx.ts</code></p><p>这就导致了我们会在开发环境和生产环境会有不同的表现。</p><h3 id="rollup-plugin-web-worker-loader" tabindex="-1">rollup-plugin-web-worker-loader <a class="header-anchor" href="#rollup-plugin-web-worker-loader" aria-label="Permalink to &quot;rollup-plugin-web-worker-loader&quot;">​</a></h3><p>第一种方案是 <code>rollup</code> 兼容 <code>vite</code></p><p><code>rollup-plugin-web-worker-loader</code> 在源码中提供了 <code>pattern</code> 参数，但是在配置为 <code>vite</code> 所需要的 <code>/(.+)\\?worker/</code> 格式后，转换链路无法追溯。尝试了很久以后，决定转向编写 <code>vite</code> 插件进行处理。</p><h3 id="vite-插件处理" tabindex="-1">vite 插件处理 <a class="header-anchor" href="#vite-插件处理" aria-label="Permalink to &quot;vite 插件处理&quot;">​</a></h3><p><code>vite</code> 插件的 <code>hook</code> 比较常用的是 <code>load</code>, <code>resolveId</code> 和 <code>transformer</code>。在 <code>transformer</code> 中返回给 <code>vite</code> 你想要他处理的内容。</p><p>参照 <a href="https://github.com/vitejs/vite/blob/main/packages/vite/src/node/plugins/worker.ts" target="_blank" rel="noreferrer">源码</a>, 对 <code>web-worker:.xxx.ts</code>类型文件进行 <code>web-worker</code> 相关的处理。</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> path </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">path</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> Plugin</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">vite</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> webWorkerPathTransformPlugin</span><span style="color:#89DDFF;">():</span><span style="color:#FFCB6B;"> Plugin</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> pattern</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> /</span><span style="color:#C3E88D;">web-worker:</span><span style="color:#89DDFF;">(</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">+)/</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    name</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">vite:web-work-path-transform</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    transformer</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">_</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> id</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">id</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">test</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">pattern</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // 处理逻辑</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        return</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">          code</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> \`</span><span style="color:#C3E88D;">export default function WorkerWrapper() {</span></span>
<span class="line"><span style="color:#C3E88D;">            xxxx</span></span>
<span class="line"><span style="color:#C3E88D;">          )}, </span><span style="color:#89DDFF;">\${</span><span style="color:#BABED8;">JSON</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stringify</span><span style="color:#BABED8;">(workerOptions</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> null,</span><span style="color:#F78C6C;"> 2</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">)</span></span>
<span class="line"><span style="color:#C3E88D;">          }</span><span style="color:#89DDFF;">\`</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          map</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span><span style="color:#F07178;"> mappings</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;&#39;</span><span style="color:#89DDFF;"> }</span></span>
<span class="line"><span style="color:#89DDFF;">        }</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;">    },</span></span>
<span class="line"><span style="color:#89DDFF;">  };</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>以上这种处理方式其实就是源码处理内容的一个参数替换版本。但是却非常麻烦，很多处理函数 <code>vite</code> 都没有暴露出来。于是换一种思路，在读取文件的时候，将路径 <code>id</code> 换成 <code>vite</code> 认识的文件资源就可以了。</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> path </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">path</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> Plugin</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">vite</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> webWorkerPathTransformPlugin</span><span style="color:#89DDFF;">():</span><span style="color:#FFCB6B;"> Plugin</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> pattern</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> /</span><span style="color:#C3E88D;">web-worker:</span><span style="color:#89DDFF;">(</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">+)/</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    name</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">vite:web-work-path-transform</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    resolveId</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">id</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> inputFile</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">      const</span><span style="color:#BABED8;"> match</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> id</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">match</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">pattern</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">match</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#BABED8;"> match</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">length</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#BABED8;"> inputFile</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        return</span><span style="color:#F07178;"> (</span></span>
<span class="line"><span style="color:#BABED8;">          path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">dirname</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">inputFile</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> match</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">match</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">length</span><span style="color:#89DDFF;"> -</span><span style="color:#F78C6C;"> 1</span><span style="color:#F07178;">]) </span><span style="color:#89DDFF;">+</span></span>
<span class="line"><span style="color:#89DDFF;">          &#39;</span><span style="color:#C3E88D;">?worker</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">        )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;">    },</span></span>
<span class="line"><span style="color:#89DDFF;">  };</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="尤雨溪也遇到的-bug" tabindex="-1">尤雨溪也遇到的 BUG <a class="header-anchor" href="#尤雨溪也遇到的-bug" aria-label="Permalink to &quot;尤雨溪也遇到的 BUG&quot;">​</a></h2><p>在 <code>react-virtualized</code> 这个包中， <code>es/WindowScroller/utils/onScroll.js</code> 的最后一行出现了下面这段代码。会从 <code>WindowScroller.js</code> 导入这个不存在的 <code>bpfrpt_proptype_WindowScroller</code> 的变量。在 <code>es module</code> 分析依赖的过程中，会直接报错。</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> bpfrpt_proptype_WindowScroller</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">../WindowScroller.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><a href="https://unpkg.com/browse/react-virtualized@9.22.3/dist/es/WindowScroller/utils/onScroll.js" target="_blank" rel="noreferrer">https://unpkg.com/browse/react-virtualized@9.22.3/dist/es/WindowScroller/utils/onScroll.js</a></p><p>有趣的和尤雨溪遇到了同一个问题，在这个 <a href="https://github.com/bvaughn/react-virtualized/issues/1632" target="_blank" rel="noreferrer">issue</a> 里面社区也给到了很多解决方式。</p><p>最常见的解决方案可能是将包提取出来，删掉代码，但是我们的工程是 <code>react-tiny-virtual-list</code> 依赖了 <code>react-virtualized</code> ，属于影子依赖。无法通过这种方式解决。</p><h3 id="补丁包路径替换" tabindex="-1">补丁包路径替换 <a class="header-anchor" href="#补丁包路径替换" aria-label="Permalink to &quot;补丁包路径替换&quot;">​</a></h3><p>可以在 <code>package.json</code> 中增加 <code>resolutions</code> 来描述加载远端 <code>patch</code> 库的资源。</p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  &quot;</span><span style="color:#C792EA;">resolutions</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">    &quot;</span><span style="color:#FFCB6B;">react-virtualized</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">git+https://git@github.com/remorses/react-virtualized-fixed-import.git#9.22.3</span><span style="color:#89DDFF;">&quot;&quot;</span></span>
<span class="line"><span style="color:#C3E88D;">  }</span></span>
<span class="line"><span style="color:#C3E88D;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>需要注意的是，这种方法会强依赖于第三方库，所以还是选择 <code>fork</code> 一份代码出来到自己仓库里面。</p><p>但是最终还是放弃了这个方案，因为这种方式只有 <code>yarn</code> 才能使用，不是通用的解决方案。</p><h3 id="简单粗暴" tabindex="-1">简单粗暴 <a class="header-anchor" href="#简单粗暴" aria-label="Permalink to &quot;简单粗暴&quot;">​</a></h3><p>既然优雅的方式不能完美解决，那就简单粗暴吧。装包的时候把这段代码删掉就行了。从根本上解决。</p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  &quot;</span><span style="color:#C792EA;">patch:react-virtualized</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">npx replace-in-files-cli --string=&#39;import { bpfrpt_proptype_WindowScroller } from </span><span style="color:#BABED8;">\\&quot;</span><span style="color:#C3E88D;">../WindowScroller.js</span><span style="color:#BABED8;">\\&quot;</span><span style="color:#C3E88D;">;&#39; --replacement=&#39;&#39; node_modules/**/onScroll.js</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="依赖包类型问题" tabindex="-1">依赖包类型问题 <a class="header-anchor" href="#依赖包类型问题" aria-label="Permalink to &quot;依赖包类型问题&quot;">​</a></h2><p>部分依赖包是 <code>commonjs</code> 规范,在 <code>vite</code> 的字典里确实找不到和他相似的问题。解决这个问题：</p><ol><li>根据报错路径找到相关依赖包，然后替换掉。</li><li>我们发现在一些对 <code>antd</code> 对依赖会导致相关问题。在同事的帮助下也很快顺利的解决了。</li><li>替换很久不更新的包，替换为现代包。</li></ol><h2 id="两套模式" tabindex="-1">两套模式 <a class="header-anchor" href="#两套模式" aria-label="Permalink to &quot;两套模式&quot;">​</a></h2><p>同事提出，我们现在作为包开发时 <code>vite</code> 的热更确实很舒服，但是加载的资源却并不是正式发布的资源。可能会存在一些偏差。于是需要模拟一套标准发布模式下的开发环境。</p><h3 id="处理方案" tabindex="-1">处理方案 <a class="header-anchor" href="#处理方案" aria-label="Permalink to &quot;处理方案&quot;">​</a></h3><p>所以需要构建两种开发环境：</p><ol><li><code>vite</code> 会作为 <code>devServer</code>，依赖的资源是 <code>rollup</code> 构建后的环境下的资源 <code>es</code> 资源，热更新 <code>rollup</code> 会先打包 <code>packages</code> 资源,然后热更新。保证开发调试的代码为发布时的代码。在这套环境中使用 <code>wait-on</code> 来解决资源未构建时，<code>devServer</code> 需等待后再启动。</li><li><code>vite</code> 会作为 <code>devServer</code>，直接加载源码。极速热更。</li></ol><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// vite.config.js 配置</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> defineConfig</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">vite</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> react </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">@vitejs/plugin-react</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> path </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">path</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> webWorkerPathTransformPlugin</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./plugin/webwork</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> packages </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> [</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-constants</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-utils</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-slate</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-sketch</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-ink</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-pen</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-paper</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-renderer</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-filter</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-ui</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">]</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> getAlias </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">process</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">env</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">NODE_ENV</span><span style="color:#89DDFF;"> !==</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">turbo</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">      &#39;</span><span style="color:#F07178;">@tencent</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resolve</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">__dirname</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">../packages</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">    };</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> map</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">create</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">  packages</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forEach</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">pkg</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">    map</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">@tencent/</span><span style="color:#89DDFF;">\${</span><span style="color:#BABED8;">pkg</span><span style="color:#89DDFF;">}\`</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resolve</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">__dirname</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> \`</span><span style="color:#C3E88D;">../packages/</span><span style="color:#89DDFF;">\${</span><span style="color:#BABED8;">pkg</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">/src</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#BABED8;"> map</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#82AAFF;"> defineConfig</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  plugins</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> [</span><span style="color:#82AAFF;">react</span><span style="color:#BABED8;">()</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> webWorkerPathTransformPlugin</span><span style="color:#BABED8;">()]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  resolve</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    alias</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> getAlias</span><span style="color:#BABED8;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  },</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  &quot;</span><span style="color:#C792EA;">start</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">run-p dev:*</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> // 热更新优化模式</span></span>
<span class="line"><span style="color:#89DDFF;">  &quot;</span><span style="color:#C792EA;">start:turbo</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">cd examples &amp;&amp; cross-env NODE_ENV=turbo npm run dev</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> // 极速模式</span></span>
<span class="line"><span style="color:#89DDFF;">  &quot;</span><span style="color:#C792EA;">dev:pkg</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">npx sand-build start -t lib -w -l -e development</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &quot;</span><span style="color:#C792EA;">dev:example</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">wait-on --config ./build/wait-on-config.js &amp;&amp; cd examples &amp;&amp; npm run dev</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> //等待es资源打包完毕，使用了 wait-on 这个包</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// wait-on-config.js</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> packages </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> [</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-constants</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-utils</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-slate</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-sketch</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-ink</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-pen</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-paper</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-renderer</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-filter</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#C3E88D;">palette-ui</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">module.exports</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  resources</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> packages</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">item</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#89DDFF;"> \`</span><span style="color:#C3E88D;">./packages/</span><span style="color:#89DDFF;">\${</span><span style="color:#BABED8;">item</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">/es/index.js</span><span style="color:#89DDFF;">\`</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="最终效果" tabindex="-1">最终效果 <a class="header-anchor" href="#最终效果" aria-label="Permalink to &quot;最终效果&quot;">​</a></h2><h3 id="启动" tabindex="-1">启动 <a class="header-anchor" href="#启动" aria-label="Permalink to &quot;启动&quot;">​</a></h3><p>秒级启动</p><p><img src="`+r+'" alt="img"></p><h3 id="热更新" tabindex="-1">热更新 <a class="header-anchor" href="#热更新" aria-label="Permalink to &quot;热更新&quot;">​</a></h3><p>极速热更新</p><p><img src="'+c+'" alt="img"></p><p>🚀 🚀 🚀，<code>coding</code> 速度起飞，属于下一代构建工具的降维打击了。</p>',76),i=[D];function F(y,d,b,u,m,h){return n(),a("div",null,i)}const f=s(t,[["render",F]]);export{B as __pageData,f as default};
