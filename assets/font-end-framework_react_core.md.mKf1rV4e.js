import{_ as s,c as n,o as a,U as l}from"./chunks/framework.BWp8c4Qg.js";const p="/blog/assets/llYt0m.CvYUFzp2.png",e="/blog/assets/tCtcnb.B9upiABK.png",A=JSON.parse('{"title":"React核心","description":"","frontmatter":{},"headers":[],"relativePath":"font-end-framework/react/core.md","filePath":"font-end-framework/react/core.md","lastUpdated":1712675567000}'),o={name:"font-end-framework/react/core.md"},c=l('<h1 id="react核心" tabindex="-1">React核心 <a class="header-anchor" href="#react核心" aria-label="Permalink to &quot;React核心&quot;">​</a></h1><p><img src="'+p+`" alt="img"></p><h2 id="react原理" tabindex="-1">React原理 <a class="header-anchor" href="#react原理" aria-label="Permalink to &quot;React原理&quot;">​</a></h2><p>入口 <code>createElement</code>，其原理为 <code>babel-loader</code> 将jsx代码转换成 <code>createElement</code>.</p><p>createElement 有三个参数，type（节点类型），config（配置项），children（子项）</p><p>返回 <code>props</code> 和 <code>type</code>。</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> createElement</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">type</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> config</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> ...</span><span style="color:#BABED8;font-style:italic;">children</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // 生成props</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> props</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">    ...</span><span style="color:#BABED8;">config</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    children</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> children</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#F07178;">(</span><span style="color:#BABED8;font-style:italic;">child</span><span style="color:#C792EA;"> =&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">      typeof</span><span style="color:#BABED8;"> child</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">object</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> ?</span><span style="color:#BABED8;"> child</span><span style="color:#89DDFF;"> :</span><span style="color:#82AAFF;"> createTextNode</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">child</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    )</span></span>
<span class="line"><span style="color:#89DDFF;">  };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">    type</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    props</span></span>
<span class="line"><span style="color:#89DDFF;">  };</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 把文本节点变成对象的形式</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> createTextNode</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">text</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    type</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">text</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    props</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">      children</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> []</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      nodeValue</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> text</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  };</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> createElement </span><span style="color:#89DDFF;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><ul><li>react-dom</li></ul><p><code>react-dom</code> 的 <code>render</code> 函数负责节点渲染。</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> render</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">vNode</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> container</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // vNode转node</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> node</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> createNode</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vNode</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // 添加到容器里面</span></span>
<span class="line"><span style="color:#BABED8;">  container</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">appendChild</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">node</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 生成真实dom节点</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> createNode</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">vNode</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> node</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> null;</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> type</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> props</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> vNode</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // 创建文本节点</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">type</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">text</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    node</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> document</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createTextNode</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;font-style:italic;"> if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#BABED8;"> type</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">string</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // 证明是个html标签节点， 比如div、span</span></span>
<span class="line"><span style="color:#BABED8;">    node</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> document</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createElement</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">type</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;font-style:italic;"> if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#BABED8;"> type</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">function</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // 类组件或者函数组件</span></span>
<span class="line"><span style="color:#BABED8;">    node</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> type</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">isReactComponent</span></span>
<span class="line"><span style="color:#89DDFF;">      ?</span><span style="color:#82AAFF;"> updateClassComponent</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vNode</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">      :</span><span style="color:#82AAFF;"> updateFunctionComponent</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vNode</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // 空节点处理</span></span>
<span class="line"><span style="color:#BABED8;">    node</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> document</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createDocumentFragment</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // 遍历children</span></span>
<span class="line"><span style="color:#82AAFF;">  reconcileChildren</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">props</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">children</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> node</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#82AAFF;">  updateNode</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">node</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> props</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#BABED8;"> node</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 遍历下子节点</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> reconcileChildren</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">children</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> node</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;"> =</span><span style="color:#F78C6C;"> 0</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;"> &lt;</span><span style="color:#BABED8;"> children</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">length</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;">++</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">    let</span><span style="color:#BABED8;"> child</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> children</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">i</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // child是vNode，那需要把vNode-&gt;真实dom节点，然后插入父节点node中</span></span>
<span class="line"><span style="color:#82AAFF;">    render</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">child</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> node</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 添加节点属性</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> updateNode</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">node</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> nextVal</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">  Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">keys</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">nextVal</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    .</span><span style="color:#82AAFF;">filter</span><span style="color:#F07178;">(</span><span style="color:#BABED8;font-style:italic;">k</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> k</span><span style="color:#89DDFF;"> !==</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">children</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    .</span><span style="color:#82AAFF;">forEach</span><span style="color:#F07178;">(</span><span style="color:#BABED8;font-style:italic;">k</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">      node</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">k</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> nextVal</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">k</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 类组件更新</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> updateClassComponent</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">fiber</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> type</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> props</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> fiber</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> cmp</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> type</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">props</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> vvNode</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> cmp</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">render</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> children</span><span style="color:#89DDFF;"> =</span><span style="color:#F07178;"> [</span><span style="color:#BABED8;">vvNode</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#82AAFF;">  reconcileChildren</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">fiber</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> children</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 函数组件更新</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> updateFunctionComponent</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">fiber</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;">type</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> props</span><span style="color:#89DDFF;">}</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> fiber</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> children</span><span style="color:#89DDFF;"> =</span><span style="color:#F07178;"> [</span><span style="color:#82AAFF;">type</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">props</span><span style="color:#F07178;">)]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#82AAFF;">  reconcileChildren</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">fiber</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> children</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;">render</span><span style="color:#89DDFF;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>以上是 react 核心代码，未实现数据变化。</p><ol><li>webpack+babel 编译时，替换 JSX 为 React.createElement(type,props,...children)</li><li>所有 React.createElement() 执行结束后得到一个 JS 对象即 vdom，它能够完整描述 dom 结构</li><li>ReactDOM.render(vdom, container) 可以将 vdom 转换为 dom 并追加到 container 中</li><li>转换过程需要经过一个 diff 过程</li></ol><h2 id="diff-算法" tabindex="-1">diff 算法 <a class="header-anchor" href="#diff-算法" aria-label="Permalink to &quot;diff 算法&quot;">​</a></h2><h3 id="reconciliation-协调" tabindex="-1">reconciliation 协调 <a class="header-anchor" href="#reconciliation-协调" aria-label="Permalink to &quot;reconciliation 协调&quot;">​</a></h3><p>在某一时间节点调用 <code>React</code> 的 <code>render()</code> 方法，会创建一棵由 <code>React</code> 元素组成的树。在下一次 <code>state</code> 或 <code>props</code> 更新时，相同的 <code>render()</code> 方法会返回一棵不同的树。<code>React</code> 需要基于这两棵树之间的差别来判断如何有效率的更新 <code>UI</code> 以保证当前 <code>UI</code> 与最新的树保持同步。在某一时间节点调用 <code>React</code> 的 <code>render()</code> 方法，会创建一棵由 <code>React</code> 元素组成的树。在下一次 <code>state</code> 或 <code>props</code> 更新时，相同的 <code>render()</code> 方法会返回一棵不同的树。<code>React</code> 需要基于这两棵树之间的差别来判断如何有效率的更新 <code>UI</code> 以保证当前 <code>UI</code> 与最新的树保持同步。就是更新 <code>UI</code></p><p><code>react</code> 协调策略：</p><ul><li>两个不同类型的元素会产生出不同的树;</li><li>可以通过 <code>key</code> 来暗示哪些子元素在不同的渲染下能保持稳定;</li></ul><h3 id="diff-策略" tabindex="-1">diff 策略 <a class="header-anchor" href="#diff-策略" aria-label="Permalink to &quot;diff 策略&quot;">​</a></h3><ol><li>同级比较，<code>Web UI</code> 中 <code>DOM</code> 节点跨层级的移动操作特别少，可以忽略不计。</li><li>拥有不同类型的两个组件将会生成不同的树形结构。</li><li>可以通过 <code>key</code> 来暗示哪些子元素在不同的渲染下能保持稳定。</li></ol><h3 id="diff过程" tabindex="-1">diff过程 <a class="header-anchor" href="#diff过程" aria-label="Permalink to &quot;diff过程&quot;">​</a></h3><ul><li>删除: <code>newVNode</code> 不存在时</li><li>替换: <code>vNode</code> 和 <code>newVNode</code> 类型不同或 <code>key</code> 不同时</li><li>更新:有相同类型和 <code>key</code> 但 <code>vNode</code> 和 <code>newVNode</code> 不同时</li></ul><h2 id="fiber" tabindex="-1">Fiber <a class="header-anchor" href="#fiber" aria-label="Permalink to &quot;Fiber&quot;">​</a></h2><p><code>fiber</code> 在组件渲染时使用，<code>fiber</code> 是指组件上将要完成或者已经完成的任务，每个组件可以一个或者多个. <code>fiber</code> 核心代码 <code>window.requestIdleCallback</code>。</p><h3 id="window-requestidlecallback" tabindex="-1">window.requestIdleCallback() <a class="header-anchor" href="#window-requestidlecallback" aria-label="Permalink to &quot;window.requestIdleCallback()&quot;">​</a></h3><p><code>window.requestIdleCallback()</code> 方法将在浏览器的空闲时段内调用的函数排队。这使开发者能够在主事件循环上执行后台和低优先级工作，而不会影响延迟关键事件，如动画和输入响应。函数一般会按先 进先调用的顺序执行，然而，如果回调函数指定了执行超时时间 <code>timeout</code> ，则有可能为了在超时前执行 函数而打乱执行顺序。</p><p>在空闲回调函数中调用 <code>requestIdleCallback()</code> ，以便在下一次通过事件循环之前调度另一个回调。</p><h3 id="fiber-架构" tabindex="-1">Fiber 架构 <a class="header-anchor" href="#fiber-架构" aria-label="Permalink to &quot;Fiber 架构&quot;">​</a></h3><p><img src="`+e+`" alt="img"></p><h3 id="fiber-核心代码" tabindex="-1">Fiber 核心代码 <a class="header-anchor" href="#fiber-核心代码" aria-label="Permalink to &quot;Fiber 核心代码&quot;">​</a></h3><p>fiber 的数据结构如下：</p><ul><li>type: 标记当前节点的类型;</li><li>props: 属性;</li><li>key: 标记唯一性;</li><li>child: 第一个子节点;</li><li>sibling: 下一个兄弟节点;</li><li>return: 指向父节点</li><li>node: 真实的dom节点</li><li>base: 记录下当前的节点</li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> newFiber </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  type</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">text</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  props</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">props</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  node</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> null,</span></span>
<span class="line"><span style="color:#F07178;">  base</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> null,</span></span>
<span class="line"><span style="color:#F07178;">  return</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>使用 fiber 重写 render 函数</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 下一个要执行的fiber，数据结构就是fiber</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> nextUnitWork</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 正在进行中的fiber</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> wipRoot </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> null;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> render</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">vNode</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> container</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">  wipRoot</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    node</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> container</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    props</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">      children</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> [</span><span style="color:#BABED8;">vNode</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#89DDFF;">    },</span></span>
<span class="line"><span style="color:#F07178;">    base</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> null</span></span>
<span class="line"><span style="color:#89DDFF;">  };</span></span>
<span class="line"><span style="color:#BABED8;">  nextUnitOfWork</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> wipRoot</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">requestIdleCallback</span><span style="color:#BABED8;">(workLoop)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> workLoop</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">deadline</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // 剩余时间</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  while</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">nextUnitWork</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#BABED8;"> deadline</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">timeRemaining</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;">&gt;</span><span style="color:#F78C6C;"> 1</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // 执行更新当前fiber，并且返回下一个要执行的fiber</span></span>
<span class="line"><span style="color:#BABED8;">    nextUnitWork</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> performUnitOfWork</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">nextUnitOfWork</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">nextUnitOfWork</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // 没有下一个任务了，执行提交</span></span>
<span class="line"><span style="color:#82AAFF;">      commitRoot</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // 不停执行此函数</span></span>
<span class="line"><span style="color:#82AAFF;">  requestIdleCallback</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">workLoop</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 执行work</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> performUnitOfWork</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">fiber</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // step1:执行更新当前fiber</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> type</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> fiber</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#BABED8;"> type</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">function</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    type</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">isReactComponent</span></span>
<span class="line"><span style="color:#89DDFF;">      ?</span><span style="color:#82AAFF;"> updateClassComponent</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">fiber</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">      :</span><span style="color:#82AAFF;"> updateFunctionComponent</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">fiber</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // 更新原生标签</span></span>
<span class="line"><span style="color:#82AAFF;">    updateHostComponent</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">fiber</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // step2:返回下一个需要执行的fiber</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">fiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">child</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#BABED8;"> fiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">child</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // 无子节点,找兄弟节点</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> nextFiber</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> fiber</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  while</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">nextFiber</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">nextFiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">sibling</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      return</span><span style="color:#BABED8;"> nextFiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">sibling</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#BABED8;">    nextFiber</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> nextFiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">return</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 添加节点属性</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> updateNode</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">node</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> nextVal</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">  Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">keys</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">nextVal</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    .</span><span style="color:#82AAFF;">filter</span><span style="color:#F07178;">(</span><span style="color:#BABED8;font-style:italic;">k</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> k</span><span style="color:#89DDFF;"> !==</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">children</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    .</span><span style="color:#82AAFF;">forEach</span><span style="color:#F07178;">(</span><span style="color:#BABED8;font-style:italic;">k</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">      node</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">k</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> nextVal</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">k</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 生成真实dom节点</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> createNode</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">vnode</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> node</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> null;</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;">type</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> props</span><span style="color:#89DDFF;">}</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> vnode</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">type</span><span style="color:#89DDFF;"> ===</span><span style="color:#BABED8;"> TEXT</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    //创建文本节点</span></span>
<span class="line"><span style="color:#BABED8;">    node</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> document</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createTextNode</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;font-style:italic;"> if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#BABED8;"> type</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">string</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // 证明是个html标签节点， 比如div、span</span></span>
<span class="line"><span style="color:#BABED8;">    node</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> document</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createElement</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">type</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#82AAFF;">  updateNode</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">node</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> props</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#BABED8;"> node</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 处理原生标签</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> updateHostComponent</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">fiber</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">fiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">node</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    fiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">node</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> createNode</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">fiber</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> children</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> fiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">props</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#82AAFF;">  reconcileChildren</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">fiber</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> children</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">  console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">updateHostComponent</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> fiber</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> //sy-log</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 协调子节点</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 1. 给workInProgress添加一个child节点，就是children的第一个子节点形成的fiber</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 2. 形成fiber架构，把children里节点遍历下，形成fiber链表状</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> reconcileChildren</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">workInProgress</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> children</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> prevSibling</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> null;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;"> =</span><span style="color:#F78C6C;"> 0</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;"> &lt;</span><span style="color:#BABED8;"> children</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">length</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;">++</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">    let</span><span style="color:#BABED8;"> child</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> children</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">i</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // 先写初次渲染</span></span>
<span class="line"><span style="color:#C792EA;">    let</span><span style="color:#BABED8;"> newFiber</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">      type</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> child</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">type</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      props</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> child</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">props</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      node</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> null,</span></span>
<span class="line"><span style="color:#F07178;">      base</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> null,</span></span>
<span class="line"><span style="color:#F07178;">      return</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> workInProgress</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      effectTag</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> PLACEMENT</span></span>
<span class="line"><span style="color:#89DDFF;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">i</span><span style="color:#89DDFF;"> ===</span><span style="color:#F78C6C;"> 0</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">      workInProgress</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">child</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> newFiber</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">      prevSibling</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">sibling</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> newFiber</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    prevSibling</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> newFiber</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 提交任务</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> commitRoot</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">  commitWorker</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">wipRoot</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">child</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">  wipRoot</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> null;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> commitWorker</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">fiber</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">fiber</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> parentNodeFiber</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> fiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  while</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">parentNodeFiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">node</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    parentNodeFiber</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> parentNodeFiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> parentNode</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> parentNodeFiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">node</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // fiber有node节点</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">fiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">effectTag</span><span style="color:#89DDFF;"> ===</span><span style="color:#BABED8;"> PLACEMENT</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#BABED8;"> fiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">node</span><span style="color:#89DDFF;"> !==</span><span style="color:#89DDFF;"> null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    parentNode</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">appendChild</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">fiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">node</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">  commitWorker</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">fiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">child</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#82AAFF;">  commitWorker</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">fiber</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">sibling</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br></div></div><h2 id="hook" tabindex="-1">Hook <a class="header-anchor" href="#hook" aria-label="Permalink to &quot;Hook&quot;">​</a></h2><ul><li>类组件，当把属性改变的时候 state 可以对组件进行更新，</li><li>函数组件，在 hook 出现时候，无法进行视图的更新，且函数组件无生命周期，导致函数组件无更广的使用面。</li></ul><h3 id="hook-解决的问题" tabindex="-1">hook 解决的问题 <a class="header-anchor" href="#hook-解决的问题" aria-label="Permalink to &quot;hook 解决的问题&quot;">​</a></h3><ul><li>组件之间复用状态逻辑问题，避免了像类组件那种侵入式的组件结构。一个 hook 只做一件事情，面向过程编程，</li><li>hook 可以让颗粒度较小，比如 <code>componentDidMount</code> 中进行多个接口调用，在 hook 中可以拆分成多个 <code>useEffect</code>，方便做逻辑拆分。</li><li>在类组件中，修改数据是做对象的合并，而 hook 当中是做数据的覆盖。</li></ul><h3 id="hook类型" tabindex="-1">hook类型 <a class="header-anchor" href="#hook类型" aria-label="Permalink to &quot;hook类型&quot;">​</a></h3><blockquote><p>基础的hook</p></blockquote><ul><li>useState</li><li>useEffect</li><li>useContext</li></ul><blockquote><p>额外的hook</p></blockquote><ul><li>useReducer</li><li>useCallback</li><li>useMemo</li><li>useRef</li><li>useImperativeHandle</li><li>useLayoutEffect</li><li>useDebugValue</li></ul><h3 id="useeffect" tabindex="-1">useEffect <a class="header-anchor" href="#useeffect" aria-label="Permalink to &quot;useEffect&quot;">​</a></h3><p>执行 state 中的副作用，在生命周期中类似于 class 组件里的，componentDidMount 和 componentDidUpdate。</p><ul><li>条件执行</li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 依赖项xxx改变时执行</span></span>
<span class="line"><span style="color:#82AAFF;">useEffect</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // do someThing</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#BABED8;">[xxx])</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 只有didMount的生活执行</span></span>
<span class="line"><span style="color:#82AAFF;">useEffect</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // do someThing</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#BABED8;">[])</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>清除</li></ul><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#89DDFF;"> [</span><span style="color:#BABED8;">date</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> setDate</span><span style="color:#89DDFF;">]</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> useState</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">new</span><span style="color:#82AAFF;"> Date</span><span style="color:#BABED8;">())</span></span>
<span class="line"><span style="color:#82AAFF;">useEffect</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> timer</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> setInterval</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">    setDate</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">new</span><span style="color:#82AAFF;"> Date</span><span style="color:#F07178;">())</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#82AAFF;"> clearInterval</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">timer</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  },</span><span style="color:#F78C6C;"> 1000</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#BABED8;">[])</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="自定义-hook" tabindex="-1">自定义 Hook <a class="header-anchor" href="#自定义-hook" aria-label="Permalink to &quot;自定义 Hook&quot;">​</a></h3><p>实现时钟 Hook,名称以<code>use</code>开头，函数内部可以调用其他Hook</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> useClock</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#89DDFF;"> [</span><span style="color:#BABED8;">date</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> setDate</span><span style="color:#89DDFF;">]</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> useState</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">new</span><span style="color:#82AAFF;"> Date</span><span style="color:#F07178;">())</span></span>
<span class="line"><span style="color:#82AAFF;">  useEffect</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> timer</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> setInterval</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">      setDate</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">new</span><span style="color:#82AAFF;"> Date</span><span style="color:#F07178;">())</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      return</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#82AAFF;"> clearInterval</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">timer</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    },</span><span style="color:#F78C6C;"> 1000</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  },</span><span style="color:#F07178;">[])</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#BABED8;"> date</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>Hook 使用规则</li></ul><ol><li>Hook 就是 js 函数，只能在最外层定义 hook，不能在循环和嵌套函数里面去调用。</li><li>只能在 react 的函数组件中调用，在自定义 hook 里面也可以调用 Hook</li></ol><h3 id="usememo-和-usecallback" tabindex="-1">useMemo 和 useCallBack <a class="header-anchor" href="#usememo-和-usecallback" aria-label="Permalink to &quot;useMemo 和 useCallBack&quot;">​</a></h3><h4 id="usememo" tabindex="-1">useMemo <a class="header-anchor" href="#usememo" aria-label="Permalink to &quot;useMemo&quot;">​</a></h4><p>类似于 vue 中的 computed。只有依赖项改变的时候，函数体内容才会执行</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> expensive </span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;"> useMemo</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">  console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">compute</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> sum</span><span style="color:#89DDFF;"> =</span><span style="color:#F78C6C;"> 0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  function</span><span style="color:#82AAFF;"> factorial</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">n</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> total</span><span style="color:#89DDFF;"> =</span><span style="color:#F78C6C;"> 1</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">n</span><span style="color:#89DDFF;"> ==</span><span style="color:#F78C6C;"> 0</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> total</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#82AAFF;"> factorial</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">n</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> total</span><span style="color:#89DDFF;"> +</span><span style="color:#BABED8;"> n</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#BABED8;"> [count])</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="usecallback" tabindex="-1">useCallback <a class="header-anchor" href="#usecallback" aria-label="Permalink to &quot;useCallback&quot;">​</a></h4><p>用于和子组件间的回调性能优化</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 当依赖性xxx变化时才会执行</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> addClick </span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;"> useCallback</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#BABED8;"> [xx])</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="usestate-的大概原理" tabindex="-1">useState 的大概原理 <a class="header-anchor" href="#usestate-的大概原理" aria-label="Permalink to &quot;useState 的大概原理&quot;">​</a></h3><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> stateArray </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> [] </span><span style="color:#676E95;font-style:italic;">// 收集状态，这里用的是数组，实际上是链表,存在fiber节点里面</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> cursor </span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;"> 0</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> myUseState</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">initialState</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> currentCursor</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> cursor</span></span>
<span class="line"><span style="color:#BABED8;">  stateArray</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">currentCursor</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> stateArray</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">currentCursor</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">||</span><span style="color:#BABED8;"> initialState</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#C792EA;">  function</span><span style="color:#82AAFF;"> setState</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">newState</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">    stateArray</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">currentCursor</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> newState</span></span>
<span class="line"><span style="color:#82AAFF;">    render</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">  cursor</span><span style="color:#89DDFF;">++</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#F07178;"> [</span><span style="color:#BABED8;">state</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> setState</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="useeffect大致原理" tabindex="-1">useEffect大致原理 <a class="header-anchor" href="#useeffect大致原理" aria-label="Permalink to &quot;useEffect大致原理&quot;">​</a></h3><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> allDeps </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> [] </span><span style="color:#676E95;font-style:italic;">// 收集状态，这里用的是数组，实际上是链表结构</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> effectCursor </span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;"> 0</span><span style="color:#676E95;font-style:italic;"> //游标</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> myUseEffect</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">callBack</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {},</span><span style="color:#BABED8;font-style:italic;"> depArray</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> []</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">depArray</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">    callBack</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#BABED8;">    allDeps</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">effectCursor</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> depArray</span></span>
<span class="line"><span style="color:#BABED8;">    effectCursor</span><span style="color:#89DDFF;">++</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> deps</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> allDeps</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">effectCursor</span><span style="color:#F07178;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> flag</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> deps</span><span style="color:#89DDFF;"> ?</span><span style="color:#BABED8;"> depArray</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">some</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">el</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> i</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> el</span><span style="color:#89DDFF;"> !==</span><span style="color:#BABED8;"> deps</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">i</span><span style="color:#F07178;">]) </span><span style="color:#89DDFF;">:</span><span style="color:#FF9CAC;"> true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">flag</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">    callBack</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#BABED8;">    allDeps</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">effectCursor</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> depArray</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">  effectCursor</span><span style="color:#89DDFF;">++</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div>`,66),r=[c];function t(F,i,y,D,b,u){return a(),n("div",null,r)}const d=s(o,[["render",t]]);export{A as __pageData,d as default};
