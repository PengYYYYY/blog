import{_ as s,c as a,o as n,U as l}from"./chunks/framework.UId1oBXU.js";const p="/blog/assets/OHAfqO.y-YC382c.png",e="/blog/assets/aQnMed.3Cc_OqJ7.png",B=JSON.parse('{"title":"跨域","description":"","frontmatter":{},"headers":[],"relativePath":"font-end/browser/cross-domain.md","filePath":"font-end/browser/cross-domain.md","lastUpdated":1704645777000}'),o={name:"font-end/browser/cross-domain.md"},r=l('<h1 id="跨域" tabindex="-1">跨域 <a class="header-anchor" href="#跨域" aria-label="Permalink to &quot;跨域&quot;">​</a></h1><h2 id="why" tabindex="-1">why <a class="header-anchor" href="#why" aria-label="Permalink to &quot;why&quot;">​</a></h2><p>Q: 为什么会出现跨域问题？</p><p>A: 同源策略限制了从同一个源加载的文档或脚本如何与来自另一个源的资源进行交互。这是一个用于隔离潜在恶意文件的重要安全机制。同源指：协议、域名、端口号必须一致。</p><p>同源策略控制了不同源之间的交互，例如在使用 XMLHttpRequest 或标签时则会受到同源策略的约束。这些交互通常分为三类：</p><ul><li>通常浏览器允许进行跨域写操作（Cross-origin writes），如链接（links），重定向以及表单提交。特定少数的HTTP请求需要添加 preflight。</li><li>通常浏览器允许跨域资源嵌入（Cross-origin embedding），如 img、script 标签;</li><li>通常浏览器不允许跨域读操作（Cross-origin reads）。</li></ul><p>允许跨域资源嵌入的示例，一些不受同源策略影响的标签示例：</p><ul><li><code>&lt;script src=&quot;...&quot;&gt;&lt;/script&gt;</code> 标签嵌入跨域脚本。语法错误信息只能在同源脚本中捕捉到。</li><li><code>&lt;link rel=&quot;stylesheet&quot; href=&quot;...&quot;&gt;</code> 标签嵌入 CSS。CSS 的跨域需要一个设置正确的 Content-Type 消息头.</li><li><code>&lt;img&gt;</code> 嵌入图片。支持的图片格式包括 PNG,JPEG,GIF,BMP,SVG</li><li><code>&lt;video&gt;</code> 和 <code>&lt;audio&gt;</code> 嵌入多媒体资源。</li><li><code>@font-face</code> 引入的字体。一些浏览器允许跨域字体（ cross-origin fonts），一些需要同源字体（same-origin fonts）。</li><li><code>&lt;frame&gt;和&lt;iframe&gt;</code> 载入的任何资源。站点可以使用 X-Frame-Options 消息头来阻止这种形式的跨域交互。</li></ul><h2 id="cors跨域" tabindex="-1">cors跨域 <a class="header-anchor" href="#cors跨域" aria-label="Permalink to &quot;cors跨域&quot;">​</a></h2><p>跨域资源共享</p><h3 id="预检请求-options" tabindex="-1">预检请求(OPTIONS) <a class="header-anchor" href="#预检请求-options" aria-label="Permalink to &quot;预检请求(OPTIONS)&quot;">​</a></h3><p>浏览器限制跨域请求一般有两种方式：</p><ol><li>浏览器限制发起跨域请求</li><li>跨域请求可以正常发起，但是返回的结果被浏览器拦截了</li></ol><p>一般浏览器都是第二种方式限制跨域请求，那就是说请求已到达服务器，并有可能对数据库里的数据进行了操作，但是返回的结果被浏览器拦截了，那么我们就获取不到返回结果，这是一次失败的请求，但是可能对数据库里的数据产生了影响。</p><p>对这种可能对服务器数据产生副作用的 HTTP 请求方法，浏览器必须先使用 OPTIONS 方法发起一个预检请求，从而获知服务器是否允许该跨域请求：如果允许，就发送带数据的真实请求；如果不允许，则阻止发送带数据的真实请求。</p><h4 id="简单请求" tabindex="-1">简单请求 <a class="header-anchor" href="#简单请求" aria-label="Permalink to &quot;简单请求&quot;">​</a></h4><p>使用下列方法之一且没有人为设置对 CORS 安全的首部字段集合之外的其他首部字段：</p><ul><li><p>GET</p></li><li><p>HEAD</p></li><li><p>POST</p></li><li><p>仅当POST方法的Content-Type值等于下列之一才算作简单请求</p><ul><li>text/plain</li><li>multipart/form-data</li><li>application/x-www-form-urlencoded</li></ul></li></ul><p><img src="'+p+'" alt="img"></p><h4 id="非简单请求" tabindex="-1">非简单请求 <a class="header-anchor" href="#非简单请求" aria-label="Permalink to &quot;非简单请求&quot;">​</a></h4><p>使用了下面任一 HTTP 方法：</p><ul><li>PUT</li><li>DELETE</li><li>CONNECT</li><li>OPTIONS</li><li>TRACE</li><li>PATCH</li></ul><p>人为设置了对 CORS 安全的首部字段集合之外的其他首部字段</p><ul><li>Accept</li><li>Accept-Language</li><li>Content-Language</li><li>Content-Type (but note the additional requirements below)</li><li>DPR</li><li>Downlink</li><li>Save-Data</li><li>Viewport-Width</li><li>Width</li></ul><p>Content-Type 的值不属于下列之一</p><ul><li>application/x-www-form-urlencoded</li><li>multipart/form-data</li><li>text/plain</li></ul><p>发送真正请求前会先发送预检请求，如图所示：</p><p><img src="'+e+`" alt="img"></p><p>1.第一条 OPTIONS 为预检请求，中同时携带了下面两个首部字段：</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#BABED8;">Access</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Control</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Request</span><span style="color:#89DDFF;">-</span><span style="color:#FFCB6B;">Method</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> POST</span></span>
<span class="line"><span style="color:#BABED8;">Access</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Control</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Request</span><span style="color:#89DDFF;">-</span><span style="color:#FFCB6B;">Headers</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> X</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">PINGOTHER</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>预检请求的 Request 中的 Access-Control-Request-Method: POST，是告诉服务器，之后的实际请求将使用POST方式。</li><li>Access-Control-Request-Headers 是告诉服务器，实际请求将携带两个自定义请求首部字段：X-PINGOTHER 与 Content-Type。服务器据此决定，该实际请求是否被允许</li></ul><h3 id="附带身份凭证的请求" tabindex="-1">附带身份凭证的请求 <a class="header-anchor" href="#附带身份凭证的请求" aria-label="Permalink to &quot;附带身份凭证的请求&quot;">​</a></h3><p>一般而言，对于跨域 XMLHttpRequest 或 Fetch 请求，浏览器不会发送身份凭证信息。</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">var</span><span style="color:#BABED8;"> xhr </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> XMLHttpRequest</span><span style="color:#BABED8;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">var</span><span style="color:#BABED8;"> url </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">http://bar.other/resources/credentialed-content/</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">open</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">GET</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> url</span><span style="color:#89DDFF;">,</span><span style="color:#FF9CAC;"> true</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">withCredentials </span><span style="color:#89DDFF;">=</span><span style="color:#FF9CAC;"> true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onreadystatechange</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {};</span></span>
<span class="line"><span style="color:#BABED8;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#BABED8;">()</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>将 XMLHttpRequest 的 withCredentials 标志设置为 true，从而向服务器发送 Cookies。因为这是一个简单 GET 请求，所以浏览器不会对其发起“预检请求”。但是，如果服务器端的响应中未携带 Access-Control-Allow-Credentials: true ，浏览器将不会把响应内容返回给请求的发送者。</p><h4 id="附带身份凭证的请求与通配符" tabindex="-1">附带身份凭证的请求与通配符 <a class="header-anchor" href="#附带身份凭证的请求与通配符" aria-label="Permalink to &quot;附带身份凭证的请求与通配符&quot;">​</a></h4><p>对于附带身份凭证的请求，服务器不得设置 Access-Control-Allow-Origin 的值为“*”。</p><p>因为请求的首部中携带了 Cookie 信息。如果 Access-Control-Allow-Origin 的值为“*”，请求将会失败。而将 Access-Control-Allow-Origin 的值设置为 <a href="http://foo.example" target="_blank" rel="noreferrer">http://foo.example</a>，则请求将成功执行。</p><h3 id="http-响应首部字段" tabindex="-1">HTTP 响应首部字段 <a class="header-anchor" href="#http-响应首部字段" aria-label="Permalink to &quot;HTTP 响应首部字段&quot;">​</a></h3><h4 id="access-control-allow-origin" tabindex="-1">Access-Control-Allow-Origin <a class="header-anchor" href="#access-control-allow-origin" aria-label="Permalink to &quot;Access-Control-Allow-Origin&quot;">​</a></h4><p>origin 参数的值指定了允许访问该资源的外域 URI.对于不需要携带身份凭证的请求，服务器可以指定该字段的值为通配符，表示允许来自所有域的请求。</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#BABED8;">Access</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Control</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Allow</span><span style="color:#89DDFF;">-</span><span style="color:#FFCB6B;">Origin</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &lt;</span><span style="color:#F07178;">origin</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> | *</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="access-control-expose-headers" tabindex="-1">Access-Control-Expose-Headers <a class="header-anchor" href="#access-control-expose-headers" aria-label="Permalink to &quot;Access-Control-Expose-Headers&quot;">​</a></h4><p>在跨域访问时，XMLHttpRequest 对象的 getResponseHeader() 方法只能拿到一些最基本的响应头，Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma，如果要访问其他头，则需要服务器设置本响应头。 Access-Control-Expose-Headers 头让服务器把允许浏览器访问的头放入白名单，例如：</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#BABED8;">Access</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Control</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Expose</span><span style="color:#89DDFF;">-</span><span style="color:#FFCB6B;">Headers</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> X</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">My</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Custom</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Header</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> X</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Another</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Custom</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Header</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="access-control-max-age" tabindex="-1">Access-Control-Max-Age <a class="header-anchor" href="#access-control-max-age" aria-label="Permalink to &quot;Access-Control-Max-Age&quot;">​</a></h4><p>头指定了请求的结果能够被缓存多久</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#BABED8;">Access</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Control</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">Max</span><span style="color:#89DDFF;">-</span><span style="color:#FFCB6B;">Age</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &lt;</span><span style="color:#FFCB6B;">delta-seconds</span><span style="color:#89DDFF;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="access-control-allow-credentials" tabindex="-1">Access-Control-Allow-Credentials <a class="header-anchor" href="#access-control-allow-credentials" aria-label="Permalink to &quot;Access-Control-Allow-Credentials&quot;">​</a></h4><p>指定了当浏览器的 credentials 设置为 true 时是否允许浏览器读取 response 的内容。</p><h4 id="access-control-allow-methods" tabindex="-1">Access-Control-Allow-Methods <a class="header-anchor" href="#access-control-allow-methods" aria-label="Permalink to &quot;Access-Control-Allow-Methods&quot;">​</a></h4><p>用于预检请求的响应,指明了实际请求所允许使用的 HTTP 方法。</p><h4 id="access-control-allow-headers" tabindex="-1">Access-Control-Allow-Headers <a class="header-anchor" href="#access-control-allow-headers" aria-label="Permalink to &quot;Access-Control-Allow-Headers&quot;">​</a></h4><p>用于预检请求的响应。其指明了实际请求中允许携带的首部字段。</p><h4 id="origin" tabindex="-1">Origin <a class="header-anchor" href="#origin" aria-label="Permalink to &quot;Origin&quot;">​</a></h4><p>表明预检请求或实际请求的源站。</p><h4 id="access-control-request-method" tabindex="-1">Access-Control-Request-Method <a class="header-anchor" href="#access-control-request-method" aria-label="Permalink to &quot;Access-Control-Request-Method&quot;">​</a></h4><p>用于预检请求。其作用是，将实际请求所使用的 HTTP 方法告诉服务器。</p><h4 id="access-control-request-headers" tabindex="-1">Access-Control-Request-Headers <a class="header-anchor" href="#access-control-request-headers" aria-label="Permalink to &quot;Access-Control-Request-Headers&quot;">​</a></h4><p>用于预检请求。其作用是，将实际请求所携带的首部字段告诉服务器。</p><h2 id="node中间件代理" tabindex="-1">Node中间件代理 <a class="header-anchor" href="#node中间件代理" aria-label="Permalink to &quot;Node中间件代理&quot;">​</a></h2><p>从服务器向服务器请求，无需遵循同源策略。 node中间件，需要做以下几个步骤：</p><ul><li>接受客户端请求 。</li><li>将请求转发给服务器。</li><li>拿到服务器响应数据。</li><li>将响应转发给客户端。</li></ul><p>我们可以使用 <code>http-proxy-middleware</code> 中间件来做这样的代理</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> express </span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;"> require</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">express</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> proxy </span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;"> require</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http-proxy-middleware</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> app </span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;"> express</span><span style="color:#BABED8;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">use</span><span style="color:#BABED8;">(</span></span>
<span class="line"><span style="color:#89DDFF;">  \`</span><span style="color:#C3E88D;">xxx</span><span style="color:#89DDFF;">\`</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">  proxy</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    target</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">targetUrl</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    changeOrigin</span><span style="color:#89DDFF;">:</span><span style="color:#FF9CAC;"> true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    pathRewrite</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">      [</span><span style="color:#89DDFF;">\`\${</span><span style="color:#BABED8;">config</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">baseUrl</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">cheapflightapi</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">/</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#BABED8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>上面方式适用于以 node 作为 web 服务器的场景，比如 SSR 应用，这样会非常方便的去做各种服务的转发。</p><h2 id="nginx反向代理" tabindex="-1">Nginx反向代理 <a class="header-anchor" href="#nginx反向代理" aria-label="Permalink to &quot;Nginx反向代理&quot;">​</a></h2><p>使用 Nginx 服务器的反向代理功能来实现跨域请求，非常简单且，只需要修改 Nginx 的配置即可解决跨域问题，支持所有浏览器，支持 session，不需要修改任何代码，并且不会影响服务器性能。</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">//</span><span style="color:#C3E88D;"> proxy服务器</span></span>
<span class="line"><span style="color:#FFCB6B;">server</span><span style="color:#C3E88D;"> {</span></span>
<span class="line"><span style="color:#FFCB6B;">  listen</span><span style="color:#F78C6C;"> 80</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#FFCB6B;">  server_name</span><span style="color:#C3E88D;">  www.domain1.com</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#FFCB6B;">  location</span><span style="color:#C3E88D;"> /</span><span style="color:#C3E88D;"> {</span></span>
<span class="line"><span style="color:#FFCB6B;">    proxy_pass</span><span style="color:#C3E88D;">   http://www.domain2.com</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">  #反向代理域</span></span>
<span class="line"><span style="color:#FFCB6B;">    proxy_cookie_domain</span><span style="color:#C3E88D;"> www.domain2.com</span><span style="color:#C3E88D;"> www.domain1.com</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> #修改cookie里域名</span></span>
<span class="line"><span style="color:#FFCB6B;">    index</span><span style="color:#C3E88D;">  index.html</span><span style="color:#C3E88D;"> index.htm</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">    add_header</span><span style="color:#C3E88D;"> Access-Control-Allow-Origin</span><span style="color:#C3E88D;"> http://www.domain1.com</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">  #当前端只跨域不带cookie时，可为*</span></span>
<span class="line"><span style="color:#FFCB6B;">    add_header</span><span style="color:#C3E88D;"> Access-Control-Allow-Credentials</span><span style="color:#89DDFF;"> true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">  }</span></span>
<span class="line"><span style="color:#BABED8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="jsonp" tabindex="-1">JSONP <a class="header-anchor" href="#jsonp" aria-label="Permalink to &quot;JSONP&quot;">​</a></h2><p>利用 script 标签不受跨域限制而形成的一种方案。</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> jsonpRequest</span><span style="color:#89DDFF;">({</span><span style="color:#BABED8;font-style:italic;">url</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> params</span><span style="color:#89DDFF;">}){</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#89DDFF;"> new</span><span style="color:#FFCB6B;"> Promise</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">resolve</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> reject</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;">=&gt;</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">    let</span><span style="color:#BABED8;"> script</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> document</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createElement</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">script</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> cb</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">jsonRequestCb</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> +</span><span style="color:#BABED8;"> Math</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">random</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#BABED8;">    window</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">cb</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#C792EA;"> function</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">data</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">      resolve</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">data</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#BABED8;">    params</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> {...</span><span style="color:#BABED8;">params</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> cb</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C792EA;">    let</span><span style="color:#BABED8;"> arr</span><span style="color:#89DDFF;"> =</span><span style="color:#F07178;"> []</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    for</span><span style="color:#F07178;">(</span><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> key</span><span style="color:#89DDFF;"> in</span><span style="color:#BABED8;"> parmas</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">      arr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">\`\${</span><span style="color:#BABED8;">key</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">=</span><span style="color:#89DDFF;">\${</span><span style="color:#BABED8;">params[key]</span><span style="color:#89DDFF;">}\`</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#BABED8;">    script</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">src</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> \`\${</span><span style="color:#BABED8;">url</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">?</span><span style="color:#89DDFF;">\${</span><span style="color:#BABED8;">arr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">&amp;</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">}\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">    script</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onload</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">      script</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">remove</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#BABED8;">    script</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onerror</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">      reject</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#BABED8;">    document</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">body</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">appendChild</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">script</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">jsonpRequest</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    url</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">http://localhost:3000/say</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    params</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span><span style="color:#F07178;"> wd</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">haoxl</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> },</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">then</span><span style="color:#BABED8;">(</span><span style="color:#BABED8;font-style:italic;">data</span><span style="color:#C792EA;">=&gt;</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">data</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>【JSONP的优缺点】</p><p>优点：兼容性好（兼容低版本IE）</p><p>缺点:</p><ul><li>JSONP 只支持 GET 请求</li><li>XMLHttpRequest 相对于 JSONP 有着更好的错误处理机制</li><li>拿不到状态码是什么和 header</li></ul><h3 id="jsonp-和-ajax-对比" tabindex="-1">JSONP 和 AJAX 对比 <a class="header-anchor" href="#jsonp-和-ajax-对比" aria-label="Permalink to &quot;JSONP 和 AJAX 对比&quot;">​</a></h3><p>JSONP 和 AJAX相同，都是客户端向服务器端发送请求，从服务器端获取数据的方式。但AJAX属于同源策略，JSONP属于非同源策略（跨域请求）</p><h2 id="postmessage" tabindex="-1">postMessage <a class="header-anchor" href="#postmessage" aria-label="Permalink to &quot;postMessage&quot;">​</a></h2><p>window.postMessage(message,targetOrigin) 方法是 html5 新引进的特性，可以使用它来向其它的 window 对象发送消息，无论这个 window 对象是属于同源或不同源.</p><p>实际中使用场景不多，个人认为他属于跨页面通信的一种。我只在一次向 iframe 发送消息的时候用到过。另外小程序的内嵌 H5 向原生发送消息的方法与此类似。</p>`,81),t=[r];function c(i,D,F,y,d,u){return n(),a("div",null,t)}const A=s(o,[["render",c]]);export{B as __pageData,A as default};
