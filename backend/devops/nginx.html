<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nginx | PengYYY</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Happy Life 🏀,  Working Smooth 💻">
    
    <link rel="preload" href="/blog/assets/css/0.styles.15d78004.css" as="style"><link rel="preload" href="/blog/assets/js/app.e6f473de.js" as="script"><link rel="preload" href="/blog/assets/js/2.615a92e6.js" as="script"><link rel="preload" href="/blog/assets/js/26.7907dbbb.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.2801256c.js"><link rel="prefetch" href="/blog/assets/js/100.2e400952.js"><link rel="prefetch" href="/blog/assets/js/101.590e25a8.js"><link rel="prefetch" href="/blog/assets/js/102.19f7bd0b.js"><link rel="prefetch" href="/blog/assets/js/103.f2e53e80.js"><link rel="prefetch" href="/blog/assets/js/104.1105cee1.js"><link rel="prefetch" href="/blog/assets/js/105.dc657231.js"><link rel="prefetch" href="/blog/assets/js/106.a2d51144.js"><link rel="prefetch" href="/blog/assets/js/107.4219c414.js"><link rel="prefetch" href="/blog/assets/js/108.ea1c71c8.js"><link rel="prefetch" href="/blog/assets/js/109.dce88455.js"><link rel="prefetch" href="/blog/assets/js/11.5c98febd.js"><link rel="prefetch" href="/blog/assets/js/110.3f9916df.js"><link rel="prefetch" href="/blog/assets/js/111.28bde672.js"><link rel="prefetch" href="/blog/assets/js/112.d179a417.js"><link rel="prefetch" href="/blog/assets/js/113.7f077001.js"><link rel="prefetch" href="/blog/assets/js/114.706f747b.js"><link rel="prefetch" href="/blog/assets/js/115.43622622.js"><link rel="prefetch" href="/blog/assets/js/116.6938059a.js"><link rel="prefetch" href="/blog/assets/js/117.87a7785b.js"><link rel="prefetch" href="/blog/assets/js/118.d3a02f88.js"><link rel="prefetch" href="/blog/assets/js/119.391e58af.js"><link rel="prefetch" href="/blog/assets/js/12.dea5f0e5.js"><link rel="prefetch" href="/blog/assets/js/120.cba7cbd4.js"><link rel="prefetch" href="/blog/assets/js/121.c03e7a63.js"><link rel="prefetch" href="/blog/assets/js/122.5e0c0711.js"><link rel="prefetch" href="/blog/assets/js/123.0410bace.js"><link rel="prefetch" href="/blog/assets/js/13.9ed8968b.js"><link rel="prefetch" href="/blog/assets/js/14.0b1a70c0.js"><link rel="prefetch" href="/blog/assets/js/15.8925af36.js"><link rel="prefetch" href="/blog/assets/js/16.c87608d1.js"><link rel="prefetch" href="/blog/assets/js/17.07edf7b8.js"><link rel="prefetch" href="/blog/assets/js/18.87ec1856.js"><link rel="prefetch" href="/blog/assets/js/19.f0ed1f96.js"><link rel="prefetch" href="/blog/assets/js/20.91cc4163.js"><link rel="prefetch" href="/blog/assets/js/21.b7b0fa5d.js"><link rel="prefetch" href="/blog/assets/js/22.3931e563.js"><link rel="prefetch" href="/blog/assets/js/23.8176e093.js"><link rel="prefetch" href="/blog/assets/js/24.38727ada.js"><link rel="prefetch" href="/blog/assets/js/25.61f6f70d.js"><link rel="prefetch" href="/blog/assets/js/27.f1af7215.js"><link rel="prefetch" href="/blog/assets/js/28.f51d54bd.js"><link rel="prefetch" href="/blog/assets/js/29.753ac330.js"><link rel="prefetch" href="/blog/assets/js/3.d7834cfe.js"><link rel="prefetch" href="/blog/assets/js/30.2b217e50.js"><link rel="prefetch" href="/blog/assets/js/31.fbd822fb.js"><link rel="prefetch" href="/blog/assets/js/32.2a92b4f5.js"><link rel="prefetch" href="/blog/assets/js/33.5e4449ca.js"><link rel="prefetch" href="/blog/assets/js/34.fb5f1bf7.js"><link rel="prefetch" href="/blog/assets/js/35.5bd53f3e.js"><link rel="prefetch" href="/blog/assets/js/36.e302888b.js"><link rel="prefetch" href="/blog/assets/js/37.ac95653e.js"><link rel="prefetch" href="/blog/assets/js/38.429cb560.js"><link rel="prefetch" href="/blog/assets/js/39.545b355d.js"><link rel="prefetch" href="/blog/assets/js/4.03235a2f.js"><link rel="prefetch" href="/blog/assets/js/40.d08bd8a6.js"><link rel="prefetch" href="/blog/assets/js/41.e9b400ee.js"><link rel="prefetch" href="/blog/assets/js/42.3db059b0.js"><link rel="prefetch" href="/blog/assets/js/43.0a588551.js"><link rel="prefetch" href="/blog/assets/js/44.dbfa7349.js"><link rel="prefetch" href="/blog/assets/js/45.a1c4bf25.js"><link rel="prefetch" href="/blog/assets/js/46.711d144b.js"><link rel="prefetch" href="/blog/assets/js/47.cf9ba86d.js"><link rel="prefetch" href="/blog/assets/js/48.61cd13a7.js"><link rel="prefetch" href="/blog/assets/js/49.2df7b286.js"><link rel="prefetch" href="/blog/assets/js/5.a556b432.js"><link rel="prefetch" href="/blog/assets/js/50.5d9ee899.js"><link rel="prefetch" href="/blog/assets/js/51.24812116.js"><link rel="prefetch" href="/blog/assets/js/52.06419b22.js"><link rel="prefetch" href="/blog/assets/js/53.93f43246.js"><link rel="prefetch" href="/blog/assets/js/54.5c51a3ad.js"><link rel="prefetch" href="/blog/assets/js/55.c5a64763.js"><link rel="prefetch" href="/blog/assets/js/56.32045283.js"><link rel="prefetch" href="/blog/assets/js/57.0934b785.js"><link rel="prefetch" href="/blog/assets/js/58.14242ce5.js"><link rel="prefetch" href="/blog/assets/js/59.c1621902.js"><link rel="prefetch" href="/blog/assets/js/6.0f1039b1.js"><link rel="prefetch" href="/blog/assets/js/60.8ca8af20.js"><link rel="prefetch" href="/blog/assets/js/61.58bf56f4.js"><link rel="prefetch" href="/blog/assets/js/62.f377f50a.js"><link rel="prefetch" href="/blog/assets/js/63.736aadbf.js"><link rel="prefetch" href="/blog/assets/js/64.d3ae2ac6.js"><link rel="prefetch" href="/blog/assets/js/65.9a097331.js"><link rel="prefetch" href="/blog/assets/js/66.76d312c0.js"><link rel="prefetch" href="/blog/assets/js/67.1734a5bd.js"><link rel="prefetch" href="/blog/assets/js/68.6facbfbe.js"><link rel="prefetch" href="/blog/assets/js/69.0b0ba420.js"><link rel="prefetch" href="/blog/assets/js/7.387d883a.js"><link rel="prefetch" href="/blog/assets/js/70.2f232f6d.js"><link rel="prefetch" href="/blog/assets/js/71.c0dc3455.js"><link rel="prefetch" href="/blog/assets/js/72.853b5102.js"><link rel="prefetch" href="/blog/assets/js/73.213c3a58.js"><link rel="prefetch" href="/blog/assets/js/74.edcf6826.js"><link rel="prefetch" href="/blog/assets/js/75.2cb1e219.js"><link rel="prefetch" href="/blog/assets/js/76.10de5c1e.js"><link rel="prefetch" href="/blog/assets/js/77.3d570e45.js"><link rel="prefetch" href="/blog/assets/js/78.9ee516da.js"><link rel="prefetch" href="/blog/assets/js/79.719b87ef.js"><link rel="prefetch" href="/blog/assets/js/8.afc6d5ca.js"><link rel="prefetch" href="/blog/assets/js/80.f717798f.js"><link rel="prefetch" href="/blog/assets/js/81.942f7986.js"><link rel="prefetch" href="/blog/assets/js/82.46077de0.js"><link rel="prefetch" href="/blog/assets/js/83.1e7399de.js"><link rel="prefetch" href="/blog/assets/js/84.8403292d.js"><link rel="prefetch" href="/blog/assets/js/85.a20cd9b5.js"><link rel="prefetch" href="/blog/assets/js/86.8c7c71e2.js"><link rel="prefetch" href="/blog/assets/js/87.03e27673.js"><link rel="prefetch" href="/blog/assets/js/88.990dbbfb.js"><link rel="prefetch" href="/blog/assets/js/89.217aa324.js"><link rel="prefetch" href="/blog/assets/js/9.0705089f.js"><link rel="prefetch" href="/blog/assets/js/90.f572d84d.js"><link rel="prefetch" href="/blog/assets/js/91.11dd6cc4.js"><link rel="prefetch" href="/blog/assets/js/92.fbcd5c2e.js"><link rel="prefetch" href="/blog/assets/js/93.413301b4.js"><link rel="prefetch" href="/blog/assets/js/94.d212961a.js"><link rel="prefetch" href="/blog/assets/js/95.db22ac2e.js"><link rel="prefetch" href="/blog/assets/js/96.80b39ad2.js"><link rel="prefetch" href="/blog/assets/js/97.f3920b6d.js"><link rel="prefetch" href="/blog/assets/js/98.acc782da.js"><link rel="prefetch" href="/blog/assets/js/99.58988589.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.15d78004.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">PengYYY</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/fontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/blog/backend/" class="nav-link router-link-active">
  后端
</a></div><div class="nav-item"><a href="/blog/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/blog/conclusion/" class="nav-link">
  总结
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/fontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/blog/backend/" class="nav-link router-link-active">
  后端
</a></div><div class="nav-item"><a href="/blog/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/blog/conclusion/" class="nav-link">
  总结
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>devops</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/backend/devops/git-flow.html" class="sidebar-link">git-flow</a></li><li><a href="/blog/backend/devops/docker.html" class="sidebar-link">docker</a></li><li><a href="/blog/backend/devops/nginx.html" aria-current="page" class="active sidebar-link">nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#常用配置" class="sidebar-link">常用配置</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#certbot安装https" class="sidebar-link">certbot安装https</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#nginx-优势" class="sidebar-link">Nginx 优势</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#nginx-主要应用场景" class="sidebar-link">Nginx 主要应用场景</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#正向代理-forward-proxy" class="sidebar-link">正向代理 Forward proxy</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#反向代理-reverse-proxy" class="sidebar-link">反向代理 Reverse proxy</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#gzip" class="sidebar-link">Gzip</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#请求限制" class="sidebar-link">请求限制</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#访问控制" class="sidebar-link">访问控制</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#防盗链" class="sidebar-link">防盗链</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#负载均衡-load-balance" class="sidebar-link">负载均衡 Load Balance</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>db</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx"><a href="#nginx" class="header-anchor">#</a> nginx</h1> <p>CPU 朝着多核方向发展，之前的霸主 Apache 一个进程同一时间只能处理一个连接，处理完一个请求后才能处理下一个，这无疑不能应对如今互联网上海量的用户。况且进程间切换的成本是非常高的。在这种背景下，Nginx 应运而生，可以轻松处理数百万、上千万的连接。</p> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#gcc安装，nginx源码编译需要</span>
yum <span class="token function">install</span> gcc-c++

<span class="token comment">#PCRE pcre-devel 安装，nginx 的 http 模块使用 pcre 来解析正则表达式</span>
yum <span class="token function">install</span> -y pcre pcre-devel

<span class="token comment">#zlib安装，nginx 使用zlib对http包的内容进行gzip</span>
yum <span class="token function">install</span> -y zlib zlib-devel

<span class="token comment">#OpenSSL 安装，强大的安全套接字层密码库，nginx 不仅支持 http 协议，还支持 https（即在ssl协议上传输http）</span>
yum <span class="token function">install</span> -y openssl openssl-devel
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="下载nginx源码"><a href="#下载nginx源码" class="header-anchor">#</a> 下载nginx源码</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">wget</span> -c https://nginx.org/download/nginx-1.16.1.tar.gz //找到自己需要的版本

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="安装操作"><a href="#安装操作" class="header-anchor">#</a> 安装操作</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#根目录使用ls命令可以看到下载的nginx压缩包，然后解压</span>
<span class="token function">tar</span> -zxvf nginx-1.16.1.tar.gz
<span class="token comment">#解压后进入目录</span>
<span class="token builtin class-name">cd</span> nginx-1.16.1
<span class="token comment">#使用默认配置</span>
./configure
<span class="token comment"># https模块安装</span>
./configure --with-http_stub_status_module --with-http_ssl_module
<span class="token comment">#编译安装</span>
<span class="token function">make</span>
<span class="token function">make</span> <span class="token function">install</span>
<span class="token comment">#查找安装路径，默认都是这个路径</span>
<span class="token punctuation">[</span>root@VM_0_12_centos ~<span class="token punctuation">]</span><span class="token comment"># whereis nginx</span>
nginx: /usr/local/nginx
<span class="token comment">#启动、停止nginx</span>
<span class="token builtin class-name">cd</span> /usr/local/nginx/sbin/
./nginx     <span class="token comment">#启动</span>
./nginx -s stop  <span class="token comment">#停止，直接查找nginx进程id再使用kill命令强制杀掉进程</span>
./nginx -s quit  <span class="token comment">#退出停止，等待nginx进程处理完任务再进行停止</span>
./nginx -s reload  <span class="token comment">#重新加载配置文件，修改nginx.conf后使用该命令，新配置即可生效</span>
<span class="token comment">#重启nginx，建议先停止，再启动</span>
./nginx -s stop
./nginx
 <span class="token comment">#查看nginx进程，如下返回，即为成功</span>
<span class="token punctuation">[</span>root@VM_0_12_centos ~<span class="token punctuation">]</span><span class="token comment"># ps aux|grep nginx</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="环境变量"><a href="#环境变量" class="header-anchor">#</a> 环境变量</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">NGINX_HOME</span><span class="token operator">=</span>/usr/local/nginx
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$NGINX_HOME</span>/sbin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="常用配置"><a href="#常用配置" class="header-anchor">#</a> 常用配置</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>server <span class="token punctuation">{</span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  server_name  code.limchihi.cn<span class="token punctuation">;</span>
  location / <span class="token punctuation">{</span>
    proxy_pass http://127.0.0.1:3000/<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="项目配置-http"><a href="#项目配置-http" class="header-anchor">#</a> 项目配置(http)</h3> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$myRoot</span> = /root/fe/stage</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$myServerName</span> = xxxx</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$proxyApi</span> = http://api.ynoo.net/api</span><span class="token punctuation">;</span>
    
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  <span class="token variable">$myServerName</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">rewrite</span> ^/(.*) https://<span class="token variable">$server_name</span><span class="token variable">$1</span> permanent</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">root</span> <span class="token variable">$myRoot</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html =404</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">location</span> /adminAPI</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">proxy_pass</span> <span class="token variable">$proxyApi</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">error_page</span>   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> = /50x.html</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">root</span>   html</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="项目配置-https"><a href="#项目配置-https" class="header-anchor">#</a> 项目配置(https)</h3> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$myServerName</span> = xxxx</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  <span class="token variable">$myServerName</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">rewrite</span> ^/(.*) https://<span class="token variable">$server_name</span><span class="token variable">$1</span> permanent</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$myRoot</span> = /root/fe/stage</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$myServerName</span> = ms.ynoo.net</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$myNginxConfRoot</span> = /usr/local/nginx/server/cert
    set <span class="token variable">$proxyApi</span> = http://api.ynoo.net/api</span><span class="token punctuation">;</span>
  
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  xxzk.ynoo.net</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_certificate</span>      $</span><span class="token punctuation">{</span>myNginxConfRoot<span class="token punctuation">}</span>/$<span class="token punctuation">{</span>myServerName<span class="token punctuation">}</span>/index.pem<span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span>  $</span><span class="token punctuation">{</span>myNginxConfRoot<span class="token punctuation">}</span>/$<span class="token punctuation">{</span>myServerName<span class="token punctuation">}</span>/index.key<span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">keepalive_timeout</span> <span class="token number">100</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_session_cache</span>    shared:SSL:5m</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_session_timeout</span>  <span class="token number">5m</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_ciphers</span>  HIGH:!aNULL:!MD5</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_prefer_server_ciphers</span>  <span class="token boolean">on</span></span><span class="token punctuation">;</span>
  
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html =404</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">location</span> /adminAPI</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">proxy_pass</span> <span class="token variable">$proxyApi</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">error_page</span>   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> = /50x.html</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">root</span>   html</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h3 id="api服务https配置"><a href="#api服务https配置" class="header-anchor">#</a> api服务https配置</h3> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  xxzk.ynoo.net</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:7001/</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token string">'upgrade'</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_bypass</span> <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  xxzk.ynoo.net</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_certificate</span>      /usr/local/nginx/server/cert/xxzk.ynoo.net/index.pem</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span>  /usr/local/nginx/server/cert/xxzk.ynoo.net/index.key</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">keepalive_timeout</span> <span class="token number">100</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_session_cache</span>    shared:SSL:5m</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_session_timeout</span>  <span class="token number">5m</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_ciphers</span>  HIGH:!aNULL:!MD5</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_prefer_server_ciphers</span>  <span class="token boolean">on</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-Port <span class="token variable">$remote_port</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:7001</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass_request_headers</span>      <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="history路由配置"><a href="#history路由配置" class="header-anchor">#</a> history路由配置</h3> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>      <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">index</span>  index.html index.htm</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">root</span> /xxx/xxx</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html =404</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="静态文件校验"><a href="#静态文件校验" class="header-anchor">#</a> 静态文件校验</h3> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> = /jt0lp6bkO2.txt</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">default_type</span> text/plain</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">200</span> <span class="token string">'8e2bffc79f0305e793dd1e17f6aa6a43'</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">#禁止访问的文件或目录</span>
<span class="token directive"><span class="token keyword">location</span> ~ ^/(\.user.ini|\.htaccess|\.git|\.svn|\.project|LICENSE|README.md)</span>
<span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">404</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</span>
<span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">expires</span>   <span class="token number">30d</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">error_log</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">access_log</span> /dev/null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> ~ .*\.(js|css)?$</span>
<span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">expires</span>   <span class="token number">12h</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">error_log</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">access_log</span> /dev/null</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="certbot安装https"><a href="#certbot安装https" class="header-anchor">#</a> certbot安装https</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>//安装
<span class="token function">sudo</span> yum <span class="token function">install</span> certbot python2-certbot-nginx
//启动
// nginx.conf路径
certbot --nginx --nginx-server-root<span class="token operator">=</span>/usr/local/nginx/conf
//自动更新
<span class="token builtin class-name">echo</span> <span class="token string">&quot;0 0,12 * * * root python -c 'import random; import time; time.sleep(random.random() * 3600)' &amp;&amp; certbot renew -q&quot;</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/crontab <span class="token operator">&gt;</span> /dev/null
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="nginx-优势"><a href="#nginx-优势" class="header-anchor">#</a> Nginx 优势</h2> <ul><li>高并发高性能</li> <li>可扩展性好</li> <li>高可靠性</li> <li>热部署</li></ul> <h2 id="nginx-主要应用场景"><a href="#nginx-主要应用场景" class="header-anchor">#</a> Nginx 主要应用场景</h2> <ul><li>静态资源服务，通过本地文件系统提供服务</li> <li>反向代理服务、负载均衡</li> <li>API 服务、权限控制，减少应用服务器压力</li> <li>网关服务</li></ul> <h2 id="正向代理-forward-proxy"><a href="#正向代理-forward-proxy" class="header-anchor">#</a> 正向代理 Forward proxy</h2> <p>正向代理的对象时客户端，服务端看不到真正的客户端。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span> 
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>     
    <span class="token comment"># 当客户端请求我的时候，我会把请求转发给它      </span>
    <span class="token comment"># $http_host 要访问的主机名 $request_uri 请求路径      </span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://<span class="token variable">$http_host</span><span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="反向代理-reverse-proxy"><a href="#反向代理-reverse-proxy" class="header-anchor">#</a> 反向代理 Reverse proxy</h2> <p>解决跨域问题，在生产中，可以使用nginx的反向代理来解决跨域：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>    
  <span class="token directive"><span class="token keyword">listen</span>   <span class="token number">80</span></span><span class="token punctuation">;</span>    
  <span class="token directive"><span class="token keyword">server_name</span>   localhost</span><span class="token punctuation">;</span> <span class="token comment"># 用户访问 localhost，反向代理到 http://www.baidu.com</span>
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>        
    proxy_pass http://www.baidu.com
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="gzip"><a href="#gzip" class="header-anchor">#</a> Gzip</h2> <p>gzip 是互联网上非常普遍的一种数据压缩格式，对于纯文本来说可以压缩到原大小的 40%，可以节省大量的带宽。启用 gzip 所需的 HTTP 最低版本是 1.1。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> ~ .*\. (jpg|png|gif)$</span> <span class="token punctuation">{</span>    
  <span class="token directive"><span class="token keyword">gzip</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span> <span class="token comment">#关闭压缩    </span>
  <span class="token directive"><span class="token keyword">root</span> xxxx</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">location</span> ~ .*\. (html|js|css)$</span> <span class="token punctuation">{</span>    
  <span class="token directive"><span class="token keyword">gzip</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span> <span class="token comment">#启用压缩    </span>
  <span class="token directive"><span class="token keyword">gzip_min_length</span> <span class="token number">1k</span></span><span class="token punctuation">;</span> <span class="token comment"># 超过1K的文件才压缩    </span>
  <span class="token directive"><span class="token keyword">gzip_http_version</span> 1.1</span><span class="token punctuation">;</span> <span class="token comment"># 启用gzip压缩所需的HTTP最低版本    </span>
  <span class="token directive"><span class="token keyword">gzip_comp_level</span> <span class="token number">9</span></span><span class="token punctuation">;</span> <span class="token comment"># 压缩级别，压缩比率越高，文件被压缩的体积越小    </span>
  <span class="token directive"><span class="token keyword">gzip_types</span> text/css application/javascript</span><span class="token punctuation">;</span> <span class="token comment"># 进行压缩的文件类型    </span>
  <span class="token directive"><span class="token keyword">root</span> xxxx</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="请求限制"><a href="#请求限制" class="header-anchor">#</a> 请求限制</h2> <p>对于大流量恶意的访问，会造成带宽的浪费，给服务器增加压力。往往对于同一 <code>IP</code> 的连接数以及并发数进行限制。
关于请求限制主要有两种类型：</p> <ul><li>limit_conn_module 连接频率限制</li> <li>limit_req_module 请求频率限制</li></ul> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token comment"># $binary_remote_addr 远程IP地址 zone 区域名称 10m内存区域大小</span>
<span class="token directive"><span class="token keyword">limit_conn_zone</span> <span class="token variable">$binary_remote_addr</span> zone=coon_zone:10m</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>    
  <span class="token comment"># conn_zone 设置对应的共享内存区域 1是限制的数量 </span>
  <span class="token directive"><span class="token keyword">limit_conn</span> conn_zone <span class="token number">1</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token comment"># $binary_remote_addr 远程IP地址 zone 区域名称 10m内存区域大小 rate 为请求频率 1s 一次limit_req_zone $binary_remote_addr zone=req_zone:10m rate=1r/s;</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>    
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>        
    <span class="token comment"># 设置对应的共享内存区域 burst最大请求数阈值 nodelay不希望超过的请求被延迟        </span>
    <span class="token directive"><span class="token keyword">limit_req</span> zone=req_zone burst=5 nodelay</span><span class="token punctuation">;</span>   
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="访问控制"><a href="#访问控制" class="header-anchor">#</a> 访问控制</h2> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>// 基于 <span class="token directive"><span class="token keyword">IP</span> 的访问控制
server</span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">location</span> ~ ^/index.html</span> <span class="token punctuation">{</span> 
    <span class="token comment"># 匹配 index.html 页面 除了 127.0.0.1 以外都可以访问  </span>
    <span class="token directive"><span class="token keyword">deny</span> 127.0.0.1</span><span class="token punctuation">;</span>  
    <span class="token directive"><span class="token keyword">allow</span> all</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="防盗链"><a href="#防盗链" class="header-anchor">#</a> 防盗链</h2> <p>防盗链的原理就是根据请求头中 referer 得到网页来源，从而实现访问控制。这样可以防止网站资源被非法盗用，从而保证信息安全，减少带宽损耗，减轻服务器压力。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> ~ .*\.(jpg|png|gif)$</span> <span class="token punctuation">{</span> <span class="token comment"># 匹配防盗链资源的文件类型    </span>
  <span class="token comment"># 通过 valid_referers 定义合法的地址白名单 $invalid_referer 不合法的返回403      </span>
  <span class="token directive"><span class="token keyword">valid_referers</span> none blocked 127.0.0.1</span><span class="token punctuation">;</span>    
  <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$invalid_referer</span>)</span> <span class="token punctuation">{</span>        
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>    
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="负载均衡-load-balance"><a href="#负载均衡-load-balance" class="header-anchor">#</a> 负载均衡 Load Balance</h2> <p>当我们的网站需要解决高并发、海量数据问题时，就需要使用负载均衡来调度服务器。将请求合理的分发到应用服务器集群中的一台台服务器上。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token comment"># upstream 指定后端服务器地址</span>
<span class="token comment"># weight 设置权重</span>
<span class="token comment"># server 中会将 http://webcanteen 的请求转发到 upstream 池中</span>

<span class="token directive"><span class="token keyword">upstream</span> webcanteen</span> <span class="token punctuation">{</span>    
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:66 weight=10</span><span class="token punctuation">;</span>    
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:77 weight=1</span><span class="token punctuation">;</span>    
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:88 weight=1</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>    
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>        
    proxy_pass http://webcanteen    
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="后端服务器状态"><a href="#后端服务器状态" class="header-anchor">#</a> 后端服务器状态</h3> <p>down：当前服务器不参与负载均衡
backup：当其他节点都无法使用时的备用服务器
max_fails：允许请求失败的次数，若到达就会休眠
fail_timeout：经过 max_fails 次失败后，服务器的暂停时间，默认为 10s
max_conns：限制每个服务器的最大接收连接数</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> webcanteen</span> <span class="token punctuation">{</span> 
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:66 down</span><span class="token punctuation">;</span> 
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:77 backup</span><span class="token punctuation">;</span> 
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:88  max_fails=3 fail_timeout=10s</span><span class="token punctuation">;</span> 
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:99 max_conns=1000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="分配方式"><a href="#分配方式" class="header-anchor">#</a> 分配方式</h3> <p>轮询（默认），每个请求按照时间顺序轮流分配到不同的后端服务器，如果某台后端服务器宕机，Nginx 轮训列表会自动将它去除掉；
weight（加权轮询），轮询的加强版，weight 和访问几率成正比，主要用于后端服务器性能不均的场景；
ip_hash，每个请求按照访问 IP 的 hash 结果分配，这样每个访问可以固定访问一个后端服务器；
url_hash，按照访问 URL 的 hash 结果来分配请求，使得每个 URL 定向到同一个后端服务器上，主要应用于后端服务器为缓存时的场景；
自定义 hash，基于任意关键字作为 hash key 实现 hash 算法的负载均衡；
fair，按照后端服务器的响应时间来分配请求，响应时间短则优先分配。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/backend/devops/docker.html" class="prev">
        docker
      </a></span> <span class="next"><a href="/blog/backend/db/mysql.html">
        mysql
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.e6f473de.js" defer></script><script src="/blog/assets/js/2.615a92e6.js" defer></script><script src="/blog/assets/js/26.7907dbbb.js" defer></script>
  </body>
</html>
