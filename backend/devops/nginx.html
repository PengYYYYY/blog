<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nginx | PengYYY</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Happy Life ğŸ€,  Working Smooth ğŸ’»">
    
    <link rel="preload" href="/blog/assets/css/0.styles.15d78004.css" as="style"><link rel="preload" href="/blog/assets/js/app.e6f473de.js" as="script"><link rel="preload" href="/blog/assets/js/2.615a92e6.js" as="script"><link rel="preload" href="/blog/assets/js/26.7907dbbb.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.2801256c.js"><link rel="prefetch" href="/blog/assets/js/100.2e400952.js"><link rel="prefetch" href="/blog/assets/js/101.590e25a8.js"><link rel="prefetch" href="/blog/assets/js/102.19f7bd0b.js"><link rel="prefetch" href="/blog/assets/js/103.f2e53e80.js"><link rel="prefetch" href="/blog/assets/js/104.1105cee1.js"><link rel="prefetch" href="/blog/assets/js/105.dc657231.js"><link rel="prefetch" href="/blog/assets/js/106.a2d51144.js"><link rel="prefetch" href="/blog/assets/js/107.4219c414.js"><link rel="prefetch" href="/blog/assets/js/108.ea1c71c8.js"><link rel="prefetch" href="/blog/assets/js/109.dce88455.js"><link rel="prefetch" href="/blog/assets/js/11.5c98febd.js"><link rel="prefetch" href="/blog/assets/js/110.3f9916df.js"><link rel="prefetch" href="/blog/assets/js/111.28bde672.js"><link rel="prefetch" href="/blog/assets/js/112.d179a417.js"><link rel="prefetch" href="/blog/assets/js/113.7f077001.js"><link rel="prefetch" href="/blog/assets/js/114.706f747b.js"><link rel="prefetch" href="/blog/assets/js/115.43622622.js"><link rel="prefetch" href="/blog/assets/js/116.6938059a.js"><link rel="prefetch" href="/blog/assets/js/117.87a7785b.js"><link rel="prefetch" href="/blog/assets/js/118.d3a02f88.js"><link rel="prefetch" href="/blog/assets/js/119.391e58af.js"><link rel="prefetch" href="/blog/assets/js/12.dea5f0e5.js"><link rel="prefetch" href="/blog/assets/js/120.cba7cbd4.js"><link rel="prefetch" href="/blog/assets/js/121.c03e7a63.js"><link rel="prefetch" href="/blog/assets/js/122.5e0c0711.js"><link rel="prefetch" href="/blog/assets/js/123.0410bace.js"><link rel="prefetch" href="/blog/assets/js/13.9ed8968b.js"><link rel="prefetch" href="/blog/assets/js/14.0b1a70c0.js"><link rel="prefetch" href="/blog/assets/js/15.8925af36.js"><link rel="prefetch" href="/blog/assets/js/16.c87608d1.js"><link rel="prefetch" href="/blog/assets/js/17.07edf7b8.js"><link rel="prefetch" href="/blog/assets/js/18.87ec1856.js"><link rel="prefetch" href="/blog/assets/js/19.f0ed1f96.js"><link rel="prefetch" href="/blog/assets/js/20.91cc4163.js"><link rel="prefetch" href="/blog/assets/js/21.b7b0fa5d.js"><link rel="prefetch" href="/blog/assets/js/22.3931e563.js"><link rel="prefetch" href="/blog/assets/js/23.8176e093.js"><link rel="prefetch" href="/blog/assets/js/24.38727ada.js"><link rel="prefetch" href="/blog/assets/js/25.61f6f70d.js"><link rel="prefetch" href="/blog/assets/js/27.f1af7215.js"><link rel="prefetch" href="/blog/assets/js/28.f51d54bd.js"><link rel="prefetch" href="/blog/assets/js/29.753ac330.js"><link rel="prefetch" href="/blog/assets/js/3.d7834cfe.js"><link rel="prefetch" href="/blog/assets/js/30.2b217e50.js"><link rel="prefetch" href="/blog/assets/js/31.fbd822fb.js"><link rel="prefetch" href="/blog/assets/js/32.2a92b4f5.js"><link rel="prefetch" href="/blog/assets/js/33.5e4449ca.js"><link rel="prefetch" href="/blog/assets/js/34.fb5f1bf7.js"><link rel="prefetch" href="/blog/assets/js/35.5bd53f3e.js"><link rel="prefetch" href="/blog/assets/js/36.e302888b.js"><link rel="prefetch" href="/blog/assets/js/37.ac95653e.js"><link rel="prefetch" href="/blog/assets/js/38.429cb560.js"><link rel="prefetch" href="/blog/assets/js/39.545b355d.js"><link rel="prefetch" href="/blog/assets/js/4.03235a2f.js"><link rel="prefetch" href="/blog/assets/js/40.d08bd8a6.js"><link rel="prefetch" href="/blog/assets/js/41.e9b400ee.js"><link rel="prefetch" href="/blog/assets/js/42.3db059b0.js"><link rel="prefetch" href="/blog/assets/js/43.0a588551.js"><link rel="prefetch" href="/blog/assets/js/44.dbfa7349.js"><link rel="prefetch" href="/blog/assets/js/45.a1c4bf25.js"><link rel="prefetch" href="/blog/assets/js/46.711d144b.js"><link rel="prefetch" href="/blog/assets/js/47.cf9ba86d.js"><link rel="prefetch" href="/blog/assets/js/48.61cd13a7.js"><link rel="prefetch" href="/blog/assets/js/49.2df7b286.js"><link rel="prefetch" href="/blog/assets/js/5.a556b432.js"><link rel="prefetch" href="/blog/assets/js/50.5d9ee899.js"><link rel="prefetch" href="/blog/assets/js/51.24812116.js"><link rel="prefetch" href="/blog/assets/js/52.06419b22.js"><link rel="prefetch" href="/blog/assets/js/53.93f43246.js"><link rel="prefetch" href="/blog/assets/js/54.5c51a3ad.js"><link rel="prefetch" href="/blog/assets/js/55.c5a64763.js"><link rel="prefetch" href="/blog/assets/js/56.32045283.js"><link rel="prefetch" href="/blog/assets/js/57.0934b785.js"><link rel="prefetch" href="/blog/assets/js/58.14242ce5.js"><link rel="prefetch" href="/blog/assets/js/59.c1621902.js"><link rel="prefetch" href="/blog/assets/js/6.0f1039b1.js"><link rel="prefetch" href="/blog/assets/js/60.8ca8af20.js"><link rel="prefetch" href="/blog/assets/js/61.58bf56f4.js"><link rel="prefetch" href="/blog/assets/js/62.f377f50a.js"><link rel="prefetch" href="/blog/assets/js/63.736aadbf.js"><link rel="prefetch" href="/blog/assets/js/64.d3ae2ac6.js"><link rel="prefetch" href="/blog/assets/js/65.9a097331.js"><link rel="prefetch" href="/blog/assets/js/66.76d312c0.js"><link rel="prefetch" href="/blog/assets/js/67.1734a5bd.js"><link rel="prefetch" href="/blog/assets/js/68.6facbfbe.js"><link rel="prefetch" href="/blog/assets/js/69.0b0ba420.js"><link rel="prefetch" href="/blog/assets/js/7.387d883a.js"><link rel="prefetch" href="/blog/assets/js/70.2f232f6d.js"><link rel="prefetch" href="/blog/assets/js/71.c0dc3455.js"><link rel="prefetch" href="/blog/assets/js/72.853b5102.js"><link rel="prefetch" href="/blog/assets/js/73.213c3a58.js"><link rel="prefetch" href="/blog/assets/js/74.edcf6826.js"><link rel="prefetch" href="/blog/assets/js/75.2cb1e219.js"><link rel="prefetch" href="/blog/assets/js/76.10de5c1e.js"><link rel="prefetch" href="/blog/assets/js/77.3d570e45.js"><link rel="prefetch" href="/blog/assets/js/78.9ee516da.js"><link rel="prefetch" href="/blog/assets/js/79.719b87ef.js"><link rel="prefetch" href="/blog/assets/js/8.afc6d5ca.js"><link rel="prefetch" href="/blog/assets/js/80.f717798f.js"><link rel="prefetch" href="/blog/assets/js/81.942f7986.js"><link rel="prefetch" href="/blog/assets/js/82.46077de0.js"><link rel="prefetch" href="/blog/assets/js/83.1e7399de.js"><link rel="prefetch" href="/blog/assets/js/84.8403292d.js"><link rel="prefetch" href="/blog/assets/js/85.a20cd9b5.js"><link rel="prefetch" href="/blog/assets/js/86.8c7c71e2.js"><link rel="prefetch" href="/blog/assets/js/87.03e27673.js"><link rel="prefetch" href="/blog/assets/js/88.990dbbfb.js"><link rel="prefetch" href="/blog/assets/js/89.217aa324.js"><link rel="prefetch" href="/blog/assets/js/9.0705089f.js"><link rel="prefetch" href="/blog/assets/js/90.f572d84d.js"><link rel="prefetch" href="/blog/assets/js/91.11dd6cc4.js"><link rel="prefetch" href="/blog/assets/js/92.fbcd5c2e.js"><link rel="prefetch" href="/blog/assets/js/93.413301b4.js"><link rel="prefetch" href="/blog/assets/js/94.d212961a.js"><link rel="prefetch" href="/blog/assets/js/95.db22ac2e.js"><link rel="prefetch" href="/blog/assets/js/96.80b39ad2.js"><link rel="prefetch" href="/blog/assets/js/97.f3920b6d.js"><link rel="prefetch" href="/blog/assets/js/98.acc782da.js"><link rel="prefetch" href="/blog/assets/js/99.58988589.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.15d78004.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">PengYYY</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/fontend/" class="nav-link">
  å‰ç«¯
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  ç®—æ³•
</a></div><div class="nav-item"><a href="/blog/backend/" class="nav-link router-link-active">
  åç«¯
</a></div><div class="nav-item"><a href="/blog/network/" class="nav-link">
  ç½‘ç»œ
</a></div><div class="nav-item"><a href="/blog/conclusion/" class="nav-link">
  æ€»ç»“
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/fontend/" class="nav-link">
  å‰ç«¯
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  ç®—æ³•
</a></div><div class="nav-item"><a href="/blog/backend/" class="nav-link router-link-active">
  åç«¯
</a></div><div class="nav-item"><a href="/blog/network/" class="nav-link">
  ç½‘ç»œ
</a></div><div class="nav-item"><a href="/blog/conclusion/" class="nav-link">
  æ€»ç»“
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>devops</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/backend/devops/git-flow.html" class="sidebar-link">git-flow</a></li><li><a href="/blog/backend/devops/docker.html" class="sidebar-link">docker</a></li><li><a href="/blog/backend/devops/nginx.html" aria-current="page" class="active sidebar-link">nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#å®‰è£…" class="sidebar-link">å®‰è£…</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#å¸¸ç”¨é…ç½®" class="sidebar-link">å¸¸ç”¨é…ç½®</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#certbotå®‰è£…https" class="sidebar-link">certbotå®‰è£…https</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#nginx-ä¼˜åŠ¿" class="sidebar-link">Nginx ä¼˜åŠ¿</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#nginx-ä¸»è¦åº”ç”¨åœºæ™¯" class="sidebar-link">Nginx ä¸»è¦åº”ç”¨åœºæ™¯</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#æ­£å‘ä»£ç†-forward-proxy" class="sidebar-link">æ­£å‘ä»£ç† Forward proxy</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#åå‘ä»£ç†-reverse-proxy" class="sidebar-link">åå‘ä»£ç† Reverse proxy</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#gzip" class="sidebar-link">Gzip</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#è¯·æ±‚é™åˆ¶" class="sidebar-link">è¯·æ±‚é™åˆ¶</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#è®¿é—®æ§åˆ¶" class="sidebar-link">è®¿é—®æ§åˆ¶</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#é˜²ç›—é“¾" class="sidebar-link">é˜²ç›—é“¾</a></li><li class="sidebar-sub-header"><a href="/blog/backend/devops/nginx.html#è´Ÿè½½å‡è¡¡-load-balance" class="sidebar-link">è´Ÿè½½å‡è¡¡ Load Balance</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>db</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx"><a href="#nginx" class="header-anchor">#</a> nginx</h1> <p>CPU æœç€å¤šæ ¸æ–¹å‘å‘å±•ï¼Œä¹‹å‰çš„éœ¸ä¸» Apache ä¸€ä¸ªè¿›ç¨‹åŒä¸€æ—¶é—´åªèƒ½å¤„ç†ä¸€ä¸ªè¿æ¥ï¼Œå¤„ç†å®Œä¸€ä¸ªè¯·æ±‚åæ‰èƒ½å¤„ç†ä¸‹ä¸€ä¸ªï¼Œè¿™æ— ç–‘ä¸èƒ½åº”å¯¹å¦‚ä»Šäº’è”ç½‘ä¸Šæµ·é‡çš„ç”¨æˆ·ã€‚å†µä¸”è¿›ç¨‹é—´åˆ‡æ¢çš„æˆæœ¬æ˜¯éå¸¸é«˜çš„ã€‚åœ¨è¿™ç§èƒŒæ™¯ä¸‹ï¼ŒNginx åº”è¿è€Œç”Ÿï¼Œå¯ä»¥è½»æ¾å¤„ç†æ•°ç™¾ä¸‡ã€ä¸Šåƒä¸‡çš„è¿æ¥ã€‚</p> <h2 id="å®‰è£…"><a href="#å®‰è£…" class="header-anchor">#</a> å®‰è£…</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#gccå®‰è£…ï¼Œnginxæºç ç¼–è¯‘éœ€è¦</span>
yum <span class="token function">install</span> gcc-c++

<span class="token comment">#PCRE pcre-devel å®‰è£…ï¼Œnginx çš„ http æ¨¡å—ä½¿ç”¨ pcre æ¥è§£ææ­£åˆ™è¡¨è¾¾å¼</span>
yum <span class="token function">install</span> -y pcre pcre-devel

<span class="token comment">#zlibå®‰è£…ï¼Œnginx ä½¿ç”¨zlibå¯¹httpåŒ…çš„å†…å®¹è¿›è¡Œgzip</span>
yum <span class="token function">install</span> -y zlib zlib-devel

<span class="token comment">#OpenSSL å®‰è£…ï¼Œå¼ºå¤§çš„å®‰å…¨å¥—æ¥å­—å±‚å¯†ç åº“ï¼Œnginx ä¸ä»…æ”¯æŒ http åè®®ï¼Œè¿˜æ”¯æŒ httpsï¼ˆå³åœ¨sslåè®®ä¸Šä¼ è¾“httpï¼‰</span>
yum <span class="token function">install</span> -y openssl openssl-devel
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="ä¸‹è½½nginxæºç "><a href="#ä¸‹è½½nginxæºç " class="header-anchor">#</a> ä¸‹è½½nginxæºç </h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">wget</span> -c https://nginx.org/download/nginx-1.16.1.tar.gz //æ‰¾åˆ°è‡ªå·±éœ€è¦çš„ç‰ˆæœ¬

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="å®‰è£…æ“ä½œ"><a href="#å®‰è£…æ“ä½œ" class="header-anchor">#</a> å®‰è£…æ“ä½œ</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#æ ¹ç›®å½•ä½¿ç”¨lså‘½ä»¤å¯ä»¥çœ‹åˆ°ä¸‹è½½çš„nginxå‹ç¼©åŒ…ï¼Œç„¶åè§£å‹</span>
<span class="token function">tar</span> -zxvf nginx-1.16.1.tar.gz
<span class="token comment">#è§£å‹åè¿›å…¥ç›®å½•</span>
<span class="token builtin class-name">cd</span> nginx-1.16.1
<span class="token comment">#ä½¿ç”¨é»˜è®¤é…ç½®</span>
./configure
<span class="token comment"># httpsæ¨¡å—å®‰è£…</span>
./configure --with-http_stub_status_module --with-http_ssl_module
<span class="token comment">#ç¼–è¯‘å®‰è£…</span>
<span class="token function">make</span>
<span class="token function">make</span> <span class="token function">install</span>
<span class="token comment">#æŸ¥æ‰¾å®‰è£…è·¯å¾„ï¼Œé»˜è®¤éƒ½æ˜¯è¿™ä¸ªè·¯å¾„</span>
<span class="token punctuation">[</span>root@VM_0_12_centos ~<span class="token punctuation">]</span><span class="token comment"># whereis nginx</span>
nginx: /usr/local/nginx
<span class="token comment">#å¯åŠ¨ã€åœæ­¢nginx</span>
<span class="token builtin class-name">cd</span> /usr/local/nginx/sbin/
./nginx     <span class="token comment">#å¯åŠ¨</span>
./nginx -s stop  <span class="token comment">#åœæ­¢ï¼Œç›´æ¥æŸ¥æ‰¾nginxè¿›ç¨‹idå†ä½¿ç”¨killå‘½ä»¤å¼ºåˆ¶æ€æ‰è¿›ç¨‹</span>
./nginx -s quit  <span class="token comment">#é€€å‡ºåœæ­¢ï¼Œç­‰å¾…nginxè¿›ç¨‹å¤„ç†å®Œä»»åŠ¡å†è¿›è¡Œåœæ­¢</span>
./nginx -s reload  <span class="token comment">#é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹nginx.confåä½¿ç”¨è¯¥å‘½ä»¤ï¼Œæ–°é…ç½®å³å¯ç”Ÿæ•ˆ</span>
<span class="token comment">#é‡å¯nginxï¼Œå»ºè®®å…ˆåœæ­¢ï¼Œå†å¯åŠ¨</span>
./nginx -s stop
./nginx
 <span class="token comment">#æŸ¥çœ‹nginxè¿›ç¨‹ï¼Œå¦‚ä¸‹è¿”å›ï¼Œå³ä¸ºæˆåŠŸ</span>
<span class="token punctuation">[</span>root@VM_0_12_centos ~<span class="token punctuation">]</span><span class="token comment"># ps aux|grep nginx</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="header-anchor">#</a> ç¯å¢ƒå˜é‡</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">NGINX_HOME</span><span class="token operator">=</span>/usr/local/nginx
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$NGINX_HOME</span>/sbin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="å¸¸ç”¨é…ç½®"><a href="#å¸¸ç”¨é…ç½®" class="header-anchor">#</a> å¸¸ç”¨é…ç½®</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>server <span class="token punctuation">{</span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  server_name  code.limchihi.cn<span class="token punctuation">;</span>
  location / <span class="token punctuation">{</span>
    proxy_pass http://127.0.0.1:3000/<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="é¡¹ç›®é…ç½®-http"><a href="#é¡¹ç›®é…ç½®-http" class="header-anchor">#</a> é¡¹ç›®é…ç½®(http)</h3> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$myRoot</span> = /root/fe/stage</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$myServerName</span> = xxxx</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$proxyApi</span> = http://api.ynoo.net/api</span><span class="token punctuation">;</span>
    
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  <span class="token variable">$myServerName</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">rewrite</span> ^/(.*) https://<span class="token variable">$server_name</span><span class="token variable">$1</span> permanent</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">root</span> <span class="token variable">$myRoot</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html =404</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">location</span> /adminAPI</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">proxy_pass</span> <span class="token variable">$proxyApi</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">error_page</span>   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> = /50x.html</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">root</span>   html</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="é¡¹ç›®é…ç½®-https"><a href="#é¡¹ç›®é…ç½®-https" class="header-anchor">#</a> é¡¹ç›®é…ç½®(https)</h3> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$myServerName</span> = xxxx</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  <span class="token variable">$myServerName</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">rewrite</span> ^/(.*) https://<span class="token variable">$server_name</span><span class="token variable">$1</span> permanent</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$myRoot</span> = /root/fe/stage</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$myServerName</span> = ms.ynoo.net</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$myNginxConfRoot</span> = /usr/local/nginx/server/cert
    set <span class="token variable">$proxyApi</span> = http://api.ynoo.net/api</span><span class="token punctuation">;</span>
  
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  xxzk.ynoo.net</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_certificate</span>      $</span><span class="token punctuation">{</span>myNginxConfRoot<span class="token punctuation">}</span>/$<span class="token punctuation">{</span>myServerName<span class="token punctuation">}</span>/index.pem<span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span>  $</span><span class="token punctuation">{</span>myNginxConfRoot<span class="token punctuation">}</span>/$<span class="token punctuation">{</span>myServerName<span class="token punctuation">}</span>/index.key<span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">keepalive_timeout</span> <span class="token number">100</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_session_cache</span>    shared:SSL:5m</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_session_timeout</span>  <span class="token number">5m</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_ciphers</span>  HIGH:!aNULL:!MD5</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_prefer_server_ciphers</span>  <span class="token boolean">on</span></span><span class="token punctuation">;</span>
  
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html =404</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">location</span> /adminAPI</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">proxy_pass</span> <span class="token variable">$proxyApi</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">error_page</span>   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> = /50x.html</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">root</span>   html</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h3 id="apiæœåŠ¡httpsé…ç½®"><a href="#apiæœåŠ¡httpsé…ç½®" class="header-anchor">#</a> apiæœåŠ¡httpsé…ç½®</h3> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  xxzk.ynoo.net</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:7001/</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token string">'upgrade'</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_bypass</span> <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  xxzk.ynoo.net</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_certificate</span>      /usr/local/nginx/server/cert/xxzk.ynoo.net/index.pem</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span>  /usr/local/nginx/server/cert/xxzk.ynoo.net/index.key</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">keepalive_timeout</span> <span class="token number">100</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_session_cache</span>    shared:SSL:5m</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_session_timeout</span>  <span class="token number">5m</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_ciphers</span>  HIGH:!aNULL:!MD5</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_prefer_server_ciphers</span>  <span class="token boolean">on</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-Port <span class="token variable">$remote_port</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:7001</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass_request_headers</span>      <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="historyè·¯ç”±é…ç½®"><a href="#historyè·¯ç”±é…ç½®" class="header-anchor">#</a> historyè·¯ç”±é…ç½®</h3> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>      <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">index</span>  index.html index.htm</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">root</span> /xxx/xxx</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html =404</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="é™æ€æ–‡ä»¶æ ¡éªŒ"><a href="#é™æ€æ–‡ä»¶æ ¡éªŒ" class="header-anchor">#</a> é™æ€æ–‡ä»¶æ ¡éªŒ</h3> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> = /jt0lp6bkO2.txt</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">default_type</span> text/plain</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">200</span> <span class="token string">'8e2bffc79f0305e793dd1e17f6aa6a43'</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">#ç¦æ­¢è®¿é—®çš„æ–‡ä»¶æˆ–ç›®å½•</span>
<span class="token directive"><span class="token keyword">location</span> ~ ^/(\.user.ini|\.htaccess|\.git|\.svn|\.project|LICENSE|README.md)</span>
<span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">404</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</span>
<span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">expires</span>   <span class="token number">30d</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">error_log</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">access_log</span> /dev/null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> ~ .*\.(js|css)?$</span>
<span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">expires</span>   <span class="token number">12h</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">error_log</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">access_log</span> /dev/null</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="certbotå®‰è£…https"><a href="#certbotå®‰è£…https" class="header-anchor">#</a> certbotå®‰è£…https</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>//å®‰è£…
<span class="token function">sudo</span> yum <span class="token function">install</span> certbot python2-certbot-nginx
//å¯åŠ¨
// nginx.confè·¯å¾„
certbot --nginx --nginx-server-root<span class="token operator">=</span>/usr/local/nginx/conf
//è‡ªåŠ¨æ›´æ–°
<span class="token builtin class-name">echo</span> <span class="token string">&quot;0 0,12 * * * root python -c 'import random; import time; time.sleep(random.random() * 3600)' &amp;&amp; certbot renew -q&quot;</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/crontab <span class="token operator">&gt;</span> /dev/null
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="nginx-ä¼˜åŠ¿"><a href="#nginx-ä¼˜åŠ¿" class="header-anchor">#</a> Nginx ä¼˜åŠ¿</h2> <ul><li>é«˜å¹¶å‘é«˜æ€§èƒ½</li> <li>å¯æ‰©å±•æ€§å¥½</li> <li>é«˜å¯é æ€§</li> <li>çƒ­éƒ¨ç½²</li></ul> <h2 id="nginx-ä¸»è¦åº”ç”¨åœºæ™¯"><a href="#nginx-ä¸»è¦åº”ç”¨åœºæ™¯" class="header-anchor">#</a> Nginx ä¸»è¦åº”ç”¨åœºæ™¯</h2> <ul><li>é™æ€èµ„æºæœåŠ¡ï¼Œé€šè¿‡æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿæä¾›æœåŠ¡</li> <li>åå‘ä»£ç†æœåŠ¡ã€è´Ÿè½½å‡è¡¡</li> <li>API æœåŠ¡ã€æƒé™æ§åˆ¶ï¼Œå‡å°‘åº”ç”¨æœåŠ¡å™¨å‹åŠ›</li> <li>ç½‘å…³æœåŠ¡</li></ul> <h2 id="æ­£å‘ä»£ç†-forward-proxy"><a href="#æ­£å‘ä»£ç†-forward-proxy" class="header-anchor">#</a> æ­£å‘ä»£ç† Forward proxy</h2> <p>æ­£å‘ä»£ç†çš„å¯¹è±¡æ—¶å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯çœ‹ä¸åˆ°çœŸæ­£çš„å®¢æˆ·ç«¯ã€‚</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span> 
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>     
    <span class="token comment"># å½“å®¢æˆ·ç«¯è¯·æ±‚æˆ‘çš„æ—¶å€™ï¼Œæˆ‘ä¼šæŠŠè¯·æ±‚è½¬å‘ç»™å®ƒ      </span>
    <span class="token comment"># $http_host è¦è®¿é—®çš„ä¸»æœºå $request_uri è¯·æ±‚è·¯å¾„      </span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://<span class="token variable">$http_host</span><span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="åå‘ä»£ç†-reverse-proxy"><a href="#åå‘ä»£ç†-reverse-proxy" class="header-anchor">#</a> åå‘ä»£ç† Reverse proxy</h2> <p>è§£å†³è·¨åŸŸé—®é¢˜ï¼Œåœ¨ç”Ÿäº§ä¸­ï¼Œå¯ä»¥ä½¿ç”¨nginxçš„åå‘ä»£ç†æ¥è§£å†³è·¨åŸŸï¼š</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>    
  <span class="token directive"><span class="token keyword">listen</span>   <span class="token number">80</span></span><span class="token punctuation">;</span>    
  <span class="token directive"><span class="token keyword">server_name</span>   localhost</span><span class="token punctuation">;</span> <span class="token comment"># ç”¨æˆ·è®¿é—® localhostï¼Œåå‘ä»£ç†åˆ° http://www.baidu.com</span>
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>        
    proxy_pass http://www.baidu.com
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="gzip"><a href="#gzip" class="header-anchor">#</a> Gzip</h2> <p>gzip æ˜¯äº’è”ç½‘ä¸Šéå¸¸æ™®éçš„ä¸€ç§æ•°æ®å‹ç¼©æ ¼å¼ï¼Œå¯¹äºçº¯æ–‡æœ¬æ¥è¯´å¯ä»¥å‹ç¼©åˆ°åŸå¤§å°çš„ 40%ï¼Œå¯ä»¥èŠ‚çœå¤§é‡çš„å¸¦å®½ã€‚å¯ç”¨ gzip æ‰€éœ€çš„ HTTP æœ€ä½ç‰ˆæœ¬æ˜¯ 1.1ã€‚</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> ~ .*\. (jpg|png|gif)$</span> <span class="token punctuation">{</span>    
  <span class="token directive"><span class="token keyword">gzip</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span> <span class="token comment">#å…³é—­å‹ç¼©    </span>
  <span class="token directive"><span class="token keyword">root</span> xxxx</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">location</span> ~ .*\. (html|js|css)$</span> <span class="token punctuation">{</span>    
  <span class="token directive"><span class="token keyword">gzip</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span> <span class="token comment">#å¯ç”¨å‹ç¼©    </span>
  <span class="token directive"><span class="token keyword">gzip_min_length</span> <span class="token number">1k</span></span><span class="token punctuation">;</span> <span class="token comment"># è¶…è¿‡1Kçš„æ–‡ä»¶æ‰å‹ç¼©    </span>
  <span class="token directive"><span class="token keyword">gzip_http_version</span> 1.1</span><span class="token punctuation">;</span> <span class="token comment"># å¯ç”¨gzipå‹ç¼©æ‰€éœ€çš„HTTPæœ€ä½ç‰ˆæœ¬    </span>
  <span class="token directive"><span class="token keyword">gzip_comp_level</span> <span class="token number">9</span></span><span class="token punctuation">;</span> <span class="token comment"># å‹ç¼©çº§åˆ«ï¼Œå‹ç¼©æ¯”ç‡è¶Šé«˜ï¼Œæ–‡ä»¶è¢«å‹ç¼©çš„ä½“ç§¯è¶Šå°    </span>
  <span class="token directive"><span class="token keyword">gzip_types</span> text/css application/javascript</span><span class="token punctuation">;</span> <span class="token comment"># è¿›è¡Œå‹ç¼©çš„æ–‡ä»¶ç±»å‹    </span>
  <span class="token directive"><span class="token keyword">root</span> xxxx</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="è¯·æ±‚é™åˆ¶"><a href="#è¯·æ±‚é™åˆ¶" class="header-anchor">#</a> è¯·æ±‚é™åˆ¶</h2> <p>å¯¹äºå¤§æµé‡æ¶æ„çš„è®¿é—®ï¼Œä¼šé€ æˆå¸¦å®½çš„æµªè´¹ï¼Œç»™æœåŠ¡å™¨å¢åŠ å‹åŠ›ã€‚å¾€å¾€å¯¹äºåŒä¸€ <code>IP</code> çš„è¿æ¥æ•°ä»¥åŠå¹¶å‘æ•°è¿›è¡Œé™åˆ¶ã€‚
å…³äºè¯·æ±‚é™åˆ¶ä¸»è¦æœ‰ä¸¤ç§ç±»å‹ï¼š</p> <ul><li>limit_conn_module è¿æ¥é¢‘ç‡é™åˆ¶</li> <li>limit_req_module è¯·æ±‚é¢‘ç‡é™åˆ¶</li></ul> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token comment"># $binary_remote_addr è¿œç¨‹IPåœ°å€ zone åŒºåŸŸåç§° 10må†…å­˜åŒºåŸŸå¤§å°</span>
<span class="token directive"><span class="token keyword">limit_conn_zone</span> <span class="token variable">$binary_remote_addr</span> zone=coon_zone:10m</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>    
  <span class="token comment"># conn_zone è®¾ç½®å¯¹åº”çš„å…±äº«å†…å­˜åŒºåŸŸ 1æ˜¯é™åˆ¶çš„æ•°é‡ </span>
  <span class="token directive"><span class="token keyword">limit_conn</span> conn_zone <span class="token number">1</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token comment"># $binary_remote_addr è¿œç¨‹IPåœ°å€ zone åŒºåŸŸåç§° 10må†…å­˜åŒºåŸŸå¤§å° rate ä¸ºè¯·æ±‚é¢‘ç‡ 1s ä¸€æ¬¡limit_req_zone $binary_remote_addr zone=req_zone:10m rate=1r/s;</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>    
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>        
    <span class="token comment"># è®¾ç½®å¯¹åº”çš„å…±äº«å†…å­˜åŒºåŸŸ burstæœ€å¤§è¯·æ±‚æ•°é˜ˆå€¼ nodelayä¸å¸Œæœ›è¶…è¿‡çš„è¯·æ±‚è¢«å»¶è¿Ÿ        </span>
    <span class="token directive"><span class="token keyword">limit_req</span> zone=req_zone burst=5 nodelay</span><span class="token punctuation">;</span>   
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="è®¿é—®æ§åˆ¶"><a href="#è®¿é—®æ§åˆ¶" class="header-anchor">#</a> è®¿é—®æ§åˆ¶</h2> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code>// åŸºäº <span class="token directive"><span class="token keyword">IP</span> çš„è®¿é—®æ§åˆ¶
server</span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">location</span> ~ ^/index.html</span> <span class="token punctuation">{</span> 
    <span class="token comment"># åŒ¹é… index.html é¡µé¢ é™¤äº† 127.0.0.1 ä»¥å¤–éƒ½å¯ä»¥è®¿é—®  </span>
    <span class="token directive"><span class="token keyword">deny</span> 127.0.0.1</span><span class="token punctuation">;</span>  
    <span class="token directive"><span class="token keyword">allow</span> all</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="é˜²ç›—é“¾"><a href="#é˜²ç›—é“¾" class="header-anchor">#</a> é˜²ç›—é“¾</h2> <p>é˜²ç›—é“¾çš„åŸç†å°±æ˜¯æ ¹æ®è¯·æ±‚å¤´ä¸­ referer å¾—åˆ°ç½‘é¡µæ¥æºï¼Œä»è€Œå®ç°è®¿é—®æ§åˆ¶ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢ç½‘ç«™èµ„æºè¢«éæ³•ç›—ç”¨ï¼Œä»è€Œä¿è¯ä¿¡æ¯å®‰å…¨ï¼Œå‡å°‘å¸¦å®½æŸè€—ï¼Œå‡è½»æœåŠ¡å™¨å‹åŠ›ã€‚</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> ~ .*\.(jpg|png|gif)$</span> <span class="token punctuation">{</span> <span class="token comment"># åŒ¹é…é˜²ç›—é“¾èµ„æºçš„æ–‡ä»¶ç±»å‹    </span>
  <span class="token comment"># é€šè¿‡ valid_referers å®šä¹‰åˆæ³•çš„åœ°å€ç™½åå• $invalid_referer ä¸åˆæ³•çš„è¿”å›403      </span>
  <span class="token directive"><span class="token keyword">valid_referers</span> none blocked 127.0.0.1</span><span class="token punctuation">;</span>    
  <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$invalid_referer</span>)</span> <span class="token punctuation">{</span>        
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>    
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="è´Ÿè½½å‡è¡¡-load-balance"><a href="#è´Ÿè½½å‡è¡¡-load-balance" class="header-anchor">#</a> è´Ÿè½½å‡è¡¡ Load Balance</h2> <p>å½“æˆ‘ä»¬çš„ç½‘ç«™éœ€è¦è§£å†³é«˜å¹¶å‘ã€æµ·é‡æ•°æ®é—®é¢˜æ—¶ï¼Œå°±éœ€è¦ä½¿ç”¨è´Ÿè½½å‡è¡¡æ¥è°ƒåº¦æœåŠ¡å™¨ã€‚å°†è¯·æ±‚åˆç†çš„åˆ†å‘åˆ°åº”ç”¨æœåŠ¡å™¨é›†ç¾¤ä¸­çš„ä¸€å°å°æœåŠ¡å™¨ä¸Šã€‚</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token comment"># upstream æŒ‡å®šåç«¯æœåŠ¡å™¨åœ°å€</span>
<span class="token comment"># weight è®¾ç½®æƒé‡</span>
<span class="token comment"># server ä¸­ä¼šå°† http://webcanteen çš„è¯·æ±‚è½¬å‘åˆ° upstream æ± ä¸­</span>

<span class="token directive"><span class="token keyword">upstream</span> webcanteen</span> <span class="token punctuation">{</span>    
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:66 weight=10</span><span class="token punctuation">;</span>    
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:77 weight=1</span><span class="token punctuation">;</span>    
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:88 weight=1</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>    
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>        
    proxy_pass http://webcanteen    
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="åç«¯æœåŠ¡å™¨çŠ¶æ€"><a href="#åç«¯æœåŠ¡å™¨çŠ¶æ€" class="header-anchor">#</a> åç«¯æœåŠ¡å™¨çŠ¶æ€</h3> <p>downï¼šå½“å‰æœåŠ¡å™¨ä¸å‚ä¸è´Ÿè½½å‡è¡¡
backupï¼šå½“å…¶ä»–èŠ‚ç‚¹éƒ½æ— æ³•ä½¿ç”¨æ—¶çš„å¤‡ç”¨æœåŠ¡å™¨
max_failsï¼šå…è®¸è¯·æ±‚å¤±è´¥çš„æ¬¡æ•°ï¼Œè‹¥åˆ°è¾¾å°±ä¼šä¼‘çœ 
fail_timeoutï¼šç»è¿‡ max_fails æ¬¡å¤±è´¥åï¼ŒæœåŠ¡å™¨çš„æš‚åœæ—¶é—´ï¼Œé»˜è®¤ä¸º 10s
max_connsï¼šé™åˆ¶æ¯ä¸ªæœåŠ¡å™¨çš„æœ€å¤§æ¥æ”¶è¿æ¥æ•°</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> webcanteen</span> <span class="token punctuation">{</span> 
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:66 down</span><span class="token punctuation">;</span> 
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:77 backup</span><span class="token punctuation">;</span> 
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:88  max_fails=3 fail_timeout=10s</span><span class="token punctuation">;</span> 
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:99 max_conns=1000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="åˆ†é…æ–¹å¼"><a href="#åˆ†é…æ–¹å¼" class="header-anchor">#</a> åˆ†é…æ–¹å¼</h3> <p>è½®è¯¢ï¼ˆé»˜è®¤ï¼‰ï¼Œæ¯ä¸ªè¯·æ±‚æŒ‰ç…§æ—¶é—´é¡ºåºè½®æµåˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœæŸå°åç«¯æœåŠ¡å™¨å®•æœºï¼ŒNginx è½®è®­åˆ—è¡¨ä¼šè‡ªåŠ¨å°†å®ƒå»é™¤æ‰ï¼›
weightï¼ˆåŠ æƒè½®è¯¢ï¼‰ï¼Œè½®è¯¢çš„åŠ å¼ºç‰ˆï¼Œweight å’Œè®¿é—®å‡ ç‡æˆæ­£æ¯”ï¼Œä¸»è¦ç”¨äºåç«¯æœåŠ¡å™¨æ€§èƒ½ä¸å‡çš„åœºæ™¯ï¼›
ip_hashï¼Œæ¯ä¸ªè¯·æ±‚æŒ‰ç…§è®¿é—® IP çš„ hash ç»“æœåˆ†é…ï¼Œè¿™æ ·æ¯ä¸ªè®¿é—®å¯ä»¥å›ºå®šè®¿é—®ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼›
url_hashï¼ŒæŒ‰ç…§è®¿é—® URL çš„ hash ç»“æœæ¥åˆ†é…è¯·æ±‚ï¼Œä½¿å¾—æ¯ä¸ª URL å®šå‘åˆ°åŒä¸€ä¸ªåç«¯æœåŠ¡å™¨ä¸Šï¼Œä¸»è¦åº”ç”¨äºåç«¯æœåŠ¡å™¨ä¸ºç¼“å­˜æ—¶çš„åœºæ™¯ï¼›
è‡ªå®šä¹‰ hashï¼ŒåŸºäºä»»æ„å…³é”®å­—ä½œä¸º hash key å®ç° hash ç®—æ³•çš„è´Ÿè½½å‡è¡¡ï¼›
fairï¼ŒæŒ‰ç…§åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­åˆ™ä¼˜å…ˆåˆ†é…ã€‚</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/blog/backend/devops/docker.html" class="prev">
        docker
      </a></span> <span class="next"><a href="/blog/backend/db/mysql.html">
        mysql
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.e6f473de.js" defer></script><script src="/blog/assets/js/2.615a92e6.js" defer></script><script src="/blog/assets/js/26.7907dbbb.js" defer></script>
  </body>
</html>
