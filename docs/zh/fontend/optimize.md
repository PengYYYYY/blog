# 性能优化

## 图片性能优化

### JPEG（Joint Photographic Experts Group）

- JPEG是一种针对彩色照片而广泛使用的有损压缩图形格式
- 格栅图形，常用文件拓展名为.jpg，也有.jpeg、.jpe。JPEG在互联网上常用于存储和传输图片。
- 不适合: 线条图形和文字，图标图形，因为其算法不支持这类型的图形，并且不支持透明度。
- 非常合适：颜色丰富的照片，彩色图大焦点图，通栏banner图;结构不规则的图形。

### PNG（Portable Network Graphics）

- 便携式网络图形是一种无损压缩的位图图形格式，支持索引、灰度、RGB三种颜色方案已经Alpha通道特性
- 格栅图形，PNG最初是作为替代GIF来设计的，能够显示256色，文件比JPEG或者GIF大，但是PNG非常好的保留来图像质量，支持Alpha通道的半透明和透明特性，最高支持24位彩色图像（png-24）和8位灰度图像（png-8）
- 不适合：由于是无损存储，彩色图像体积太大，不太适合。
- 适合：纯色，透明，线条绘图，图标;边缘清晰，有大块相同颜色区域；颜色数较少，但需要半透明。

### GIF（Graphics Interchange Format）

- 图像互换格式是一种位图图形文件格式，以8位色（即256种颜色）重现真彩色的图像，采用LZW压缩算法进行编码
- 介绍：格栅图形。支持256色；仅支持完全透明和不透明；如果需要通用动画，GIF是唯一选择。
- 不适合：每个像素只要8比特，不适合存储彩色图片
- 非常适合：动画，图标

### webp

- 现代化的图像格式，可为图像提供有损压缩和无损压缩，使其非常灵活。
- 可以插入多帧，实现动画效果，可以设置透明度，采用8位压缩算法。无损的webp比png小26%，有损的webp比jpeg小25%-34%，比gif有更好的动画。
- 不适合：最多处理256色，不适合于彩色图片。
- 适合：适用于图形和半透明图像。

### 用工具进行图片压缩

- png压缩工具

```bash
yarn add node-pngquant-native
```

跨平台，压缩比高，压缩png24非常好

- jpg压缩工具

```bash
yarn add jpegtran
```

- gif压缩

Gifsicel压缩工具

### 图片尺寸随网络环境变化

不同网络环境下，加载不同尺寸和像素的图片，通过在图片URL后缀加不同参数改变

### 响应式图片

- js绑定事件检测窗口大小
- css媒体查询
- img标签属性

### 逐步加载图像

- 使用统一占位符
- 使用LQIP（低质量图片占位符）,`npm install lqip`
- 使用SQIP（基于SVG的图像占位符），`npm install sqip`

### 图片服务器自动优化解密

图片服务器自动化优化是可以在图片URL链接上增加不同特殊参数，服务器自动化生成。
不同格式，大小，质量的图片

#### 处理方式

图片裁剪：按长边，短边，填充，拉伸等缩放。
图片格式转换：支持JPG,GIF,PNG,WEBP等，支持不同的图片压缩率。
图片处理：添加图片水印，高斯模糊，重心处理，裁剪边框等。
AI能力：鉴黄，智能抠图，智能配色，智能排版，智能合成等AI能力。

## 静态资源

精简静态资源

### 精简HTML代码

- 减少HTML嵌套
- 减少DOM节点
- 减少无语义代码

## Core Web Vitals（新一代的web优化指标）

- `Largest Contentful Paint (LCP)`：衡量加载体验：为了提供良好的用户体验， `LCP` 应该在页面首次开始加载后的 `2.5` 秒内发生
- `First Input Delay (FID)`：衡量可交互性，为了提供良好的用户体验，页面的 `FID` 应当小于 100毫秒。
- `Cumulative Layout Shift (CLS)`：衡量视觉稳定性，为了提供良好的用户体验，页面的CLS应保持小于 0.1。

### LCP较差的最常见原因是

- 服务器响应时间慢
- 阻断渲染的 Javascript 和 CSS
- 资源加载时间慢
- 客户端渲染

### 改善

#### 优化服务器

TTFB首字节相应时间（TTFB）是最初的网络请求被发起到从服务器接收到第一个字节这段时间，它包含了 TCP 连接时间，发送 HTTP 请求时间和获得响应消息第一个字节的时间

- 缓存 HTML 离线页面，缓存页面资源，减少浏览器对资源的请求
- 尽量减小资源阻断渲染：`CSS` 和 `JavaScript` 压缩、合并、级联、内联等等
- 对图片进行优化。转化图片的格式为 `JPG` 或者 `WEBP` 等等的格式，降低图片的大小，以加快请求的速度。
- 对 HTML 重写、压缩空格、去除注释等。减少 `HTML` 大小，加快速度。
- 使用 `preconnect` 尽快与服务器建立链接、使用 `dns-prefetch` 尽快进行 `DNS` 查找。
- 使用 CDN 加快请求速度

#### 优化阻断渲染的资源

`JavaScript` 和 `CSS` 都是会阻断页面渲染的资源，需要尽可能的对 `CSS` 和 `JavaScript` 文件进行压缩、延迟加载首屏无需使用的 JavaScript、内联关键的 CSS 等来减小阻断时间。

#### 优化资源加载时间

影响LCP的因素

- img元素
- image内的svg
- video元素
- 通过 url() 函数加载背景图片的元素
- 包含文本节点或其他内联文本元素子级的块级元素。

优化手段

- 降低资源大小
- 对重要的资源进行预加载
- 使用 Gzip 和 Brotli 压缩页面资源，降低传输时间
- 使用 service worker 缓存资源

#### 服务端渲染

使用服务端渲染可以确保首先在服务器上呈现页面内容，可以有效改善 LCP，但是相比客户端渲染的缺点是会加大页面从而影响 TTFB、服务端渲染需要等待所有 js 执行完毕后才能相应用户输入，这会使交互体验变差。

### FID（First Input Delay）

即记录用户和页面进行首次交互操作所花费的时间 。`FID` 指标影响用户对页面交互性和响应性的第一印象。 为了提供良好的用户体验，站点应努力使首次输入延迟小于 `100` 毫秒。

#### 减少 JavaScript 执行时间

- 缩小并压缩 JavaScript 文件
- 延迟加载首屏不需要的 JavaScript
- 尽量减少未使用的 polyfill

#### 分解耗时任务

任何阻塞主线程 50 毫秒或更长时间的代码段都可以称为“长任务”，我们可以将长的耗时任务拆分为较小的异步任务.

#### 使用 Web Worker

主线程阻塞是输入延迟的主要原因之一。`Web Workers` 可以让你在与主执行线程分离的后台线程上运行 `JavaScript`，这样做的好处是可以在一个单独的线程中执行费时的处理任务，从而允许主（通常是UI）线程运行而不被阻塞。将非 UI 操作移至单独的工作线程可以减少主线程的阻塞时间，从而改善 `FID`

### CLS（Cumulative Layout Shift）

`CLS` 会测量在页面的整个生命周期中发生的每个意外的样式移动的所有单独布局更改得分的总和。布局的移动可能发生在可见元素从一帧到下一帧改变位置的任何时候。为了提供良好的用户体验，网站应努力使 `CLS` 分数小于 0.1

- 永远不要在现有内容之上插入内容，除非是响应用户交互。这确保了预期的布局变化
- 宁可转换动画，也不要转换触发布局变化的属性的动画。以一种提供从一个状态到另一个状态的上下文和连续性的方式动画转换
- 不要使用无尺寸元素

#### 提前给广告位预留空间

很多页面广告都是动态插入的，所以一定要提前为广告位预留一定空间。

#### 警惕字体变化

字体通常是大文件，需要一段时间才能加载，一些浏览器直到下载完字体后才呈现文本
