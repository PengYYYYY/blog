<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端监控 | PengYYY</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Happy Life 🏀,  Working Smooth 💻">
    
    <link rel="preload" href="/blog/assets/css/0.styles.15d78004.css" as="style"><link rel="preload" href="/blog/assets/js/app.e6f473de.js" as="script"><link rel="preload" href="/blog/assets/js/2.615a92e6.js" as="script"><link rel="preload" href="/blog/assets/js/76.10de5c1e.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.2801256c.js"><link rel="prefetch" href="/blog/assets/js/100.2e400952.js"><link rel="prefetch" href="/blog/assets/js/101.590e25a8.js"><link rel="prefetch" href="/blog/assets/js/102.19f7bd0b.js"><link rel="prefetch" href="/blog/assets/js/103.f2e53e80.js"><link rel="prefetch" href="/blog/assets/js/104.1105cee1.js"><link rel="prefetch" href="/blog/assets/js/105.dc657231.js"><link rel="prefetch" href="/blog/assets/js/106.a2d51144.js"><link rel="prefetch" href="/blog/assets/js/107.4219c414.js"><link rel="prefetch" href="/blog/assets/js/108.ea1c71c8.js"><link rel="prefetch" href="/blog/assets/js/109.dce88455.js"><link rel="prefetch" href="/blog/assets/js/11.5c98febd.js"><link rel="prefetch" href="/blog/assets/js/110.3f9916df.js"><link rel="prefetch" href="/blog/assets/js/111.28bde672.js"><link rel="prefetch" href="/blog/assets/js/112.d179a417.js"><link rel="prefetch" href="/blog/assets/js/113.7f077001.js"><link rel="prefetch" href="/blog/assets/js/114.706f747b.js"><link rel="prefetch" href="/blog/assets/js/115.43622622.js"><link rel="prefetch" href="/blog/assets/js/116.6938059a.js"><link rel="prefetch" href="/blog/assets/js/117.87a7785b.js"><link rel="prefetch" href="/blog/assets/js/118.d3a02f88.js"><link rel="prefetch" href="/blog/assets/js/119.391e58af.js"><link rel="prefetch" href="/blog/assets/js/12.dea5f0e5.js"><link rel="prefetch" href="/blog/assets/js/120.cba7cbd4.js"><link rel="prefetch" href="/blog/assets/js/121.c03e7a63.js"><link rel="prefetch" href="/blog/assets/js/122.5e0c0711.js"><link rel="prefetch" href="/blog/assets/js/123.0410bace.js"><link rel="prefetch" href="/blog/assets/js/13.9ed8968b.js"><link rel="prefetch" href="/blog/assets/js/14.0b1a70c0.js"><link rel="prefetch" href="/blog/assets/js/15.8925af36.js"><link rel="prefetch" href="/blog/assets/js/16.c87608d1.js"><link rel="prefetch" href="/blog/assets/js/17.07edf7b8.js"><link rel="prefetch" href="/blog/assets/js/18.87ec1856.js"><link rel="prefetch" href="/blog/assets/js/19.f0ed1f96.js"><link rel="prefetch" href="/blog/assets/js/20.91cc4163.js"><link rel="prefetch" href="/blog/assets/js/21.b7b0fa5d.js"><link rel="prefetch" href="/blog/assets/js/22.3931e563.js"><link rel="prefetch" href="/blog/assets/js/23.8176e093.js"><link rel="prefetch" href="/blog/assets/js/24.38727ada.js"><link rel="prefetch" href="/blog/assets/js/25.61f6f70d.js"><link rel="prefetch" href="/blog/assets/js/26.7907dbbb.js"><link rel="prefetch" href="/blog/assets/js/27.f1af7215.js"><link rel="prefetch" href="/blog/assets/js/28.f51d54bd.js"><link rel="prefetch" href="/blog/assets/js/29.753ac330.js"><link rel="prefetch" href="/blog/assets/js/3.d7834cfe.js"><link rel="prefetch" href="/blog/assets/js/30.2b217e50.js"><link rel="prefetch" href="/blog/assets/js/31.fbd822fb.js"><link rel="prefetch" href="/blog/assets/js/32.2a92b4f5.js"><link rel="prefetch" href="/blog/assets/js/33.5e4449ca.js"><link rel="prefetch" href="/blog/assets/js/34.fb5f1bf7.js"><link rel="prefetch" href="/blog/assets/js/35.5bd53f3e.js"><link rel="prefetch" href="/blog/assets/js/36.e302888b.js"><link rel="prefetch" href="/blog/assets/js/37.ac95653e.js"><link rel="prefetch" href="/blog/assets/js/38.429cb560.js"><link rel="prefetch" href="/blog/assets/js/39.545b355d.js"><link rel="prefetch" href="/blog/assets/js/4.03235a2f.js"><link rel="prefetch" href="/blog/assets/js/40.d08bd8a6.js"><link rel="prefetch" href="/blog/assets/js/41.e9b400ee.js"><link rel="prefetch" href="/blog/assets/js/42.3db059b0.js"><link rel="prefetch" href="/blog/assets/js/43.0a588551.js"><link rel="prefetch" href="/blog/assets/js/44.dbfa7349.js"><link rel="prefetch" href="/blog/assets/js/45.a1c4bf25.js"><link rel="prefetch" href="/blog/assets/js/46.711d144b.js"><link rel="prefetch" href="/blog/assets/js/47.cf9ba86d.js"><link rel="prefetch" href="/blog/assets/js/48.61cd13a7.js"><link rel="prefetch" href="/blog/assets/js/49.2df7b286.js"><link rel="prefetch" href="/blog/assets/js/5.a556b432.js"><link rel="prefetch" href="/blog/assets/js/50.5d9ee899.js"><link rel="prefetch" href="/blog/assets/js/51.24812116.js"><link rel="prefetch" href="/blog/assets/js/52.06419b22.js"><link rel="prefetch" href="/blog/assets/js/53.93f43246.js"><link rel="prefetch" href="/blog/assets/js/54.5c51a3ad.js"><link rel="prefetch" href="/blog/assets/js/55.c5a64763.js"><link rel="prefetch" href="/blog/assets/js/56.32045283.js"><link rel="prefetch" href="/blog/assets/js/57.0934b785.js"><link rel="prefetch" href="/blog/assets/js/58.14242ce5.js"><link rel="prefetch" href="/blog/assets/js/59.c1621902.js"><link rel="prefetch" href="/blog/assets/js/6.0f1039b1.js"><link rel="prefetch" href="/blog/assets/js/60.8ca8af20.js"><link rel="prefetch" href="/blog/assets/js/61.58bf56f4.js"><link rel="prefetch" href="/blog/assets/js/62.f377f50a.js"><link rel="prefetch" href="/blog/assets/js/63.736aadbf.js"><link rel="prefetch" href="/blog/assets/js/64.d3ae2ac6.js"><link rel="prefetch" href="/blog/assets/js/65.9a097331.js"><link rel="prefetch" href="/blog/assets/js/66.76d312c0.js"><link rel="prefetch" href="/blog/assets/js/67.1734a5bd.js"><link rel="prefetch" href="/blog/assets/js/68.6facbfbe.js"><link rel="prefetch" href="/blog/assets/js/69.0b0ba420.js"><link rel="prefetch" href="/blog/assets/js/7.387d883a.js"><link rel="prefetch" href="/blog/assets/js/70.2f232f6d.js"><link rel="prefetch" href="/blog/assets/js/71.c0dc3455.js"><link rel="prefetch" href="/blog/assets/js/72.853b5102.js"><link rel="prefetch" href="/blog/assets/js/73.213c3a58.js"><link rel="prefetch" href="/blog/assets/js/74.edcf6826.js"><link rel="prefetch" href="/blog/assets/js/75.2cb1e219.js"><link rel="prefetch" href="/blog/assets/js/77.3d570e45.js"><link rel="prefetch" href="/blog/assets/js/78.9ee516da.js"><link rel="prefetch" href="/blog/assets/js/79.719b87ef.js"><link rel="prefetch" href="/blog/assets/js/8.afc6d5ca.js"><link rel="prefetch" href="/blog/assets/js/80.f717798f.js"><link rel="prefetch" href="/blog/assets/js/81.942f7986.js"><link rel="prefetch" href="/blog/assets/js/82.46077de0.js"><link rel="prefetch" href="/blog/assets/js/83.1e7399de.js"><link rel="prefetch" href="/blog/assets/js/84.8403292d.js"><link rel="prefetch" href="/blog/assets/js/85.a20cd9b5.js"><link rel="prefetch" href="/blog/assets/js/86.8c7c71e2.js"><link rel="prefetch" href="/blog/assets/js/87.03e27673.js"><link rel="prefetch" href="/blog/assets/js/88.990dbbfb.js"><link rel="prefetch" href="/blog/assets/js/89.217aa324.js"><link rel="prefetch" href="/blog/assets/js/9.0705089f.js"><link rel="prefetch" href="/blog/assets/js/90.f572d84d.js"><link rel="prefetch" href="/blog/assets/js/91.11dd6cc4.js"><link rel="prefetch" href="/blog/assets/js/92.fbcd5c2e.js"><link rel="prefetch" href="/blog/assets/js/93.413301b4.js"><link rel="prefetch" href="/blog/assets/js/94.d212961a.js"><link rel="prefetch" href="/blog/assets/js/95.db22ac2e.js"><link rel="prefetch" href="/blog/assets/js/96.80b39ad2.js"><link rel="prefetch" href="/blog/assets/js/97.f3920b6d.js"><link rel="prefetch" href="/blog/assets/js/98.acc782da.js"><link rel="prefetch" href="/blog/assets/js/99.58988589.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.15d78004.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">PengYYY</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/fontend/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/blog/backend/" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/blog/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/blog/conclusion/" class="nav-link">
  总结
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/fontend/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/blog/backend/" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/blog/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/blog/conclusion/" class="nav-link">
  总结
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架对比</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>工程化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/fontend/engineering/webpackBase.html" class="sidebar-link">webpack</a></li><li><a href="/blog/fontend/engineering/webpackAdvance.html" class="sidebar-link">webpack进阶</a></li><li><a href="/blog/fontend/engineering/npm.html" class="sidebar-link">包管理</a></li><li><a href="/blog/fontend/engineering/modular.html" class="sidebar-link">模块化</a></li><li><a href="/blog/fontend/engineering/babel.html" class="sidebar-link">babel</a></li><li><a href="/blog/fontend/engineering/monitoring.html" aria-current="page" class="active sidebar-link">前端监控</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/fontend/engineering/monitoring.html#数据采集" class="sidebar-link">数据采集</a></li><li class="sidebar-sub-header"><a href="/blog/fontend/engineering/monitoring.html#日志上报" class="sidebar-link">日志上报</a></li><li class="sidebar-sub-header"><a href="/blog/fontend/engineering/monitoring.html#sendbeacon" class="sidebar-link">sendBeacon</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML &amp;&amp; CSS</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="前端监控"><a href="#前端监控" class="header-anchor">#</a> 前端监控</h1> <h2 id="数据采集"><a href="#数据采集" class="header-anchor">#</a> 数据采集</h2> <p>首先需要确认监控的数据来源</p> <h3 id="性能数据采集"><a href="#性能数据采集" class="header-anchor">#</a> 性能数据采集</h3> <p>性能数据采集需要使用 <code>window.performance</code> API。</p> <p>使用  <code>window.performance.timing</code> 可以采集到各个阶段的起始及结束时间。</p> <p><img src="https://gitee.com/PENG_YUE/myImg/raw/master/uPic/eT4hDH.png" alt="img"></p> <ul><li>各个阶段的定义</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>timing<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// 同一个浏览器上一个页面卸载(unload)结束时的时间戳。如果没有上一个页面，这个值会和fetchStart相同。</span>
  navigationStart<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

  <span class="token comment">// 上一个页面unload事件抛出时的时间戳。如果没有上一个页面，这个值会返回0。</span>
  unloadEventStart<span class="token operator">:</span> <span class="token number">1543806782523</span><span class="token punctuation">,</span>

  <span class="token comment">// 和 unloadEventStart 相对应，unload事件处理完成时的时间戳。如果没有上一个页面,这个值会返回0。</span>
  unloadEventEnd<span class="token operator">:</span> <span class="token number">1543806782523</span><span class="token punctuation">,</span>

  <span class="token comment">// 第一个HTTP重定向开始时的时间戳。如果没有重定向，或者重定向中的一个不同源，这个值会返回0。</span>
  redirectStart<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>

  <span class="token comment">// 最后一个HTTP重定向完成时（也就是说是HTTP响应的最后一个比特直接被收到的时间）的时间戳。</span>
  <span class="token comment">// 如果没有重定向，或者重定向中的一个不同源，这个值会返回0. </span>
  redirectEnd<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>

  <span class="token comment">// 浏览器准备好使用HTTP请求来获取(fetch)文档的时间戳。这个时间点会在检查任何应用缓存之前。</span>
  fetchStart<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

  <span class="token comment">// DNS 域名查询开始的UNIX时间戳。</span>
  <span class="token comment">//如果使用了持续连接(persistent connection)，或者这个信息存储到了缓存或者本地资源上，这个值将和fetchStart一致。</span>
  domainLookupStart<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

  <span class="token comment">// DNS 域名查询完成的时间.</span>
  <span class="token comment">//如果使用了本地缓存（即无 DNS 查询）或持久连接，则与 fetchStart 值相等</span>
  domainLookupEnd<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

  <span class="token comment">// HTTP（TCP） 域名查询结束的时间戳。</span>
  <span class="token comment">//如果使用了持续连接(persistent connection)，或者这个信息存储到了缓存或者本地资源上，这个值将和 fetchStart一致。</span>
  connectStart<span class="token operator">:</span> <span class="token number">1543806782099</span><span class="token punctuation">,</span>

  <span class="token comment">// HTTP（TCP） 返回浏览器与服务器之间的连接建立时的时间戳。</span>
  <span class="token comment">// 如果建立的是持久连接，则返回值等同于fetchStart属性的值。连接建立指的是所有握手和认证过程全部结束。</span>
  connectEnd<span class="token operator">:</span> <span class="token number">1543806782227</span><span class="token punctuation">,</span>

  <span class="token comment">// HTTPS 返回浏览器与服务器开始安全链接的握手时的时间戳。如果当前网页不要求安全连接，则返回0。</span>
  secureConnectionStart<span class="token operator">:</span> <span class="token number">1543806782162</span><span class="token punctuation">,</span>

  <span class="token comment">// 返回浏览器向服务器发出HTTP请求时（或开始读取本地缓存时）的时间戳。</span>
  requestStart<span class="token operator">:</span> <span class="token number">1543806782241</span><span class="token punctuation">,</span>

  <span class="token comment">// 返回浏览器从服务器收到（或从本地缓存读取）第一个字节时的时间戳。</span>
  <span class="token comment">//如果传输层在开始请求之后失败并且连接被重开，该属性将会被数制成新的请求的相对应的发起时间。</span>
  responseStart<span class="token operator">:</span> <span class="token number">1543806782516</span><span class="token punctuation">,</span>

  <span class="token comment">// 返回浏览器从服务器收到（或从本地缓存读取，或从本地资源读取）最后一个字节时</span>
  <span class="token comment">//（如果在此之前HTTP连接已经关闭，则返回关闭时）的时间戳。</span>
  responseEnd<span class="token operator">:</span> <span class="token number">1543806782537</span><span class="token punctuation">,</span>

  <span class="token comment">// 当前网页DOM结构开始解析时（即Document.readyState属性变为“loading”、相应的 readystatechange事件触发时）的时间戳。</span>
  domLoading<span class="token operator">:</span> <span class="token number">1543806782573</span><span class="token punctuation">,</span>

  <span class="token comment">// 当前网页DOM结构结束解析、开始加载内嵌资源时（即Document.readyState属性变为“interactive”、相应的readystatechange事件触发时）的时间戳。</span>
  domInteractive<span class="token operator">:</span> <span class="token number">1543806783203</span><span class="token punctuation">,</span>

  <span class="token comment">// 当解析器发送DOMContentLoaded 事件，即所有需要被执行的脚本已经被解析时的时间戳。</span>
  domContentLoadedEventStart<span class="token operator">:</span> <span class="token number">1543806783203</span><span class="token punctuation">,</span>

  <span class="token comment">// 当所有需要立即执行的脚本已经被执行（不论执行顺序）时的时间戳。</span>
  domContentLoadedEventEnd<span class="token operator">:</span> <span class="token number">1543806783216</span><span class="token punctuation">,</span>

  <span class="token comment">// 当前文档解析完成，即Document.readyState 变为 'complete'且相对应的readystatechange 被触发时的时间戳</span>
  domComplete<span class="token operator">:</span> <span class="token number">1543806783796</span><span class="token punctuation">,</span>

  <span class="token comment">// load事件被发送时的时间戳。如果这个事件还未被发送，它的值将会是0。</span>
  loadEventStart<span class="token operator">:</span> <span class="token number">1543806783796</span><span class="token punctuation">,</span>

  <span class="token comment">// 当load事件结束，即加载事件完成时的时间戳。如果这个事件还未被发送，或者尚未完成，它的值将会是0.</span>
  loadEventEnd<span class="token operator">:</span> <span class="token number">1543806783802</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><h3 id="错误数据采集"><a href="#错误数据采集" class="header-anchor">#</a> 错误数据采集</h3> <ul><li>资源加载错误</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> monitor <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>js 执行错误</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>promise 错误</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unhandledrejection'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    monitor<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'promise'</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>reason <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>reason<span class="token punctuation">.</span>msg<span class="token punctuation">)</span> <span class="token operator">||</span> e<span class="token punctuation">.</span>reason <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token comment">// 错误发生的时间</span>
        time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>script error</li></ul> <p>script error不是一种具体的错误，而是浏览器对跨域错误出于安全机制考虑对一种处理方式</p> <ul><li>try...catch</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'project'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>AJAX请求异常</li></ul> <blockquote><p>方法一</p></blockquote> <p>window.addEventListener, 监控AJAX失败请求</p> <blockquote><p>方法二</p></blockquote> <p>重写XMLHttpRequest, 监控所有AJAX请求</p> <ul><li>UV/PV</li></ul> <p>PVUV日志采集相对简单，关键点在于采集时机，通常选择在head执行或者onload事件回调，从前端监控的角度我们通常选择 onload 时机；另外，需要考虑SPA页面的支持。</p> <ul><li>其他</li></ul> <p>除了上述指标日志的采集，通常我们还会上报更多的环境信息，有利于更快速的定位问题。具体字段有 网络环境，设备型号，操作系统版本，客户端版本，前端版本，API接口版本等。</p> <h2 id="日志上报"><a href="#日志上报" class="header-anchor">#</a> 日志上报</h2> <p>最简单粗暴的做法可能是直接写一个AJAX请求上报，但这种方式成功率不稳定，极易在页面切换时丢失日志；
并且，对于大流量站点还需要考虑 带宽节流等诉求。完整考虑，一个相对完善的上报逻辑需要包括 数据过滤、采样、合并以及加密压缩等大量细节设计。</p> <p>处理方法：</p> <ul><li>过滤：按需过滤和截断，如果有多个业务方使用，考虑提供回调函数给调用分放。</li> <li>采样：通过<code>Math.radom()</code>方法，对命中采样率对数据上报</li> <li>合并：维护前端请求队列，进行定时上报</li> <li>上报请求：通过AJAX，img等方式容易丢失日志，结合sendbeacon简洁、异步、非阻塞，可以使用sendbeacon向下兼容。</li> <li>数据压缩</li> <li>网络请求协议：加https</li></ul> <h2 id="sendbeacon"><a href="#sendbeacon" class="header-anchor">#</a> sendBeacon</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code>navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>url: url 参数表明 data 将要被发送到的网络地址。</li> <li>data: 数据</li></ul> <h3 id="描述"><a href="#描述" class="header-anchor">#</a> 描述</h3> <p>这个方法主要用于满足统计和诊断代码的需要，这些代码通常尝试在卸载（<code>unload</code>）文档之前向web服务器发送数据。过早的发送数据可能导致错过收集数据的机会。然而，对于开发者来说保证在文档卸载期间发送数据一直是一个困难。</p> <p>为了解决这个问题， 统计和诊断代码通常要在 <code>unload</code> 或者 <code>beforeunload</code> (en-US) 事件处理器中发起一个同步 <code>XMLHttpRequest</code> 来发送数据。同步的 <code>XMLHttpRequest</code> 迫使用户代理延迟卸载文档，并使得下一个导航出现的更晚。</p> <p>有一些技术被用来保证数据的发送。其中一种是通过在卸载事件处理器中创建一个图片元素并设置它的 src 属性的方法来延迟卸载以保证数据的发送。因为绝大多数用户代理会延迟卸载以保证图片的载入，所以数据可以在卸载事件中发送。另一种技术是通过创建一个几秒钟的 no-op 循环来延迟卸载并向服务器发送数据。</p> <p>在卸载事件处理器中尝试通过一个同步的 XMLHttpRequest 向服务器发送数据。这导致了页面卸载被延迟。</p> <p>使用 sendBeacon() 方法会使用户代理在有机会时异步地向服务器发送数据，同时不会延迟页面的卸载或影响下一导航的载入性能。这就解决了提交分析数据时的所有的问题：数据可靠，传输异步并且不会影响下一页面的加载。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unload'</span><span class="token punctuation">,</span> logData<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">logData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token string">&quot;/log&quot;</span><span class="token punctuation">,</span> analyticsData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><a href="https://zhuanlan.zhihu.com/p/82981365" target="_blank" rel="noopener noreferrer">10分钟彻底搞懂前端页面性能监控<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/fontend/engineering/babel.html" class="prev">
        babel
      </a></span> <span class="next"><a href="/blog/fontend/optimize/overview.html">
        概览
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.e6f473de.js" defer></script><script src="/blog/assets/js/2.615a92e6.js" defer></script><script src="/blog/assets/js/76.10de5c1e.js" defer></script>
  </body>
</html>
