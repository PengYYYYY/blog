<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mysql | Super-YUE Blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="日常学习和技术积累">
    <link rel="preload" href="/my-blog/assets/css/0.styles.a70fa01a.css" as="style"><link rel="preload" href="/my-blog/assets/js/app.68e31997.js" as="script"><link rel="preload" href="/my-blog/assets/js/2.c20646db.js" as="script"><link rel="preload" href="/my-blog/assets/js/60.02994d47.js" as="script"><link rel="prefetch" href="/my-blog/assets/js/10.52811631.js"><link rel="prefetch" href="/my-blog/assets/js/100.278077e0.js"><link rel="prefetch" href="/my-blog/assets/js/101.b9469f8a.js"><link rel="prefetch" href="/my-blog/assets/js/102.90581d97.js"><link rel="prefetch" href="/my-blog/assets/js/103.ab7f1b36.js"><link rel="prefetch" href="/my-blog/assets/js/104.1c1d4805.js"><link rel="prefetch" href="/my-blog/assets/js/105.56bb8764.js"><link rel="prefetch" href="/my-blog/assets/js/106.8f5a4856.js"><link rel="prefetch" href="/my-blog/assets/js/107.fd113611.js"><link rel="prefetch" href="/my-blog/assets/js/108.dd4b3c84.js"><link rel="prefetch" href="/my-blog/assets/js/109.44393c31.js"><link rel="prefetch" href="/my-blog/assets/js/11.e751ad22.js"><link rel="prefetch" href="/my-blog/assets/js/110.5f9edb31.js"><link rel="prefetch" href="/my-blog/assets/js/111.51aa825f.js"><link rel="prefetch" href="/my-blog/assets/js/112.0a3aac9a.js"><link rel="prefetch" href="/my-blog/assets/js/113.be324074.js"><link rel="prefetch" href="/my-blog/assets/js/114.f65b0835.js"><link rel="prefetch" href="/my-blog/assets/js/115.dc9fbd90.js"><link rel="prefetch" href="/my-blog/assets/js/116.225295f8.js"><link rel="prefetch" href="/my-blog/assets/js/117.996e03ed.js"><link rel="prefetch" href="/my-blog/assets/js/118.866383c4.js"><link rel="prefetch" href="/my-blog/assets/js/119.4d123213.js"><link rel="prefetch" href="/my-blog/assets/js/12.0400ff5a.js"><link rel="prefetch" href="/my-blog/assets/js/120.7d809b9b.js"><link rel="prefetch" href="/my-blog/assets/js/121.7f2da05f.js"><link rel="prefetch" href="/my-blog/assets/js/122.09e05a8a.js"><link rel="prefetch" href="/my-blog/assets/js/123.cddeedda.js"><link rel="prefetch" href="/my-blog/assets/js/124.59ab2e0a.js"><link rel="prefetch" href="/my-blog/assets/js/125.9d241899.js"><link rel="prefetch" href="/my-blog/assets/js/126.24db340e.js"><link rel="prefetch" href="/my-blog/assets/js/127.dafdbcfc.js"><link rel="prefetch" href="/my-blog/assets/js/128.20b7f4cd.js"><link rel="prefetch" href="/my-blog/assets/js/129.7c7ae113.js"><link rel="prefetch" href="/my-blog/assets/js/13.2a931ddf.js"><link rel="prefetch" href="/my-blog/assets/js/130.f37c3a38.js"><link rel="prefetch" href="/my-blog/assets/js/131.205d6255.js"><link rel="prefetch" href="/my-blog/assets/js/132.3babc2f7.js"><link rel="prefetch" href="/my-blog/assets/js/133.70dff89c.js"><link rel="prefetch" href="/my-blog/assets/js/14.e8f09f17.js"><link rel="prefetch" href="/my-blog/assets/js/15.8d96ba11.js"><link rel="prefetch" href="/my-blog/assets/js/16.9fa47495.js"><link rel="prefetch" href="/my-blog/assets/js/17.a14d223c.js"><link rel="prefetch" href="/my-blog/assets/js/18.dc9ab091.js"><link rel="prefetch" href="/my-blog/assets/js/19.e4fd3365.js"><link rel="prefetch" href="/my-blog/assets/js/20.2705c997.js"><link rel="prefetch" href="/my-blog/assets/js/21.b7ac9ffe.js"><link rel="prefetch" href="/my-blog/assets/js/22.7e9e70d4.js"><link rel="prefetch" href="/my-blog/assets/js/23.0904080b.js"><link rel="prefetch" href="/my-blog/assets/js/24.34fcef1c.js"><link rel="prefetch" href="/my-blog/assets/js/25.966d0014.js"><link rel="prefetch" href="/my-blog/assets/js/26.16966ceb.js"><link rel="prefetch" href="/my-blog/assets/js/27.b9f8f4f4.js"><link rel="prefetch" href="/my-blog/assets/js/28.ac9cf494.js"><link rel="prefetch" href="/my-blog/assets/js/29.0e57eeee.js"><link rel="prefetch" href="/my-blog/assets/js/3.fb5d808e.js"><link rel="prefetch" href="/my-blog/assets/js/30.49ce2aa8.js"><link rel="prefetch" href="/my-blog/assets/js/31.6efaa5ab.js"><link rel="prefetch" href="/my-blog/assets/js/32.67da77e1.js"><link rel="prefetch" href="/my-blog/assets/js/33.6bef488e.js"><link rel="prefetch" href="/my-blog/assets/js/34.352f7b56.js"><link rel="prefetch" href="/my-blog/assets/js/35.5e84ca31.js"><link rel="prefetch" href="/my-blog/assets/js/36.8e776856.js"><link rel="prefetch" href="/my-blog/assets/js/37.8e2f1c56.js"><link rel="prefetch" href="/my-blog/assets/js/38.50764a51.js"><link rel="prefetch" href="/my-blog/assets/js/39.de4ff313.js"><link rel="prefetch" href="/my-blog/assets/js/4.9bf11b2d.js"><link rel="prefetch" href="/my-blog/assets/js/40.5a5ead7a.js"><link rel="prefetch" href="/my-blog/assets/js/41.e974048a.js"><link rel="prefetch" href="/my-blog/assets/js/42.4b7db7a0.js"><link rel="prefetch" href="/my-blog/assets/js/43.dd9f06a4.js"><link rel="prefetch" href="/my-blog/assets/js/44.f2dd322a.js"><link rel="prefetch" href="/my-blog/assets/js/45.d0e62e8c.js"><link rel="prefetch" href="/my-blog/assets/js/46.9f546151.js"><link rel="prefetch" href="/my-blog/assets/js/47.d16d23a6.js"><link rel="prefetch" href="/my-blog/assets/js/48.bbc21311.js"><link rel="prefetch" href="/my-blog/assets/js/49.4c9a1439.js"><link rel="prefetch" href="/my-blog/assets/js/5.83e5464d.js"><link rel="prefetch" href="/my-blog/assets/js/50.c3e9a09f.js"><link rel="prefetch" href="/my-blog/assets/js/51.56e29e1d.js"><link rel="prefetch" href="/my-blog/assets/js/52.3a6df694.js"><link rel="prefetch" href="/my-blog/assets/js/53.a0b28f9b.js"><link rel="prefetch" href="/my-blog/assets/js/54.e2f6ae46.js"><link rel="prefetch" href="/my-blog/assets/js/55.5f07e4aa.js"><link rel="prefetch" href="/my-blog/assets/js/56.85dbb573.js"><link rel="prefetch" href="/my-blog/assets/js/57.b897f1f0.js"><link rel="prefetch" href="/my-blog/assets/js/58.ff4816f6.js"><link rel="prefetch" href="/my-blog/assets/js/59.1e1f0a03.js"><link rel="prefetch" href="/my-blog/assets/js/6.6606f5bf.js"><link rel="prefetch" href="/my-blog/assets/js/61.efa3df43.js"><link rel="prefetch" href="/my-blog/assets/js/62.00adcc57.js"><link rel="prefetch" href="/my-blog/assets/js/63.1768a94c.js"><link rel="prefetch" href="/my-blog/assets/js/64.de78d68e.js"><link rel="prefetch" href="/my-blog/assets/js/65.2d20a7bb.js"><link rel="prefetch" href="/my-blog/assets/js/66.54135e74.js"><link rel="prefetch" href="/my-blog/assets/js/67.16620b2d.js"><link rel="prefetch" href="/my-blog/assets/js/68.bdda48ff.js"><link rel="prefetch" href="/my-blog/assets/js/69.a8885a2c.js"><link rel="prefetch" href="/my-blog/assets/js/7.c24d302d.js"><link rel="prefetch" href="/my-blog/assets/js/70.2111e96a.js"><link rel="prefetch" href="/my-blog/assets/js/71.8b22ed02.js"><link rel="prefetch" href="/my-blog/assets/js/72.f4f1eab6.js"><link rel="prefetch" href="/my-blog/assets/js/73.ddb8a35c.js"><link rel="prefetch" href="/my-blog/assets/js/74.d14fa93b.js"><link rel="prefetch" href="/my-blog/assets/js/75.efd8d645.js"><link rel="prefetch" href="/my-blog/assets/js/76.8f7c6419.js"><link rel="prefetch" href="/my-blog/assets/js/77.438fbb4f.js"><link rel="prefetch" href="/my-blog/assets/js/78.78eabd48.js"><link rel="prefetch" href="/my-blog/assets/js/79.f6dbe850.js"><link rel="prefetch" href="/my-blog/assets/js/8.054b3948.js"><link rel="prefetch" href="/my-blog/assets/js/80.d62f664e.js"><link rel="prefetch" href="/my-blog/assets/js/81.1d956933.js"><link rel="prefetch" href="/my-blog/assets/js/82.8c60dc1b.js"><link rel="prefetch" href="/my-blog/assets/js/83.d23aff92.js"><link rel="prefetch" href="/my-blog/assets/js/84.fb65bc21.js"><link rel="prefetch" href="/my-blog/assets/js/85.7521ce15.js"><link rel="prefetch" href="/my-blog/assets/js/86.d0eae19f.js"><link rel="prefetch" href="/my-blog/assets/js/87.d2fcac60.js"><link rel="prefetch" href="/my-blog/assets/js/88.07ecfee8.js"><link rel="prefetch" href="/my-blog/assets/js/89.c20eb426.js"><link rel="prefetch" href="/my-blog/assets/js/9.4cd1edf4.js"><link rel="prefetch" href="/my-blog/assets/js/90.14a18fbe.js"><link rel="prefetch" href="/my-blog/assets/js/91.adc68fdd.js"><link rel="prefetch" href="/my-blog/assets/js/92.8dd52840.js"><link rel="prefetch" href="/my-blog/assets/js/93.a9edd5c6.js"><link rel="prefetch" href="/my-blog/assets/js/94.3700049e.js"><link rel="prefetch" href="/my-blog/assets/js/95.2839d5eb.js"><link rel="prefetch" href="/my-blog/assets/js/96.48f53911.js"><link rel="prefetch" href="/my-blog/assets/js/97.3fd71a9f.js"><link rel="prefetch" href="/my-blog/assets/js/98.69caf868.js"><link rel="prefetch" href="/my-blog/assets/js/99.f0cab62d.js">
    <link rel="stylesheet" href="/my-blog/assets/css/0.styles.a70fa01a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-blog/" class="home-link router-link-active"><!----> <span class="site-name">Super-YUE Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-blog/zh/fontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/my-blog/zh/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/my-blog/zh/backend/" class="nav-link router-link-active">
  后端
</a></div><div class="nav-item"><a href="/my-blog/zh/articles/" class="nav-link">
  文章
</a></div><div class="nav-item"><a href="/my-blog/zh/network/" class="nav-link">
  网络
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/my-blog/zh/fontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/my-blog/zh/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/my-blog/zh/backend/" class="nav-link router-link-active">
  后端
</a></div><div class="nav-item"><a href="/my-blog/zh/articles/" class="nav-link">
  文章
</a></div><div class="nav-item"><a href="/my-blog/zh/network/" class="nav-link">
  网络
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>devops</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>db</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-blog/zh/backend/db/mysql.html" aria-current="page" class="active sidebar-link">mysql</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/zh/backend/db/mysql.html#mysql的安装与基本配置" class="sidebar-link">mysql的安装与基本配置</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/backend/db/mysql.html#数据源处理" class="sidebar-link">数据源处理</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/backend/db/mysql.html#mysql-分库分表" class="sidebar-link">MySql 分库分表</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/backend/db/mysql.html#数据库架构" class="sidebar-link">数据库架构</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/backend/db/mysql.html#一致性解决方案" class="sidebar-link">一致性解决方案</a></li></ul></li><li><a href="/my-blog/zh/backend/db/redis.html" class="sidebar-link">redis</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mysql"><a href="#mysql" class="header-anchor">#</a> mysql</h1> <h2 id="mysql的安装与基本配置"><a href="#mysql的安装与基本配置" class="header-anchor">#</a> mysql的安装与基本配置</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>// 检查是否已经安装过mysql，执行命令
<span class="token function">rpm</span> -qa <span class="token operator">|</span> <span class="token function">grep</span> mysql

// 查询所有Mysql对应的文件夹
<span class="token function">whereis</span> mysql
<span class="token function">find</span> / -name mysql

//检查mysql用户组和用户是否存在，如果没有，则创建
<span class="token function">cat</span> /etc/group <span class="token operator">|</span> <span class="token function">grep</span> mysql
<span class="token function">cat</span> /etc/passwd <span class="token operator">|</span><span class="token function">grep</span> mysql
<span class="token function">groupadd</span> mysql

//下载并安装MySQL官方的 Yum Repository
<span class="token function">wget</span> -i -c http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm

//yum安装
yum -y <span class="token function">install</span> mysql57-community-release-el7-10.noarch.rpm

//开始安装MySQL服务器
yum -y <span class="token function">install</span> mysql-community-server

// 启动mysql
systemctl start  mysqld.service
// 查看mysql状态
systemctl status mysqld.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="用户设置"><a href="#用户设置" class="header-anchor">#</a> 用户设置</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>// 找到密码
<span class="token function">grep</span> <span class="token string">&quot;password&quot;</span> /var/log/mysqld.log
// 登陆
mysql -uroot -p
//设置密码等级
<span class="token builtin class-name">set</span> global <span class="token assign-left variable">validate_password_policy</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token builtin class-name">set</span> global <span class="token assign-left variable">validate_password_length</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
//替换临时密码
ALTER <span class="token environment constant">USER</span> <span class="token environment constant">USER</span><span class="token punctuation">(</span><span class="token punctuation">)</span> IDENTIFIED BY <span class="token string">'pengyue'</span>
//新建用户
CREATE <span class="token environment constant">USER</span> <span class="token string">'用户名'</span>@<span class="token string">'连接主机(%为全部)'</span> IDENTIFIED BY <span class="token string">'密码'</span><span class="token punctuation">;</span>
//设置权限
GRANT ALL ON *.* TO <span class="token string">'用户名'</span>@<span class="token string">'连接主机(%为全部)'</span><span class="token punctuation">;</span>
GRANT SELECT, INSERT ON test.user TO <span class="token string">'用户名'</span>@<span class="token string">'连接主机(%为全部)'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="常见问题"><a href="#常见问题" class="header-anchor">#</a> 常见问题</h3> <h3 id="无法连接（2003）"><a href="#无法连接（2003）" class="header-anchor">#</a> 无法连接（2003）</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>firewall-cmd --state  查看防火墙状态

firewall-cmd --list-ports 查看放行端口

firewall-cmd --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">3306</span>/tcp --permanent 放行某端口

systemctl restart firewalld.service    重启防火墙服务

systemctl stop firewalld.service 关闭防火墙服务
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="数据库备份"><a href="#数据库备份" class="header-anchor">#</a> 数据库备份</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>mysqldump -uroot -p<span class="token string">'xxxx'</span> DBName <span class="token operator">&gt;</span> directory/filename.sql
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="数据源处理"><a href="#数据源处理" class="header-anchor">#</a> 数据源处理</h2> <ul><li>热数据:3个月内的订单数据，查询实时性较高;</li> <li>冷数据A:3个月 ~ 12个月前的订单数据，查询频率不高;</li> <li>冷数据B:1年前的订单数据，几乎不会查询，只有偶尔的查询需求;</li></ul> <p>因为根据实际场景需求，用户基本不会去查看1年前的数据，如果将这部分数据还存储在db中，那么成本会非常高，而且也不便于维护。另外如果真遇到有个别用户需要查看1年前的订单信息，可以让用户走离线数据查看。</p> <h2 id="mysql-分库分表"><a href="#mysql-分库分表" class="header-anchor">#</a> MySql 分库分表</h2> <h3 id="分库"><a href="#分库" class="header-anchor">#</a> 分库</h3> <h4 id="垂直分库"><a href="#垂直分库" class="header-anchor">#</a> 垂直分库</h4> <p>随着业务系统的扩大，系统匾额越来越复杂，越来越难以维护，开发效率变得越来越低，并且对资源的消耗也变得越来越大，通过硬件提高系统性能的成本会变得更高。可以进行分库，将所有业务都放在一个库中已经变得越来越难以维护，因此可以将不同业务放在不同的库中。</p> <blockquote><p>不分库</p></blockquote> <p>总库: a表，b表，c表</p> <blockquote><p>分库</p></blockquote> <p>a库：a表，b库：b表，c库：c表</p> <h4 id="水平分库"><a href="#水平分库" class="header-anchor">#</a> 水平分库</h4> <p>水平分库是把同一个表的数据按一定规则拆到不同的数据库中，每个库可以放在不同的服务器上。</p> <p>当数据量过大的时候，且无法做垂直分库的时候，将同一个库的数据分散到不同的库里面。例如：1-10000放A库，10000-20000放B库。</p> <p>垂直分库是把不同表拆到不同数据库中，它是对数据行的拆分，不影响表结构。</p> <p>它带来的提升是：</p> <ul><li>解决了单库大数据，高并发的性能瓶颈。</li> <li>提高了系统的稳定性及可用性。</li></ul> <h3 id="分表"><a href="#分表" class="header-anchor">#</a> 分表</h3> <h4 id="垂直分表"><a href="#垂直分表" class="header-anchor">#</a> 垂直分表</h4> <p>将一个表按照字段分成多表，每个表存储其中一部分字段</p> <p>垂直分表就是将一张表拆分为多两张表，如商品表：商品访问频次低的话，单独存放到一张表中。商品访问频次高的字段单独存放到一张表中。</p> <blockquote><p>带来的提升</p></blockquote> <ul><li>为了避免IO争抢并减少锁表的几率，查看详情的用户与商品信息浏览互不影响</li> <li>充分发挥热门数据的操作效率，商品信息的操作的高效率不会被商品描述的低效率所拖累。</li></ul> <p>为什么大字段IO效率低：第一是由于数据量本身大，需要更长的读取时间；第二是跨页，页是数据库存储单位，很多查找及定位操作都是以页为单位，单页内的数据行越多数据库整体性能越好，而大字段占用空间大，单页内存储行数少，因此IO效率较低。第三，数据库以行为单位将数据加载到内存中，这样表中字段长度较短且访问频率较高，内存能加载更多的数据，命中率更高，减少了磁盘IO，从而提升了数据库性能。（内存分页）</p> <p>拆分准则：</p> <ol><li>把不常用的字段单独放在一张表;</li> <li>把text，blob等大字段拆分出来放在附表中;</li> <li>经常组合查询的列放在一张表中;</li></ol> <h4 id="水平分表"><a href="#水平分表" class="header-anchor">#</a> 水平分表</h4> <p>将一张表分为多张表，假设一张表里面放1000条数据，</p> <p>使用主键作为唯一标识,<code>primaryKey % 1000</code>，主键取模可以确定在哪一张表里面。</p> <p>数据库分表能够解决单表数据量很大的时候数据查询的效率问题，但是无法给数据库的并发操作带来效率上的提高，因为分表的实质还是在一个数据库上进行的操作，很容易受数据库IO性能的限制。将数据进行分库操作可以很好地解决单台数据库的性能问题。分库策略与分表策略的实现很相似，最简单的都是可以通过取模的方式进行路由。</p> <h2 id="数据库架构"><a href="#数据库架构" class="header-anchor">#</a> 数据库架构</h2> <p>数据库架构原则：</p> <ul><li>高可用</li> <li>高性能</li> <li>一致性</li> <li>拓展性</li></ul> <h3 id="主备架构"><a href="#主备架构" class="header-anchor">#</a> 主备架构</h3> <p><img src="https://gitee.com/PENG_YUE/myImg/raw/master/uPic/F2xnjq.png" alt="img"></p> <p>只有主库提供读写服务，备库冗余作故障转移用</p> <ul><li>高可用：主库挂了会自动切换到备库。</li> <li>高性能分析：读写都操作主库，很容易产生瓶颈，大部分互联网应用读多写少，读会先成为瓶颈，进而影响写性能。另外，备库只是单纯的备份，资源利用率50%。</li> <li>一致性：读写都操作主库，不存在数据一致性问题</li> <li>扩展性：无法通过加从库来扩展读性能，进而提高整体性能</li> <li>可落地性：两点影响落地使用。第一，性能一般，这点可以通过建立高效的索引和引入缓存来增加读性能，进而提高性能。第二，扩展性差，这点可以通过分库分表来扩展。</li></ul> <h3 id="双主架构"><a href="#双主架构" class="header-anchor">#</a> 双主架构</h3> <p><img src="https://gitee.com/PENG_YUE/myImg/raw/master/uPic/wFmpwu.png" alt="img"></p> <p>两个主库同时提供服务，负载均衡</p> <ul><li>高可用：一个主库挂了，不影响另一台主库提供服务，这个过程对业务层是透明的，无需修改代码或配置。</li> <li>高性能分析：读写性能相比于方案一都得到提升，提升一倍。</li> <li>一致性分析：存在数据一致性问题。</li> <li>扩展性分析：可以扩展成三主循环。</li> <li>可落地分析：第一，数据一致性问题，一致性解决方案可解决问题。第二，主键冲突问题，ID统一地由分布式ID生成服务来生成可解决问题。</li></ul> <h3 id="主从架构"><a href="#主从架构" class="header-anchor">#</a> 主从架构</h3> <p><img src="https://gitee.com/PENG_YUE/myImg/raw/master/uPic/y4ju8Y.png" alt="img"></p> <p>一主多从，读写分离</p> <ul><li>高可用：主库单点，从库高可用。一旦主库挂了，写服务也就无法提供。</li> <li>高性能设计：大部分互联网应用读多写少，读会先成为瓶颈，</li> <li>一致性分析：存在数据一致性问题</li> <li>扩展性分析：可以通过加从库来扩展读性能，进而提高整体性能。</li> <li>可落地分析：第一，数据一致性问题，一致性解决方案可解决问题。第二，主库单点问题，笔者暂时没想到很好的解决方案。</li></ul> <h3 id="双主双从架构"><a href="#双主双从架构" class="header-anchor">#</a> 双主双从架构</h3> <p><img src="https://gitee.com/PENG_YUE/myImg/raw/master/uPic/IB13D5.png" alt="img"></p> <ul><li>高可用分析：高可用。</li> <li>高性能分析：高性能。</li> <li>一致性分析： 存在数据一致性问题。</li> <li>扩展性分析：可以通过加从库来扩展读性能，进而提高整体性能</li></ul> <h2 id="一致性解决方案"><a href="#一致性解决方案" class="header-anchor">#</a> 一致性解决方案</h2> <h3 id="主从数据一致性问题"><a href="#主从数据一致性问题" class="header-anchor">#</a> 主从数据一致性问题</h3> <p>数据不一致性产生的原因：</p> <p>数据同步（从库从主库拉取binlog日志，再执行一遍）是需要时间的，这个同步时间内主库和从库的数据会存在不一致的情况。如果同步过程中有读请求，那么读到的就是从库中的老数据。
<img src="https://gitee.com/PENG_YUE/myImg/raw/master/uPic/I4vkpM.png" alt="img"></p> <h4 id="如何解决"><a href="#如何解决" class="header-anchor">#</a> 如何解决</h4> <ul><li>强制读主，采用主备架构方案，读写都走主库。用缓存来扩展数据库读性能 。</li> <li>选择读主，写操作时根据库+表+业务特征生成一个key放到Cache里并设置超时时间（大于等于主从数据同步时间）。读请求时，同样的方式生成key先去查Cache，再判断是否命中。若命中，则读主库，否则读从库。</li> <li>半同步复制，等主从同步完成，写请求才返回。代价是写请求时延增长，吞吐量降低。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/my-blog/zh/backend/devops/nginx.html" class="prev">
        nginx
      </a></span> <span class="next"><a href="/my-blog/zh/backend/db/redis.html">
        redis
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/my-blog/assets/js/app.68e31997.js" defer></script><script src="/my-blog/assets/js/2.c20646db.js" defer></script><script src="/my-blog/assets/js/60.02994d47.js" defer></script>
  </body>
</html>
