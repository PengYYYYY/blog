<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浏览器从输入url到页面加载的过程 | Super-YUE Blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="日常学习和技术积累">
    <link rel="preload" href="/my-blog/assets/css/0.styles.a70fa01a.css" as="style"><link rel="preload" href="/my-blog/assets/js/app.4e26fb24.js" as="script"><link rel="preload" href="/my-blog/assets/js/2.c20646db.js" as="script"><link rel="preload" href="/my-blog/assets/js/78.c8fe93a2.js" as="script"><link rel="prefetch" href="/my-blog/assets/js/10.52811631.js"><link rel="prefetch" href="/my-blog/assets/js/100.2ee9d887.js"><link rel="prefetch" href="/my-blog/assets/js/101.b81f632e.js"><link rel="prefetch" href="/my-blog/assets/js/102.4689858a.js"><link rel="prefetch" href="/my-blog/assets/js/103.624feb54.js"><link rel="prefetch" href="/my-blog/assets/js/104.93ef5913.js"><link rel="prefetch" href="/my-blog/assets/js/105.5f5337fd.js"><link rel="prefetch" href="/my-blog/assets/js/106.f0c4837f.js"><link rel="prefetch" href="/my-blog/assets/js/107.317183cc.js"><link rel="prefetch" href="/my-blog/assets/js/108.0ae0fc55.js"><link rel="prefetch" href="/my-blog/assets/js/109.10330231.js"><link rel="prefetch" href="/my-blog/assets/js/11.e751ad22.js"><link rel="prefetch" href="/my-blog/assets/js/110.042a690a.js"><link rel="prefetch" href="/my-blog/assets/js/111.5a1cb82e.js"><link rel="prefetch" href="/my-blog/assets/js/112.765219cd.js"><link rel="prefetch" href="/my-blog/assets/js/113.47e93949.js"><link rel="prefetch" href="/my-blog/assets/js/114.885a622b.js"><link rel="prefetch" href="/my-blog/assets/js/115.9e36f52a.js"><link rel="prefetch" href="/my-blog/assets/js/116.db490d84.js"><link rel="prefetch" href="/my-blog/assets/js/117.cf13ea58.js"><link rel="prefetch" href="/my-blog/assets/js/118.42e1a759.js"><link rel="prefetch" href="/my-blog/assets/js/119.ccfe4743.js"><link rel="prefetch" href="/my-blog/assets/js/12.0400ff5a.js"><link rel="prefetch" href="/my-blog/assets/js/120.e758d532.js"><link rel="prefetch" href="/my-blog/assets/js/121.a8bf7bf4.js"><link rel="prefetch" href="/my-blog/assets/js/122.d4ec5894.js"><link rel="prefetch" href="/my-blog/assets/js/123.05ef1113.js"><link rel="prefetch" href="/my-blog/assets/js/124.03b50a5d.js"><link rel="prefetch" href="/my-blog/assets/js/125.942f67e7.js"><link rel="prefetch" href="/my-blog/assets/js/126.db1a2a2a.js"><link rel="prefetch" href="/my-blog/assets/js/127.3f7dad39.js"><link rel="prefetch" href="/my-blog/assets/js/13.2a931ddf.js"><link rel="prefetch" href="/my-blog/assets/js/14.e8f09f17.js"><link rel="prefetch" href="/my-blog/assets/js/15.8d96ba11.js"><link rel="prefetch" href="/my-blog/assets/js/16.9fa47495.js"><link rel="prefetch" href="/my-blog/assets/js/17.a14d223c.js"><link rel="prefetch" href="/my-blog/assets/js/18.dc9ab091.js"><link rel="prefetch" href="/my-blog/assets/js/19.e4fd3365.js"><link rel="prefetch" href="/my-blog/assets/js/20.2705c997.js"><link rel="prefetch" href="/my-blog/assets/js/21.b7ac9ffe.js"><link rel="prefetch" href="/my-blog/assets/js/22.7e9e70d4.js"><link rel="prefetch" href="/my-blog/assets/js/23.0904080b.js"><link rel="prefetch" href="/my-blog/assets/js/24.34fcef1c.js"><link rel="prefetch" href="/my-blog/assets/js/25.966d0014.js"><link rel="prefetch" href="/my-blog/assets/js/26.16966ceb.js"><link rel="prefetch" href="/my-blog/assets/js/27.b9f8f4f4.js"><link rel="prefetch" href="/my-blog/assets/js/28.ac9cf494.js"><link rel="prefetch" href="/my-blog/assets/js/29.b4f9beb3.js"><link rel="prefetch" href="/my-blog/assets/js/3.e4dfe1f6.js"><link rel="prefetch" href="/my-blog/assets/js/30.49ce2aa8.js"><link rel="prefetch" href="/my-blog/assets/js/31.6efaa5ab.js"><link rel="prefetch" href="/my-blog/assets/js/32.67da77e1.js"><link rel="prefetch" href="/my-blog/assets/js/33.3f8e135b.js"><link rel="prefetch" href="/my-blog/assets/js/34.352f7b56.js"><link rel="prefetch" href="/my-blog/assets/js/35.5e84ca31.js"><link rel="prefetch" href="/my-blog/assets/js/36.e2633d8e.js"><link rel="prefetch" href="/my-blog/assets/js/37.5242af04.js"><link rel="prefetch" href="/my-blog/assets/js/38.579c7022.js"><link rel="prefetch" href="/my-blog/assets/js/39.1d3de88e.js"><link rel="prefetch" href="/my-blog/assets/js/4.9bf11b2d.js"><link rel="prefetch" href="/my-blog/assets/js/40.27315727.js"><link rel="prefetch" href="/my-blog/assets/js/41.a863a218.js"><link rel="prefetch" href="/my-blog/assets/js/42.23a71bca.js"><link rel="prefetch" href="/my-blog/assets/js/43.ba36428d.js"><link rel="prefetch" href="/my-blog/assets/js/44.870cae82.js"><link rel="prefetch" href="/my-blog/assets/js/45.a048e7fd.js"><link rel="prefetch" href="/my-blog/assets/js/46.cce4f6ec.js"><link rel="prefetch" href="/my-blog/assets/js/47.0320825f.js"><link rel="prefetch" href="/my-blog/assets/js/48.9d703fbd.js"><link rel="prefetch" href="/my-blog/assets/js/49.842b0148.js"><link rel="prefetch" href="/my-blog/assets/js/5.83e5464d.js"><link rel="prefetch" href="/my-blog/assets/js/50.4df799bd.js"><link rel="prefetch" href="/my-blog/assets/js/51.4c905f54.js"><link rel="prefetch" href="/my-blog/assets/js/52.355ae22d.js"><link rel="prefetch" href="/my-blog/assets/js/53.4f7b5391.js"><link rel="prefetch" href="/my-blog/assets/js/54.de5b523f.js"><link rel="prefetch" href="/my-blog/assets/js/55.692a4d07.js"><link rel="prefetch" href="/my-blog/assets/js/56.3072e779.js"><link rel="prefetch" href="/my-blog/assets/js/57.f2ac0105.js"><link rel="prefetch" href="/my-blog/assets/js/58.aad16ed2.js"><link rel="prefetch" href="/my-blog/assets/js/59.43b7d663.js"><link rel="prefetch" href="/my-blog/assets/js/6.f393a029.js"><link rel="prefetch" href="/my-blog/assets/js/60.79fd1497.js"><link rel="prefetch" href="/my-blog/assets/js/61.0d4041bc.js"><link rel="prefetch" href="/my-blog/assets/js/62.90c9add0.js"><link rel="prefetch" href="/my-blog/assets/js/63.b0c55334.js"><link rel="prefetch" href="/my-blog/assets/js/64.1b89e862.js"><link rel="prefetch" href="/my-blog/assets/js/65.fea0d764.js"><link rel="prefetch" href="/my-blog/assets/js/66.29c06903.js"><link rel="prefetch" href="/my-blog/assets/js/67.39cc6391.js"><link rel="prefetch" href="/my-blog/assets/js/68.85e74a18.js"><link rel="prefetch" href="/my-blog/assets/js/69.e0f704e1.js"><link rel="prefetch" href="/my-blog/assets/js/7.6ec1cc62.js"><link rel="prefetch" href="/my-blog/assets/js/70.8c3860a9.js"><link rel="prefetch" href="/my-blog/assets/js/71.bbe53de6.js"><link rel="prefetch" href="/my-blog/assets/js/72.474774b3.js"><link rel="prefetch" href="/my-blog/assets/js/73.ceecd6a0.js"><link rel="prefetch" href="/my-blog/assets/js/74.24c1d9fc.js"><link rel="prefetch" href="/my-blog/assets/js/75.0a71331d.js"><link rel="prefetch" href="/my-blog/assets/js/76.a5401396.js"><link rel="prefetch" href="/my-blog/assets/js/77.2930b2df.js"><link rel="prefetch" href="/my-blog/assets/js/79.ef82912f.js"><link rel="prefetch" href="/my-blog/assets/js/8.054b3948.js"><link rel="prefetch" href="/my-blog/assets/js/80.165b35b1.js"><link rel="prefetch" href="/my-blog/assets/js/81.c6f125af.js"><link rel="prefetch" href="/my-blog/assets/js/82.8b581135.js"><link rel="prefetch" href="/my-blog/assets/js/83.8619ebd4.js"><link rel="prefetch" href="/my-blog/assets/js/84.ffb4479f.js"><link rel="prefetch" href="/my-blog/assets/js/85.02076bc7.js"><link rel="prefetch" href="/my-blog/assets/js/86.a13c50ce.js"><link rel="prefetch" href="/my-blog/assets/js/87.b77b44d6.js"><link rel="prefetch" href="/my-blog/assets/js/88.3c016ebc.js"><link rel="prefetch" href="/my-blog/assets/js/89.5208e6c9.js"><link rel="prefetch" href="/my-blog/assets/js/9.4cd1edf4.js"><link rel="prefetch" href="/my-blog/assets/js/90.e2d1b374.js"><link rel="prefetch" href="/my-blog/assets/js/91.bda742de.js"><link rel="prefetch" href="/my-blog/assets/js/92.fe78412c.js"><link rel="prefetch" href="/my-blog/assets/js/93.7fbe44c5.js"><link rel="prefetch" href="/my-blog/assets/js/94.c460acf1.js"><link rel="prefetch" href="/my-blog/assets/js/95.c10f8475.js"><link rel="prefetch" href="/my-blog/assets/js/96.6053845f.js"><link rel="prefetch" href="/my-blog/assets/js/97.95782ac3.js"><link rel="prefetch" href="/my-blog/assets/js/98.ab8bcce1.js"><link rel="prefetch" href="/my-blog/assets/js/99.72dd3a83.js">
    <link rel="stylesheet" href="/my-blog/assets/css/0.styles.a70fa01a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-blog/" class="home-link router-link-active"><!----> <span class="site-name">Super-YUE Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-blog/zh/fontend/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/my-blog/zh/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/my-blog/zh/backend/" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/my-blog/zh/articles/" class="nav-link">
  文章
</a></div><div class="nav-item"><a href="/my-blog/zh/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="https://github.com/super-YUE" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/my-blog/zh/fontend/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/my-blog/zh/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/my-blog/zh/backend/" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/my-blog/zh/articles/" class="nav-link">
  文章
</a></div><div class="nav-item"><a href="/my-blog/zh/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="https://github.com/super-YUE" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>浏览器</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-blog/zh/fontend/browser/base.html" class="sidebar-link">浏览器原理</a></li><li><a href="/my-blog/zh/fontend/browser/process.html" aria-current="page" class="active sidebar-link">浏览器从输入url到页面加载的过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#准备动作" class="sidebar-link">准备动作</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#开始加载" class="sidebar-link">开始加载</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#url-请求过程" class="sidebar-link">URL 请求过程</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#重定向" class="sidebar-link">重定向</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#响应数据类型处理" class="sidebar-link">响应数据类型处理</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#准备渲染进程" class="sidebar-link">准备渲染进程</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#提交文档" class="sidebar-link">提交文档</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#渲染阶段" class="sidebar-link">渲染阶段</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#构建-dom-树" class="sidebar-link">构建 DOM 树</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#样式计算" class="sidebar-link">样式计算</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#布局阶段" class="sidebar-link">布局阶段</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#分层" class="sidebar-link">分层</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#图层绘制" class="sidebar-link">图层绘制</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#完整的渲染流程" class="sidebar-link">完整的渲染流程</a></li><li class="sidebar-sub-header"><a href="/my-blog/zh/fontend/browser/process.html#重排，重绘，合成" class="sidebar-link">重排，重绘，合成</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/my-blog/zh/fontend/mp.html" class="sidebar-link">小程序</a></li><li><a href="/my-blog/zh/fontend/css.html" class="sidebar-link">CSS</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="浏览器从输入url到页面加载的过程"><a href="#浏览器从输入url到页面加载的过程" class="header-anchor">#</a> 浏览器从输入url到页面加载的过程</h1> <h2 id="准备动作"><a href="#准备动作" class="header-anchor">#</a> 准备动作</h2> <p>输入后，先做url匹配，从书签，历史记录等地方，找到已经输入的字符串可能匹配的URL，然后显示出来。让你做选择。</p> <h2 id="开始加载"><a href="#开始加载" class="header-anchor">#</a> 开始加载</h2> <p>当浏览器刚开始加载一个地址之后，标签页上的图标便进入了加载状态。但此时图中页面显示的依然是之前打开的页面内容。</p> <h2 id="url-请求过程"><a href="#url-请求过程" class="header-anchor">#</a> URL 请求过程</h2> <p>进入了页面资源请求过程。这时，浏览器进程会通过进程间通信(IPC)把 URL 请求发送至网络进程，网络进程接收到 URL 请求后，会在这里发起真正的 URL 请求流程。</p> <ul><li><p>网络进程会查找本地缓存是否缓存了该资源。如果有缓存资源，那么直接返回资源给 浏览器进程;如果在缓存中没有查找到资源，那么直接进入网络请求流程。这请求前的第一 步是要进行 DNS 解析，以获取请求域名的服务器 IP 地址。如果请求协议是 HTTPS，那么 还需要建立 TLS 连接。</p></li> <li><p>利用 IP 地址和服务器建立 TCP 连接。连接建立之后，浏览器端会构建请求行、 请求头等信息，并把和该域名相关的 Cookie 等数据附加到请求头中，然后向服务器发送构 建的请求信息。</p></li> <li><p>服务器接收到请求信息后，会根据请求信息生成响应数据(包括响应行、响应头和响应体等信息)，发给网络进程。等网络进程接收了响应行和响应头之后，就开始解析响应头的内容了。</p></li></ul> <h2 id="重定向"><a href="#重定向" class="header-anchor">#</a> 重定向</h2> <p>在接收到服务器返回的响应头后，网络进程开始解析响应头，如果发现返回的状态码是 301 或者 302，那么说明服务器需要浏览器重定向到其他 URL。这时网络进程会从响应头 的 Location 字段里面读取重定向的地址，然后再发起新的 HTTP 或者 HTTPS 请求，一切又重头开始了。</p> <h2 id="响应数据类型处理"><a href="#响应数据类型处理" class="header-anchor">#</a> 响应数据类型处理</h2> <ul><li><p>Content-Type： 它告诉浏览 器服务器返回的响应体数据是什么类型，然后浏览器会根据 Content-Type 的值来决定如 何显示响应体的内容。</p></li> <li><p>响应头中的 Content-type 字段的值是 text/html，这就是告诉浏览器， 服务器返回的数据是HTML 格式。</p></li> <li><p>Content-Type 的值是 application/octet-stream，显示数据是字节流类型的，通常情况下，浏览器会按照下载类型来处理该请求。</p></li></ul> <h2 id="准备渲染进程"><a href="#准备渲染进程" class="header-anchor">#</a> 准备渲染进程</h2> <p>Chrome 会为每个页面分配一个渲染进程，也就是说，每打开一个新页面就 会配套创建一个新的渲染进程。</p> <p>通常情况下，打开新的页面都会使用单独的渲染进程;
如果从 A 页面打开 B 页面，且 A 和 B 都属于同一站点的话，那么 B 页面复用 A 页面的 渲染进程;如果是其他情况，浏览器进程则会为 B 创建一个新的渲染进程。</p> <p>同一站点：同一站点”定义为根域名(xxxx.org)加上协议(例如，https:// 或者 http://)，还包含了该根域名下的所有子域名和不同的端口</p> <h2 id="提交文档"><a href="#提交文档" class="header-anchor">#</a> 提交文档</h2> <p>“提交文档”的消息是由浏览器进程发出的，渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”。</p> <p>等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程。</p> <p>浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，包括了安全状态、地
址栏的 URL、前进后退的历史状态，并更新 Web 页面。</p> <h2 id="渲染阶段"><a href="#渲染阶段" class="header-anchor">#</a> 渲染阶段</h2> <p>渲染机制过于复杂，所以渲染模块在执行过程中会被划分为很多子阶段，输入的 HTML 经过这些子阶段，最后输出像素。我们把这样的一个处理流程叫做渲染流水线。</p> <p>按照渲染的时间顺序，流水线可分为如下几个子阶段: 构建 DOM 树、样式计算、布局阶 段、分层、绘制、分块、光栅化和合成。</p> <h2 id="构建-dom-树"><a href="#构建-dom-树" class="header-anchor">#</a> 构建 DOM 树</h2> <p>浏览器无法直接理解和使用 HTML，所以需要将 HTML 转换为浏览器能够理解的结构——DOM树。</p> <p>解析是将一个元素通过一定的方式转换成另一种形式。 比如 html 的解析。首先要明确，html 下载到浏览器的表现形式就是 包含字符串的文件。浏览器将 html 文件里面的字符串读取到内存中，按照 html 规则，对字符串进行取词编译，将字符串转化成另一种易于表达的数据结构。我们看下一段代码：</p> <h2 id="样式计算"><a href="#样式计算" class="header-anchor">#</a> 样式计算</h2> <h3 id="把-css-转换为浏览器能够理解的结构"><a href="#把-css-转换为浏览器能够理解的结构" class="header-anchor">#</a> 把 CSS 转换为浏览器能够理解的结构</h3> <p>CSS 样式来源主要有三种:</p> <ul><li>通过 link 引用的外部 CSS 文件</li> <li><code>&lt;style&gt;</code>标记内的 CSS</li> <li>元素的 style 属性内嵌的 CSS</li></ul> <p>当渲染引擎接 收到 CSS 文本时，会执行一个转换操作，将 CSS 文本转换为浏览器可以理解的结构—— styleSheets。</p> <h3 id="转换样式表中的属性值，使其标准化"><a href="#转换样式表中的属性值，使其标准化" class="header-anchor">#</a> 转换样式表中的属性值，使其标准化</h3> <p>现在我们已经把现有的 CSS 文本转化为浏览器可以理解的结构了，那么接下来就要对其进行属性值的标准化操作。</p> <p>CSS 文本中有很多属性值，如 2em、blue、bold，这些类型数值不容易 被渲染引擎理解。所以需要将所有值转换为渲染引擎容易理解的、标准化的计算值。</p> <h3 id="计算出-dom-树中每个节点的具体样式"><a href="#计算出-dom-树中每个节点的具体样式" class="header-anchor">#</a> 计算出 DOM 树中每个节点的具体样式</h3> <p>CSS 继承就是每个 DOM 节点都包含有父节点的样式。所有子节点都继承了父节点样式。</p> <p>这里需要特别提下 UserAgent 样式， 它是浏览器提供的一组默认样式，如果你不提供任何样式，默认使用的就是 UserAgent 样式。</p> <h2 id="布局阶段"><a href="#布局阶段" class="header-anchor">#</a> 布局阶段</h2> <h3 id="创建布局树"><a href="#创建布局树" class="header-anchor">#</a> 创建布局树</h3> <p>为了构建布局树，浏览器大体上完成了下面这些工作:</p> <ul><li>遍历 DOM 树中的所有可见节点，并把这些节点加到布局中;</li> <li>而不可见的节点会被布局树忽略掉，如 head 标签下面的全部内容，再比如 body.p.span 这个元素，因为它的属性包含 dispaly:none，所以这个元素也没有被包进 布局树。</li></ul> <h3 id="布局计算"><a href="#布局计算" class="header-anchor">#</a> 布局计算</h3> <p>在执行布局操作的时候，会把布局运算的结果重新写回布局树中，所以布局树既是输入内容 也是输出内容，这是布局阶段一个不合理的地方，因为在布局阶段并没有清晰地将输入内容 和输出内容区分开来。</p> <h2 id="分层"><a href="#分层" class="header-anchor">#</a> 分层</h2> <p>如一些复杂的 3D 变换、页面滚动，或者使用 z-indexing 做 z 轴排序等，为了更加方便地实现这些效果，渲染引擎还需要为特定的节点生成专用的 图层，并生成一棵对应的图层树(LayerTree)。</p> <p>浏览器的页面实际上被分成了很多图层，这些图层叠加后合成了最终的页面。</p> <p>并不是布局树的每个节点都包含一个图层，如果一个节点没有对应的层，那么 这个节点就从属于父节点的图层。</p> <p>满足下面两点中任意一点的元素就可以被提升为单独的一个图层。</p> <ul><li>第一点，拥有层叠上下文属性的元素会被提升为单独的一层。</li> <li>第二点，需要剪裁(clip)的地方也会被创建为图层。</li></ul> <h2 id="图层绘制"><a href="#图层绘制" class="header-anchor">#</a> 图层绘制</h2> <p>在完成图层树的构建之后，渲染引擎会对图层树中的每个图层进行绘制，那么接下来我们看看渲染引擎是怎么实现图层绘制的?</p> <p>渲染引擎实现图层的绘制，会把一个图层的绘制拆分成很多小的绘制指令，然后再把这些指令按照顺序组成一个待绘制列表。</p> <p>当图层的绘制列表准备好之后，主线程会把该绘制列表提交(commit)给合成线程。</p> <h2 id="完整的渲染流程"><a href="#完整的渲染流程" class="header-anchor">#</a> 完整的渲染流程</h2> <ol><li>渲染进程将 HTML 内容转换为能够读懂的DOM 树结构。</li> <li>渲染引擎将 CSS 样式表转化为浏览器可以理解的styleSheets，计算出 DOM 节点的样式。</li> <li>创建布局树，并计算元素的布局信息。</li> <li>对布局树进行分层，并生成分层树。</li> <li>为每个图层生成绘制列表，并将其提交到合成线程。</li> <li>合成线程将图层分成图块，并在光栅化线程池中将图块转换成位图。</li> <li>合成线程发送绘制图块命令DrawQuad给浏览器进程。</li> <li>浏览器进程根据 DrawQuad 消息生成页面，并显示到显示器上。</li></ol> <h2 id="重排，重绘，合成"><a href="#重排，重绘，合成" class="header-anchor">#</a> 重排，重绘，合成</h2> <h3 id="更新了元素的几何属性-重排"><a href="#更新了元素的几何属性-重排" class="header-anchor">#</a> 更新了元素的几何属性(重排)</h3> <p>如果你通过 JavaScript 或者 CSS 修改元素的几何位置属性，例如改变元 素的宽度、高度等，那么浏览器会触发重新布局，解析之后的一系列子阶段，这个过程就叫 重排。无疑，重排需要更新完整的渲染流水线，所以开销也是最大的。</p> <h3 id="更新元素的绘制属性-重绘"><a href="#更新元素的绘制属性-重绘" class="header-anchor">#</a> 更新元素的绘制属性(重绘)</h3> <p>接下来，我们再来看看重绘，比如通过 JavaScript 更改某些元素的背景颜色，渲染流水线会怎样调整呢?你可以参考下图:</p> <p>从图中可以看出，如果修改了元素的背景颜色，那么布局阶段将不会被执行，因为并没有引起几何位置的变换，所以就直接进入了绘制阶段，然后执行之后的一系列子阶段，这个过程就叫重绘。相较于重排操作，重绘省去了布局和分层阶段，所以执行效率会比重排操作要高 一些。</p> <h3 id="直接合成阶段"><a href="#直接合成阶段" class="header-anchor">#</a> 直接合成阶段</h3> <p>那如果你更改一个既不要布局也不要绘制的属性，会发生什么变化呢?渲染引擎将跳过布局和绘制，只执行后续的合成操作，我们把这个过程叫做合成。</p> <p>我们使用了 CSS 的 transform 来实现动画效果，这可以避开重排和重绘阶段， 直接在非主线程上执行合成动画操作。这样的效率是最高的，因为是在非主线程上合成，并 没有占用主线程的资源，另外也避开了布局和绘制两个子阶段，所以相对于重绘和重排，合成能大大提升绘制效率。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/my-blog/zh/fontend/browser/base.html" class="prev">
        浏览器原理
      </a></span> <span class="next"><a href="/my-blog/zh/fontend/html/html.html">
        HTML
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/my-blog/assets/js/app.4e26fb24.js" defer></script><script src="/my-blog/assets/js/2.c20646db.js" defer></script><script src="/my-blog/assets/js/78.c8fe93a2.js" defer></script>
  </body>
</html>
